<wdkModel>
    <recordClassSet name="DwellingRecordClasses">

      <recordClass name="DwellingRecordClass" urlName="household" displayName="Household"> 


            <!-- primary key definition -->
            <primaryKey aliasQueryRef="householdattributes.DwellingAlias">
              <columnRef>source_id</columnRef>
              <columnRef>project_id</columnRef>
            </primaryKey>

            <idAttribute name="primary_key"
                                 displayName="Household Id">
                <text>
                    <![CDATA[
                      $$source_id$$
                    ]]>
                </text>                
            </idAttribute>

<!--
            <attributesList summary="subcounty_in_uganda,num_anopheles_collections,average_number_of_female_anop"
                            sorting="subcounty_in_uganda DESC"         
            />
-->

<!-- JB: missing "num_anopheles_collections"... couldn't work out what that is;  avg mos counts are light trap attributes i think?-->
<!--            <attributesList summary="EUPATH_0000054"
                            sorting="EUPATH_0000054 DESC"         
            />
-->




      <!-- =============================================================== -->
      <!--  Summary & record views -->
      <!-- =============================================================== -->

<!-- TODO
      <summaryView name="isolate-view" display="Dwellings Geographical Location"
            jsp="/wdkCustomization/jsp/results/dwelling-geographical-view.jsp"
          handlerClass="org.clinepi.model.view.GeoDwellingViewHandler"/>
-->

      <!-- =============================================================== -->
      <!--   Reporters -->  
      <!-- =============================================================== -->


      <reporter name="attributesTabular" displayName="%%attributesReporterDisplayName%%" scopes="results"
                implementation="org.gusdb.wdk.model.report.AttributesTabularReporter">
        <property name="page_size">500</property>
      </reporter>

      <reporter name="tableTabular" displayName="%%tableReporterDisplayName%%" scopes="results"
                implementation="org.gusdb.wdk.model.report.TableTabularReporter">
             <property name="page_size">1000000</property>           <!-- huge page size to force no paging  -->
      </reporter>

      <reporter name="fullRecord" displayName="%%fullReporterDisplayName%%" scopes="record"
                implementation="org.gusdb.wdk.model.report.FullRecordReporter" />

      <!-- =================================================================== -->
      <!--  Text Attributes  ++++++++-->
      <!-- =================================================================== -->

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- overview -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
         <textAttribute name="record_overview" displayName="Overview">

           <text>
              <![CDATA[
                  Household ID: $$primary_key$$<br>
              ]]>
           </text>
         </textAttribute>


         <attributeQueryRef ref="householdattributes.householdattributes" attributeMetaQueryRef="householdattributes.householdattributesMeta"/>


        <table name="Characteristics"
               displayName="Household Characteristics"
               queryRef="DwellingTables.Characteristics">
            <columnAttribute name="source_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="project_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="term" displayName="Value"/>
            <columnAttribute name="parentTerm" displayName="Category"/>
        </table>





         <table name="HouseholdMembers"
                 displayName="Household Members"
                 queryRef="DwellingTables.HouseholdMembers">
            <columnAttribute name="source_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="project_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="participant" inReportMaker="true" internal="true"/>

            <linkAttribute name="db_link" displayName="Participant ID" inReportMaker="false">
                 <displayText>
                    <![CDATA[
                    $$participant$$
                    ]]>
                 </displayText>
                 <url>@WEBAPP_BASE_URL@/record/participant/$$participant$$/@PROJECT_ID@</url>
            </linkAttribute>
            <columnAttribute name="EUPATH_0000033" displayName="G6PD Genotype"/>
            <columnAttribute name="EUPATH_0000034" displayName="HbS Genotype"/>
            <columnAttribute name="EUPATH_0000035" displayName="A-Thalassemia Genotype"/>
          </table>


	  <table name="LightTraps"
                 displayName="Mosquitoe Light Trap Collections"
                 queryRef="DwellingTables.LightTraps">
            <columnAttribute name="source_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="project_id"  inReportMaker="false" internal="true"/>
            <!-- TODO:  These should be dynamic -->
            <columnAttribute name="OBI_0001619" displayName="Specimen Collection Date"/>
            <columnAttribute name="EUPATH_0000218" displayName="Total Anopheles positive"/>
            <columnAttribute name="EUPATH_0000217" displayName="Total Anopheles tested"/>
            <columnAttribute name="EUPATH_0000200" displayName="Anopheles Other"/>
            <columnAttribute name="EUPATH_0000194" displayName="Discparity"/>
            <columnAttribute name="EUPATH_0000192" displayName="Fed A. funestus"/>
            <columnAttribute name="EUPATH_0000193" displayName="Fed A. gambiae"/>
            <columnAttribute name="EUPATH_0000197" displayName="Gravid A. funestus"/>
            <columnAttribute name="EUPATH_0000198" displayName="Gravid A. gambiae"/>
            <columnAttribute name="EUPATH_0000195" displayName="Nulliparous"/>
            <columnAttribute name="EUPATH_0000196" displayName="Parous"/>
            <columnAttribute name="EUPATH_0000202" displayName="Unable to assess A. funestus"/>
            <columnAttribute name="EUPATH_0000203" displayName="Unable to assess A. gambiae"/>
            <columnAttribute name="EUPATH_0000204" displayName="Unfed A. funestus"/>
            <columnAttribute name="EUPATH_0000205" displayName="Unfed A. gambiae"/>

    </table>


    </recordClass>
    </recordClassSet>



      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Attribute queries -->  
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <querySet name="householdattributes" queryType="attribute" doNotTest="true"  
              isCacheable='false'>
              

      <testRowCountSql>
select count(*) from apidbtuning.householdattributes
       </testRowCountSql>

       <sqlQuery name="DwellingAlias" doNotTest="true">
         <column name="source_id"/>
         <column name="project_id"/>
         <column name="old_source_id"/>
         <column name="old_project_id"/>
         <sql>
             SELECT name as source_id, '@PROJECT_ID@' AS project_id, name as old_source_id, '@PROJECT_ID@' AS old_project_id FROM ApidbTuning.householdattributes
         </sql>
       </sqlQuery>



       <sqlQuery name="householdattributes" attributeMetaQueryRef="householdattributes.householdattributesMeta">
         <column name="source_id"/>
         <column name="project_id"/>

          <sql>
            <![CDATA[
                     select d.name as source_id, '@PROJECT_ID@' as project_id, d.* from apidbtuning.householdattributes d
            ]]>
          </sql>  
         </sqlQuery>

       <sqlQuery name="householdattributesMeta" isCacheable="false">
          <column name="name" />
          <column name="display_name" />
          <column name="help" />
          <column name="plugin_name" />
          <column name="plugin_display" />
          <column name="plugin_description" />
          <column name="plugin_implementation" />
          <column name="plugin_view" />
          <column name="plugin_properties" />
         <sql>
            <![CDATA[
                     select meta.display_name, meta.name, meta.help, 
                            decode(meta.type, 'string', 'wordCloud', 'number', 'histogram', null) as plugin_name,
                            decode(meta.type, 'string', 'Word Cloud', 'number', 'Histogram', null) as plugin_display,
                            decode(meta.type, 'string', 'Display the terms in the attribute as word clouds', 'number', 'Display a histogram of the values', null) as plugin_description,
                            decode(meta.type, 'string', 'org.gusdb.wdk.model.record.attribute.plugin.WordCloudAttributePlugin', 'number', 'org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin', null) as plugin_implementation,
                            decode(meta.type, 'string', '/wdk/jsp/results/wordCloud.jsp', 'number', '/wdk/jsp/results/histogram.jsp', null) as plugin_view,
                            decode(meta.type, 'string', '[{"name":"min-word-length","value":"1"},{"name":"common-words","value":""},{"name":"exclude-numbers","value":"false"}]', null) as plugin_properties
                     from (select distinct ot.name as display_name, ot.source_id as name, ot.DEFINITION as help, mt.type
                           from APIDBTUNING.PANCHARACTERISTICMETADATA m, sres.ontologyterm ot, apidbtuning.metadatatype mt
                           where m.protocol_app_node_type = 'Household'
                           and ot.ontology_term_id = m.TERM_ID
                           and mt.term_id = m.term_id
                           union
                           select distinct ot.name as display_name, ot.source_id as name, ot.DEFINITION as help, mt.type
                           from APIDBTUNING.PANPROTOCOLMETADATA m, sres.ontologyterm ot, apidbtuning.metadatatype mt
                           where m.protocol_app_node_type = 'Household'
                           and ot.ontology_term_id = m.TERM_ID
                           and mt.term_id = m.term_id
                           union
                           select 'Name' as displayName, 'name' as name, '' as help, '' as type from dual
                           ) meta
                     
            ]]>
         </sql>

         </sqlQuery>
      </querySet>   

    <querySet name="DwellingTables" queryType="table" 
              isCacheable='false'>


      <sqlQuery name="Characteristics"  isCacheable='false'>
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="term"/>
            <column name="parentTerm"/>            
            <sql>
            <![CDATA[
SELECT pan_name  AS source_id,
  '@PROJECT_ID@' AS project_id,
  term           AS parentTerm,
  string_value   AS term
FROM ApidbTuning.MetaDataWithoutNulls 
WHERE dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
AND category       = 'Household'
/** TODO:  add this back in when we can make this a tree on the record page
UNION
SELECT a.name                AS source_id,
  '@PROJECT_ID@'              AS project_id,
  o.PARENT_ONTOLOGY_TERM_NAME AS parentTerm,
  ontology_term_name          AS term
FROM apidbtuning.metadataontology o,
  apidbtuning.householdattributes a
WHERE o.dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
**/
            ]]>
            </sql>
        </sqlQuery>


      <sqlQuery name="HouseholdMembers"  isCacheable='false'>
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="participant"/>
            <column name="EUPATH_0000033"/>
            <column name="EUPATH_0000034"/>
            <column name="EUPATH_0000035"/>
            <sql>
            <![CDATA[
SELECT pa.EUPATH_0000094 AS source_id,
  '@PROJECT_ID@'         AS project_id,
  pa.name as participant,
  pa.EUPATH_0000033,
  pa.EUPATH_0000035,
  pa.EUPATH_0000034
FROM apidbtuning.PARTICIPANTATTRIBUTES pa
order by source_id
            ]]>
            </sql>
        </sqlQuery>


       <sqlQuery name="LightTraps"  isCacheable='false'>
            <column name="source_id"/>
            <column name="project_id"/>

            <!-- TODO: these should be made dynamic -->
            <column name="OBI_0001619"/>           
            <column name="EUPATH_0000200"/>           
            <column name="EUPATH_0000194"/>           
            <column name="EUPATH_0000192"/>           
            <column name="EUPATH_0000193"/>           
            <column name="EUPATH_0000197"/>           
            <column name="EUPATH_0000198"/>           
            <column name="EUPATH_0000195"/>           
            <column name="EUPATH_0000196"/>           
            <column name="EUPATH_0000218"/>           
            <column name="EUPATH_0000217"/>           
            <column name="EUPATH_0000202"/>           
            <column name="EUPATH_0000203"/>           
            <column name="EUPATH_0000204"/>           
            <column name="EUPATH_0000205"/>           

            <sqlParamValue name="lightTrapSourceIds"><![CDATA[EUPATH_0000200,EUPATH_0000198,EUPATH_0000192,EUPATH_0000196,EUPATH_0000203,EUPATH_0000193,EUPATH_0000197,EUPATH_0000218,EUPATH_0000202,EUPATH_0000204,EUPATH_0000195,EUPATH_0000205,OBI_0001619,EUPATH_0000217,EUPATH_0000194]]></sqlParamValue>
            <sqlParamValue name="orderBySourceIds"><![CDATA[OBI_0001619]]></sqlParamValue>

            <sql>
            <![CDATA[
            select EUPATH_0000094 as source_id, '@PROJECT_ID@' as project_id, &&lightTrapSourceIds&& from apidbtuning.lighttrapattributes order by &&orderBySourceIds&&
            ]]>
            </sql>
        </sqlQuery>
      </querySet>

</wdkModel>

