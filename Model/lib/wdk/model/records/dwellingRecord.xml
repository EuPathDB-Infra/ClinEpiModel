<wdkModel>
    <recordClassSet name="DwellingRecordClasses">

      <recordClass name="DwellingRecordClass" urlName="dwelling" displayName="Dwelling"> 


            <!-- primary key definition -->
            <primaryKey aliasQueryRef="DwellingAttributes.DwellingAlias">
              <columnRef>source_id</columnRef>
              <columnRef>project_id</columnRef>
            </primaryKey>

            <idAttribute name="primary_key"
                                 displayName="Household Id">
                <text>
                    <![CDATA[
                      $$source_id$$
                    ]]>
                </text>                
            </idAttribute>

<!--
            <attributesList summary="subcounty_in_uganda,num_anopheles_collections,average_number_of_female_anop"
                            sorting="subcounty_in_uganda DESC"         
            />
-->

<!-- JB: missing "num_anopheles_collections"... couldn't work out what that is;  avg mos counts are light trap attributes i think?-->
            <attributesList summary="EUPATH_0000054"
                            sorting="EUPATH_0000054 DESC"         
            />




      <!-- =============================================================== -->
      <!--  Summary & record views -->
      <!-- =============================================================== -->

<!-- TODO
      <summaryView name="isolate-view" display="Dwellings Geographical Location"
            jsp="/wdkCustomization/jsp/results/dwelling-geographical-view.jsp"
          handlerClass="org.clinepi.model.view.GeoDwellingViewHandler"/>
-->

      <!-- =============================================================== -->
      <!--   Reporters -->  
      <!-- =============================================================== -->


<!-- TODO
          <reporter name="tabular" displayName="Summary - tab delimited" scopes=""
                    implementation="org.gusdb.wdk.model.report.AttributesTabularReporter"/>

          <reporter name="fullRecord" displayName="Text: choose from columns and/or tables"  scopes=""
                    implementation="org.gusdb.wdk.model.report.FullRecordReporter"/>

-->
      <!-- =================================================================== -->
      <!--  Text Attributes  ++++++++-->
      <!-- =================================================================== -->

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- overview -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
         <textAttribute name="overview" displayName="Overview"
                         inReportMaker="false" internal="true">
           <text>
              <![CDATA[
                  Subcounty: $$EUPATH_0000054$$<br>
              ]]>
           </text>
         </textAttribute>


         <attributeQueryRef ref="DwellingAttributes.DwellingAttributes" attributeMetaQueryRef="DwellingAttributes.DwellingAttributesMeta"/>

<!--
        <table name="Characteristics"
               displayName="Household Characteristics"
               queryRef="DwellingTables.Characteristics">
            <columnAttribute name="source_id"  inReportMaker="false" internal="true"/>
             <columnAttribute name="parent_category" displayName="Category"/>
            <columnAttribute name="category" displayName="Characteristic"/>
            <columnAttribute name="value" displayName="Value"/>
        </table>

        <table name="UncategorizedCharacteristics"
               displayName="Uncategorized Household Characteristics"
               queryRef="DwellingTables.UncategorizedCharacteristics">
            <columnAttribute name="source_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="category" displayName="Category"/>
            <columnAttribute name="value" displayName="Value"/>
        </table>

         <table name="ParticipantLinks"
                 displayName="Household Members"
                 queryRef="DwellingTables.HouseholdMembers" excludeProjects="TriTrypDB,TrichDB">
            <columnAttribute name="participant_id" internal="true"/>
            <columnAttribute name="source_id" internal="true"/>
            <columnAttribute name="link" internal="true"/>
            <linkAttribute name="db_link" displayName="Participant ID" inReportMaker="false">
                 <displayText>
                    <![CDATA[
                    $$participant_id$$
                    ]]>
                 </displayText>
                 <url>$$link$$</url>
            </linkAttribute>

<columnAttribute name="g6pd_genotype" displayName="G6pd Genotype">
              <plugin name="wordCloud" display="Word Cloud"
                      description="Display the terms in the attribute as word clouds"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.WordCloudAttributePlugin"
                      view="/wdk/jsp/results/wordCloud.jsp">
                      <property name="min-word-length">1</property>
                      <property name="common-words"></property>
                      <property name="exclude-numbers">false</property>
              </plugin>
</columnAttribute>
<columnAttribute name="hbs_genotype" displayName="Hbs Genotype">
              <plugin name="wordCloud" display="Word Cloud"
                      description="Display the terms in the attribute as word clouds"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.WordCloudAttributePlugin"
                      view="/wdk/jsp/results/wordCloud.jsp">
                      <property name="min-word-length">1</property>
                      <property name="common-words"></property>
                      <property name="exclude-numbers">false</property>
              </plugin>
</columnAttribute>
<columnAttribute name="a_thalassemia_genotype" displayName="A-thalassemia Genotype">
              <plugin name="wordCloud" display="Word Cloud"
                      description="Display the terms in the attribute as word clouds"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.WordCloudAttributePlugin"
                      view="/wdk/jsp/results/wordCloud.jsp">
                      <property name="min-word-length">1</property>
                      <property name="common-words"></property>
                      <property name="exclude-numbers">false</property>
              </plugin>
</columnAttribute>
<columnAttribute name="avg_parasite_density__asymp_m" displayName="Ave Parasite Density (asymptomatic Parasitemia)">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="avg_parasite_density__malaria" displayName="Ave Parasite Density (malaria Diagnosis)">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
          </table>


	  <table name="mosquitoCollections"
                 displayName="Mosquitoe Collections"
                 queryRef="DwellingTables.mosquitoeCollections_" excludeProjects="TriTrypDB,TrichDB">
         
<columnAttribute name="source_id" displayName="Household ID"  help="A unique ID for each months collection.">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="collection_date_" displayName="Collection Date"  help="Date of light trap collection"/>
 <columnAttribute name="barcode" displayName="Barcode"  help="Unique identifier of mosquitoes collections">
              <plugin name="wordCloud" display="Word Cloud"
                      description="Display the terms in the attribute as word clouds"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.WordCloudAttributePlugin"
                      view="/wdk/jsp/results/wordCloud.jsp">
                      <property name="min-word-length">1</property>
                      <property name="common-words"></property>
                      <property name="exclude-numbers">false</property>
              </plugin>
</columnAttribute>
<columnAttribute name="sum_female_As_in_a_collection" displayName="# Female Anopheles Collected"  help="Total # female Anopheles collected">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="sum_female_As_gambiae_in_a_co" displayName="# A. Gambiae"  help="Number of female Anopheles gambiae collected">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="fed_a_gambiae" displayName="Fed A. Gambiae"  help="Number of female Anopheles gambiae with a recent blood meal">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="unfed_a_gambiae" displayName="Unfed A. Gambiae"  help="Number of female Anopheles gambiae without a recent blood meal">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="gravid_a_gambiae" displayName="Gravid A. Gambiae"  help="Number of gravid or semi-gravid Anopheles gambiae">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="unable_to_assess_a_gambiae" displayName="Unable To Assess A. Gambiae"  help="Number of Anopheles gambiae that could not be assessed">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="sum_female_As_funestus_in_a_c" displayName="# A. Funestus"  help="Number of female Anopheles funestus collected">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="fed_a_funestus" displayName="Fed A. Funestus"  help="Number of female Anopheles funestus with a recent blood meal">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="unfed_a_funestus" displayName="Unfed A. Funestus"  help="Number of female Anopheles funestus without a recent blood meal">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="gravid_a_funestus" displayName="Gravid A. Funestus"  help="Number of gravid or semi-gravid Anopheles funestus">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="unable_to_assess_a_funestus" displayName="Unable To Assess A. Funestus"  help="Number of Anopheles funestus that could not be assessed">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="anopheles_other" displayName="Anopheles Other"  help="Number of other female Anopheles species">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="discparity" displayName="Discparity"  help="Number of female Anopheles dissected for parity in a collection">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="parous" displayName="Parous"  help="Female anopheles that have layed eggs before or are pregnant">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="nulliparous" displayName="Nulliparous"  help="Female anopheles?? that have never layed eggs">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="total_anopheles_positive" displayName="Total Anopheles Positive"  help="Total number of Anopheles with Plasmodium sporozoites">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
<columnAttribute name="total_anopheles_tested" displayName="Total Anopheles Tested"  help="Total number of Anopheles examined for sporozoites">
                            <plugin name="histogram" display="Histogram"
                      description="Display a histogram of the values"
                      implementation="org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin"
                      view="/wdk/jsp/results/histogram.jsp" />
</columnAttribute>
           
    </table>

-->
    </recordClass>
    </recordClassSet>



      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Attribute queries -->  
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <querySet name="DwellingAttributes" queryType="attribute" doNotTest="true"  
              isCacheable='false'
              excludeProjects="TrichDB">

      <testRowCountSql>
select count(*) from apidbtuning.DwellingAttributes
       </testRowCountSql>

       <sqlQuery name="DwellingAlias" doNotTest="true">
         <column name="source_id"/>
         <column name="project_id"/>
         <column name="old_source_id"/>
         <column name="old_project_id"/>
         <sql>
             SELECT name as source_id, '@PROJECT_ID@' AS project_id, name as old_source_id, '@PROJECT_ID@' AS old_project_id FROM ApidbTuning.DwellingAttributes
         </sql>
       </sqlQuery>



       <sqlQuery name="DwellingAttributes" attributeMetaQueryRef="DwellingAttributes.DwellingAttributesMeta">
         <column name="source_id"/>
         <column name="project_id"/>

          <sql excludeProjects="EuPathDB">
            <![CDATA[
                     select d.name as source_id, '@PROJECT_ID@' as project_id, d.* from apidbtuning.dwellingattributes d
            ]]>
          </sql>  
         </sqlQuery>

       <sqlQuery name="DwellingAttributesMeta" isCacheable="false">
          <column name="name" />
          <column name="display_name" />
          <column name="help" />
          <column name="plugin_name" />
          <column name="plugin_display" />
          <column name="plugin_description" />
          <column name="plugin_implementation" />
          <column name="plugin_view" />
          <column name="plugin_properties" />
         <sql>
            <![CDATA[
                     select meta.display_name, meta.name, meta.help, 
                            decode(meta.type, 'string', 'wordCloud', 'number', 'histogram', null) as plugin_name,
                            decode(meta.type, 'string', 'Word Cloud', 'number', 'Histogram', null) as plugin_display,
                            decode(meta.type, 'string', 'Display the terms in the attribute as word clouds', 'number', 'Display a histogram of the values', null) as plugin_description,
                            decode(meta.type, 'string', 'org.gusdb.wdk.model.record.attribute.plugin.WordCloudAttributePlugin', 'number', 'org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin', null) as plugin_implementation,
                            decode(meta.type, 'string', '/wdk/jsp/results/wordCloud.jsp', 'number', '/wdk/jsp/results/histogram.jsp', null) as plugin_view,
                            decode(meta.type, 'string', '[{"name":"min-word-length","value":"1"},{"name":"common-words","value":""},{"name":"exclude-numbers","value":"false"}]', null) as plugin_properties
                     from (select distinct ot.name as display_name, ot.source_id as name, ot.DEFINITION as help, mt.type
                           from APIDBTUNING.PANCHARACTERISTICMETADATA m, sres.ontologyterm ot, apidbtuning.metadatatype mt
                           where m.protocol_app_node_type = 'Dwelling type'
                           and ot.ontology_term_id = m.TERM_ID
                           and mt.term_id = m.term_id
                           union
                           select distinct ot.name as display_name, ot.source_id as name, ot.DEFINITION as help, mt.type
                           from APIDBTUNING.PANPROTOCOLMETADATA m, sres.ontologyterm ot, apidbtuning.metadatatype mt
                           where m.protocol_app_node_type = 'Dwelling type'
                           and ot.ontology_term_id = m.TERM_ID
                           and mt.term_id = m.term_id
                           union
                           select 'Name' as displayName, 'name' as name, '' as help, '' as type from dual
                           ) meta
                     
            ]]>
         </sql>

         </sqlQuery>
      </querySet>   

    <querySet name="DwellingTables" queryType="table" 
              isCacheable='false'
              excludeProjects="TrichDB">

      <sqlQuery name="Characteristics"  isCacheable='false'>
            <column name="source_id"/>
            <column name="parent_category"/>
            <column name="category"/>
            <column name="value"/>            
            <sql>
            <![CDATA[
              select distinct 
                 anc.source_id, 
                 anc.source_id as name,
                 anc.value,
                 pc.parent_category,
                nvl(os.ontology_synonym,anc.category) as category
            from ApidbTuning.AppNodeCharacteristics anc
                 ,ApidbTuning.MetaDataSpec mds
                 ,Sres.OntologySynonym os
                 ,( select listagg(display.spec_value,' : ') within group (order by tier desc) as parent_category,
                           root as ontology_term_id
                      from ( select distinct property as term, 
                                             ontology_term_id, 
                                             spec_value as parent_term,
                                             connect_by_root ontology_term_id as root,
                                             to_number(level) as  tier
                               from (select * from apidbtuning.metadataspec  where spec_property = 'parent' ) mds
                              start with property in ( select distinct property from ApidbTuning.metadataspec where spec_property = 'leaf' )
                            connect by prior spec_value = property
                            )mds, 
                            (select distinct property,
                                             ontology_term_id,
                                             spec_value 
                              from ApidbTuning.metadataspec 
                             where spec_property = 'display' )display
                    where tier != 1 
                      and mds.ontology_term_id = display.ontology_term_id
                    group by root) pc
                    
              where anc.type = 'Dwelling type'
             and anc.ontology_term_source_id = mds.property
             and anc.ontology_term_id = os.ontology_term_id (+)
             and pc.ontology_term_id(+) = anc.ontology_term_id
              order by source_id, parent_category, category
            ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="UncategorizedCharacteristics"  isCacheable='false'>
            <column name="source_id"/>
            <column name="category"/>
            <column name="value"/>
            <sql>
            <![CDATA[
          select distinct anc.source_id,
                 anc.value,
                 anc.category
            from ApidbTuning.AppNodeCharacteristics anc
                 ,ApidbTuning.MetaDataSpec mds
                 ,Sres.OntologySynonym os
           where anc.type = 'Dwelling type'
             and anc.category = mds.property
             and mds.spec_property = 'categorized'
             and mds.spec_value = 'false' 
           order by source_id, category 
            ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="HouseholdMembers"  isCacheable='false'>
            <column name="source_id"/>
            <column name="participant_id"/>
            <column name="link"/>
            <column name="a-thalassemia_genotype"/>
            <column name="AVG_PARASITE_DENSITY__ASYMP_M"/>
            <column name="AVG_PARASITE_DENSITY__MALARIA"/>
            <column name="sex"/>
            <column name="g6pd_genotype"/>
            <column name="hbs_genotype"/>
            <sql>
            <![CDATA[
            select parent_id as source_id,
                   source_id as participant_id,
                   A_THALASSEMIA_GENOTYPE,
                   AVG_PARASITE_DENSITY__ASYMP_M,
                   AVG_PARASITE_DENSITY__MALARIA,
                   sex,
                   G6PD_GENOTYPE,
                   hbs_genotype,
                   'showRecord.do?name=ParticipantRecordClasses.ParticipantRecordClass&project_id=@PROJECT_ID@&primary_key='||source_id as link
              from ApidbTuning.PersonAttributes
              order by source_id
            ]]>
            </sql>
        </sqlQuery>


       <sqlQuery name="mosquitoeCollections_"  isCacheable='false'>
            <column name="source_id"/>
            <column name="barcode"/>
            <column name="collection_date_"/>           
            <column name="TOTAL_ANOPHELES_TESTED"/>
            <column name="TOTAL_ANOPHELES_POSITIVE"/>
	    <column name="discparity"/>
	    <column name="parous"/>
	    <column name="nulliparous"/>
	    <column name="FED_A_FUNESTUS" />
	    <column name="unFED_A_FUNESTUS"/>
	    <column name="FED_A_GAMBIAE"/>
	    <column name="unFED_A_GAMBIAE"/>
	    <column name="GRAVID_A_FUNESTUS"/>
	    <column name="GRAVID_A_GAMBIAE"/>
	    <column name="ANOPHELES_OTHER"/>
	    <column name="UNABLE_TO_ASSESS_A_GAMBIAE"/>
	    <column name="UNABLE_TO_ASSESS_A_FUNESTUS"/>
	    <column name="SUM_FEMALE_AS_IN_A_COLLECTION"/>
	    <column name="SUM_FEMALE_AS_GAMBIAE_IN_A_CO"/>
	    <column name="SUM_FEMALE_AS_FUNESTUS_IN_A_C"/>
            <sql>
            <![CDATA[
            select parent_id as source_id,
                   source_id as barcode, 
                   to_char(collection_date,'MONTH DD,YYYY') as collection_date_,
                   TOTAL_ANOPHELES_POSITIVE, 
                   TOTAL_ANOPHELES_TESTED,
                   discparity,
                   FED_A_FUNESTUS, 
                   FED_A_GAMBIAE,
                   ANOPHELES_OTHER,
                   UNABLE_TO_ASSESS_A_FUNESTUS,
                   UNABLE_TO_ASSESS_A_GAMBIAE,
                   GRAVID_A_FUNESTUS,
                   GRAVID_A_GAMBIAE,
                   nulliparous,
                   parous,
                   UNFED_A_FUNESTUS,
                   UNFED_A_GAMBIAE,
                   SUM_FEMALE_AS_FUNESTUS_IN_A_C,
                   SUM_FEMALE_AS_GAMBIAE_IN_A_CO,
                   SUM_FEMALE_AS_IN_A_COLLECTION 
                  FROM ApidbTuning.LIGHTTRAPATTRIBUTES
                  ORDER BY to_date(collection_date) desc
            ]]>
            </sql>
        </sqlQuery>
      </querySet>

</wdkModel>

