<?xml version="1.0" encoding="utf-8"?>
<wdkModel>
    <recordClassSet name="ParticipantRecordClasses">

      <recordClass name="ParticipantRecordClass" urlName="participant" displayName="Participant"> 


            <!-- primary key definition -->
            <primaryKey aliasQueryRef="ParticipantAttributes.ParticipantAlias">
                <columnRef>source_id</columnRef>
                <columnRef>project_id</columnRef>
            </primaryKey>

            <idAttribute name="primary_key" displayName="Participant Id">
                <text>
                    <![CDATA[
                      $$source_id$$
                    ]]>
                </text>                
            </idAttribute>

           

      <!-- =============================================================== -->
      <!--  Summary & record views -->
      <!-- =============================================================== -->

<!-- TODO: why do we need this?
      <summaryView name="isolate-view" display="Participants Geographical Location"
            jsp="/wdkCustomization/jsp/results/participant-geographical-view.jsp"
          handlerClass="org.clinepi.model.view.GeoParticipantViewHandler"/>
-->

      <!-- =============================================================== -->
      <!--  Step Analysis Plugins -->
      <!-- =============================================================== -->

      <!--       <stepAnalysisRef name="transcript-length-dist" excludeProjects="EuPathDB"/> -->
            <stepAnalysisRef name="person-graph-analysis" excludeProjects="EuPathDB"/>
      
      <!-- =============================================================== -->
      <!--   Reporters -->  
      <!-- =============================================================== -->

<!-- TODO
          <reporter name="tabular" displayName="Summary - tab delimited" scopes=""
                    implementation="org.gusdb.wdk.model.report.AttributesTabularReporter"/>

          <reporter name="fullRecord" displayName="Text: choose from columns and/or tables"  scopes=""
                    implementation="org.gusdb.wdk.model.report.FullRecordReporter"/>
-->
    <!--
          <reporter name="fullRecordDump" displayName="Text: choose from columns and/or tables" 
                    inReportMaker="false"
                    implementation="org.gusdb.wdk.model.report.FullRecordReporter">
              <property name="table_cache">apidb.GeneGff</property>
              <property name="project_id_column">project_id</property>
              <property name="record_id_column">source_id</property>
          </reporter>
    -->

      <!-- =================================================================== -->
      <!--  Text Attributes  ++++++++-->
      <!-- =================================================================== -->
 <textAttribute name="record_overview" displayName="Overview">

             <text>
                  <![CDATA[
                  Participant <i>$$source_id$$</i> from Household <a href="showRecord.do?name=DwellingRecordClasses.DwellingRecordClass&project_id=@PROJECT_ID@&primary_key=$$EUPATH_0000094$$">$$EUPATH_0000094$$</a> in subcounty $$EUPATH_0000054$$.
                  ]]>
             </text>
          </textAttribute>



         <attributeQueryRef ref="ParticipantAttributes.ParticipantAttributes" attributeMetaQueryRef="ParticipantAttributes.ParticipantAttributesMeta"/>

<!--
        <table name="Characteristics"
               displayName="Participant Characteristics"
               queryRef="ParticipantTables.Characteristics">
            <columnAttribute name="source_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="name"  inReportMaker="false" internal="true"/>
             <columnAttribute name="parent_category" displayName="Category"/>
            <columnAttribute name="category" displayName="Characteristic"/>
            <columnAttribute name="value" displayName="Value"/>
        </table>
        <table name="UncategorizedCharacteristics"
               displayName="Uncategorized Participant Characteristics"
               queryRef="ParticipantTables.UncategorizedCharacteristics">
            <columnAttribute name="source_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="category" displayName="Category"/>
            <columnAttribute name="value" displayName="Value"/>
        </table>
-->

         <table name="Visits"
                 displayName="Clinical Visits"
                 queryRef="ParticipantTables.Visits">
            <columnAttribute name="source_id" internal="true"/>
            <columnAttribute name="project_id" internal="true"/>
            <columnAttribute name="link" internal="true"/>
            <linkAttribute name="db_link" displayName="Date of Visit" inReportMaker="false">
                 <displayText>
                    <![CDATA[
                    $$EUPATH_0000091$$
                    ]]>
                 </displayText>
                 <url>$$link$$</url>
            </linkAttribute>
            <columnAttribute name="EUPATH_0000040" displayName="Complicated malaria"/>
            <columnAttribute name="EUPATH_0000338" displayName="Malaria diagnosis and parasite status"/>
            <columnAttribute name="EUPATH_0000311" displayName="Visit type"/>
            <columnAttribute name="EUPATH_0000113" displayName="Age at time of visit"/>
            <columnAttribute name="EUPATH_0000110" displayName="Temperature"/>
            <columnAttribute name="EUPATH_0000091" displayName="Date of visit" internal="true"/>
            <columnAttribute name="EUPATH_0000092" displayName="Asexual parasite density"/>
            <columnAttribute name="EUPATH_0000100" displayName="Fever (subjective)"/>
          </table>
<!--

        <table name="Samples"
               displayName="Samples Collected From Participant"
               queryRef="ParticipantTables.Samples">
            <columnAttribute name="source_id" inReportMaker="false" internal="true"/>
            <columnAttribute name="name" inReportMaker="false" internal="true"/>
            <columnAttribute name="link" internal="true"/>
            <columnAttribute name="collection_date" internal="true"/>
            <linkAttribute name="db_link" displayName="Date of Sample Collection" inReportMaker="false">
                 <displayText>
                    <![CDATA[
                    $$collection_date$$
                    ]]>
                 </displayText>
                 <url>$$link$$</url>
            </linkAttribute>
            <columnAttribute name="sample_id" displayName="Sample ID"/>
            <columnAttribute name="specimen_type" displayName="Specimen Type"/>
        </table>
-->
    </recordClass>
    </recordClassSet>



      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Attribute queries -->  
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <querySet name="ParticipantAttributes" queryType="attribute" doNotTest="true"  
              isCacheable='false'
              excludeProjects="TrichDB">

      <testRowCountSql>
select count(*) from apidbtuning.ParticipantAttributes
       </testRowCountSql>

       <sqlQuery name="ParticipantAlias" doNotTest="true">
         <column name="source_id"/>
         <column name="project_id"/>
         <column name="old_source_id"/>
         <column name="old_project_id"/>
         <sql>
             SELECT name as source_id, '@PROJECT_ID@' AS project_id, name as old_source_id, '@PROJECT_ID@' AS old_project_id FROM ApidbTuning.ParticipantAttributes
         </sql>
       </sqlQuery>


       <sqlQuery name="ParticipantAttributes" attributeMetaQueryRef="ParticipantAttributes.ParticipantAttributesMeta">
         <column name="source_id"/>
         <column name="project_id"/>

         <!-- WARNING:  if you change this you must also change in the MetaQuery BELOW -->
         <sqlParamValue name="dwellingSourceIds"><![CDATA[EUPATH_0000054]]></sqlParamValue>

          <sql excludeProjects="EuPathDB">
            <![CDATA[
                     select pa.name as source_id, '@PROJECT_ID@' as project_id, pa.*,
                     da.*
                     from APIDBTUNING.PROTOCOLAPPNODEIO io
                        , apidbtuning.participantattributes pa
                        , (select protocol_app_node_id as hh_protocol_app_node_id, name as parent, &&dwellingSourceIds&& from apidbtuning.dwellingattributes) da
                     where pa.PROTOCOL_APP_NODE_ID = io.OUTPUT_NODE_ID (+)
                     and io.input_node_id = da.hh_PROTOCOL_APP_NODE_ID (+)
            ]]>
          </sql>  
         </sqlQuery>

       <sqlQuery name="ParticipantAttributesMeta" isCacheable="false">
          <column name="name" />
          <column name="display_name" />
          <column name="help" />
          <column name="plugin_name" />
          <column name="plugin_display" />
          <column name="plugin_description" />
          <column name="plugin_implementation" />
          <column name="plugin_view" />
          <column name="plugin_properties" />

         <!-- WARNING:  if you change this you must also change in the AttributeQuery ABOVE -->
          <sqlParamValue name="dwellingSourceIds"><![CDATA['EUPATH_0000054']]></sqlParamValue>

         <sql>
            <![CDATA[
                     select meta.display_name, meta.name, meta.help, 
                            decode(meta.type, 'string', 'wordCloud', 'number', 'histogram', null) as plugin_name,
                            decode(meta.type, 'string', 'Word Cloud', 'number', 'Histogram', null) as plugin_display,
                            decode(meta.type, 'string', 'Display the terms in the attribute as word clouds', 'number', 'Display a histogram of the values', null) as plugin_description,
                            decode(meta.type, 'string', 'org.gusdb.wdk.model.record.attribute.plugin.WordCloudAttributePlugin', 'number', 'org.gusdb.wdk.model.record.attribute.plugin.HistogramAttributePlugin', null) as plugin_implementation,
                            decode(meta.type, 'string', '/wdk/jsp/results/wordCloud.jsp', 'number', '/wdk/jsp/results/histogram.jsp', null) as plugin_view,
                            decode(meta.type, 'string', '[{"name":"min-word-length","value":"1"},{"name":"common-words","value":""},{"name":"exclude-numbers","value":"false"}]', null) as plugin_properties
                     from (select distinct ot.name as display_name, ot.source_id as name, ot.DEFINITION as help, mt.type
                           from APIDBTUNING.PANCHARACTERISTICMETADATA m, sres.ontologyterm ot, apidbtuning.metadatatype mt
                           where m.protocol_app_node_type = 'Participant'
                           and ot.ontology_term_id = m.TERM_ID
                           and mt.term_id = m.term_id
                           union
                           select distinct ot.name as display_name, ot.source_id as name, ot.DEFINITION as help, mt.type
                           from APIDBTUNING.PANPROTOCOLMETADATA m, sres.ontologyterm ot, apidbtuning.metadatatype mt
                           where m.protocol_app_node_type = 'Participant'
                           and ot.ontology_term_id = m.TERM_ID
                           and mt.term_id = m.term_id
                           union
                           select 'Name' as display_name, 'name' as name, '' as help, '' as type from dual
                           union
                           select ot.name as display_name, ot.source_id as name, ot.definition as help, mt.type from apidbtuning.metadatatype mt, sres.ontologyterm ot where ot.source_id = mt.source_id and mt.source_id in (&&dwellingSourceIds&&)
                           ) meta
            ]]>
         </sql>

         </sqlQuery>


      </querySet>   


    <querySet name="ParticipantTables" queryType="table" 
              isCacheable='false'
              excludeProjects="TrichDB">

      <sqlQuery name="Characteristics"  isCacheable='false'>
            <column name="source_id"/>
            <column name="name"/>
            <column name="parent_category"/>
            <column name="category"/>
            <column name="value"/>
            <sql>
            <![CDATA[
               select distinct 
                 anc.source_id, 
                 anc.name,
                 anc.value,
                 pc.parent_category,
                nvl(os.ontology_synonym,anc.category) as category
            from ApidbTuning.AppNodeCharacteristics anc
                 ,ApidbTuning.MetaDataSpec mds
                 ,Sres.OntologySynonym os
                 ,( select listagg(display.spec_value,' : ') within group (order by tier desc) as parent_category,
                           root as ontology_term_id
                      from ( select distinct property as term, 
                                             ontology_term_id, 
                                             spec_value as parent_term,
                                             connect_by_root ontology_term_id as root,
                                             to_number(level) as  tier
                               from (select * from apidbtuning.metadataspec  where spec_property = 'parent' ) mds
                              start with property in ( select distinct property from ApidbTuning.metadataspec where spec_property = 'leaf' )
                            connect by prior spec_value = property
                            )mds, 
                            (select distinct property,
                                             ontology_term_id,
                                             spec_value 
                              from ApidbTuning.metadataspec 
                             where spec_property = 'display' )display
                    where tier != 1 
                      and mds.term = display.property
                      group by root) pc
                    
              where anc.type = 'person'
             and anc.ontology_term_source_id = mds.property
             and anc.ontology_term_id = os.ontology_term_id (+)
             and pc.ontology_term_id(+) = anc.ontology_term_id
          union
           select distinct source_id,
                  source_id as name,
                  value,
                  'Dwelling' as parent_category,
                 'household id' as category
            from ApidbTuning.AppNodeCharacteristics
           where category = 'parent_id'
           and type = 'person'
           order by source_id, parent_category, category
            ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="UncategorizedCharacteristics"  isCacheable='false'>
            <column name="source_id"/>
            <column name="name"/>
            <column name="category"/>
            <column name="value"/>
            <sql>
            <![CDATA[
          select distinct 
                 anc.source_id, 
                 anc.source_id as name,
                 anc.value,
                 anc.category
            from ApidbTuning.AppNodeCharacteristics anc
                 ,ApidbTuning.MetaDataSpec mds
           where anc.type = 'person'
             and anc.ontology_term_source_id = mds.property
             and mds.spec_property = 'categorized'
             and mds.spec_value = 'false'   
             and anc.category != 'hhid'
           order by source_id, category
            ]]>
            </sql>
        </sqlQuery>



      <sqlQuery name="Visits"  isCacheable='false'>
            <column name="source_id"/>
            <column name="project_id"/>

            <!-- These to be made dynamic -->
            <column name="EUPATH_0000091"/>
            <column name="EUPATH_0000113"/>
            <column name="EUPATH_0000311"/>
            <column name="EUPATH_0000338"/>
            <column name="EUPATH_0000100"/>
            <column name="EUPATH_0000110"/>
            <column name="EUPATH_0000092"/>
            <column name="EUPATH_0000040"/>

           <column name="link"/>

         <sqlParamValue name="visitSourceIds"><![CDATA[EUPATH_0000091,EUPATH_0000113,EUPATH_0000311,EUPATH_0000338,EUPATH_0000100,EUPATH_0000110,EUPATH_0000092,EUPATH_0000040]]></sqlParamValue>
         <sqlParamValue name="orderBy"><![CDATA[EUPATH_0000091]]></sqlParamValue>
            <sql>
            <![CDATA[

select pa.name as source_id,
        '@PROJECT_ID@' as project_id, &&visitSourceIds&&, 
                   'todo'||cv.name as link
              from ApidbTuning.ClinicalVisitAttributes cv
              , apidbtuning.participantattributes pa
              , apidbtuning.protocolappnodeio io
              where cv.PROTOCOL_APP_NODE_ID = io.OUTPUT_NODE_ID
              and io.INPUT_NODE_ID = pa.PROTOCOL_APP_NODE_ID
              order by &&orderBy&&
            ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="Samples"  isCacheable='false'>
            <column name="source_id"/>
            <column name="name"/>
            <column name="sample_id"/>
            <column name="collection_date"/>
            <column name="visit_id"/>
            <column name="specimen_type"/>
            <column name="link"/>
            <sql>
                 <![CDATA[
                                 select distinct pa.source_id, 
                                  pa.name, 
                                  sa.source_id as sample_id,
                                  to_char(sa.collection_date, 'MONTH DD, YYYY') as collection_date,
                                  cv.source_id as visit_id,
                                  sa.specimen_type,
                   'showRecord.do?name=ClinicalVisitRecordClasses.ClinicalVisitRecordClass&project_id=@PROJECT_ID@&primary_key='||cv.source_id as link
                       from ApidbTuning.CLINICALVISITATTRIBUTES cv, apidbtuning.SampleAttributes sa, apidbtuning.personAttributes pa 
                      where cv.parent_id = sa.parent_id 
                        and sa.parent_id = pa.source_id
                        and cv.visit_date (+) = sa.collection_date
                  order by sa.collection_date, sa.SPECIMEN_TYPE
                  ]]>
            </sql>
        </sqlQuery>    
  </querySet>

</wdkModel>

