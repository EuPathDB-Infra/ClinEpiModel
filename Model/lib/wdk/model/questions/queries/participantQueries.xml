 <wdkModel>

   <!-- notes

   -->

   <querySet name="ParticipantId" queryType="id" isCacheable="false">

     <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
     <!-- Source id  -->
     <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <!-- TEMPLATE_ANCHOR participantSourceIdQuery -->
     
     <sqlQuery name="ParticipantsByCharWizRelVis_prism" isCacheable="true">
       <paramRef ref="participantParams.geographic_region_prism" groupRef="metaDataGroups.geographic_loc"/>
       <paramRef ref="clinicalVisitParams.visit_date" minDate="2011-07-01" maxDate="2017-07-31" groupRef="metaDataGroups.daterange"/>
       <paramRef ref="participantParams.duration_observation" groupRef="metaDataGroups.daterange"/>  
       <paramRef ref="participantParams.visits_visitage_metadata_prism" groupRef="metaDataGroups.daterange"/>
       <paramRef ref="participantParams.participants_prism" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="participantParams.households_prism" groupRef="metaDataGroups.part_household_characteristics"/>
       <paramRef ref="participantParams.visits_per_year" groupRef="metaDataGroups.part_visit_characteristics"/> 
       <paramRef ref="participantParams.visits_prism" groupRef="metaDataGroups.part_visit_characteristics"/>
       <paramRef ref="clinicalVisitParams.use_relative_visits" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="clinicalVisitParams.days_between" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="clinicalVisitParams.date_direction_fv" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="clinicalVisitParams.dateOperator_fv" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="participantParams.relative_visits_prism" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="D0ad509829e" groupRef="metaDataGroups.relative_visits"/>
       <column name="source_id"/>
       <column name="project_id"/>
       <column name="visit_count"/>
       <column name="visits_per_year_obs"/>
       <column name="time_of_obs"/>
       <column name="ave_anoph"/>
       <sql>
           <![CDATA[
select pa.name, pa.name as source_id, '@PROJECT_ID@' as project_id, core.visit_count,
round(core.visit_count / ((abs(least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EFO_0004950 + ( age.max_age * 365)) -
      greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EFO_0004950 + ( age.min_age * 365))) + 1) / 365),1) as visits_per_year_obs,
round((abs(least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EFO_0004950 + ( age.max_age * 365)) - 
      greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EFO_0004950 + ( age.min_age * 365))) + 1) / 365,1) as time_of_obs,
mos.ave_anoph
from
(select pa.pan_id, nvl(visits.visit_count,0) as visit_count
from ApidbTuning.$$tbl_prefix$$Participants pa, 
(select input_pan_id,count(*) as visit_count
from
(select distinct io.input_pan_id, io.output_pan_id
from  ApidbTuning.$$tbl_prefix$$Panio io 
where io.output_pan_id in ($$visits_prism$$)
and Io.Input_Pan_Type_Source_Id = 'EUPATH_0000096'
$$dateOperator_fv$$
select distinct ioa.input_pan_id, ioa.output_pan_id
from ApidbTuning.$$tbl_prefix$$Panio ioa, ApidbTuning.$$tbl_prefix$$Panio iob, ApidbTuning.$$tbl_prefix$$Observations vis, ApidbTuning.$$tbl_prefix$$Observations rv
where vis.pan_id in ($$visits_prism$$)
and $$use_relative_visits$$ = 1
and rv.pan_id in ($$relative_visits_prism$$)
and vis.pan_id = ioa.output_pan_id
and rv.pan_id = iob.output_pan_id
and ioa.input_pan_id = iob.input_pan_id
and vis.pan_id != rv.pan_id
and vis.EUPATH_0000091 $$date_direction_fv$$ rv.EUPATH_0000091  
and abs(rv.EUPATH_0000091 - vis.EUPATH_0000091) >= $$days_between.min$$
and abs(rv.EUPATH_0000091 - vis.EUPATH_0000091) <= $$days_between.max$$
)
group by input_pan_id) visits
where pa.pan_id in ($$households_prism$$)
and pa.pan_id = visits.input_pan_id(+)) core, ApidbTuning.$$tbl_prefix$$Participants pa,
(select min(EUPATH_0000113) as min_age, max(EUPATH_0000113) as max_age
   from ApidbTuning.$$tbl_prefix$$Observations 
   where pan_id in ($$visits_visitage_metadata_prism$$)
   ) age,
(select iop.output_pan_id as part_id, round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as ave_anoph
  from ApidbTuning.$$tbl_prefix$$Panio iol, ApidbTuning.$$tbl_prefix$$LightTraps la, ApidbTuning.$$tbl_prefix$$Panio iop
  where iol.output_pan_id = la.pan_id
  and Iol.Input_Pan_Type_Source_Id = 'PCO_0000024'
  and iop.input_pan_id = iol.input_pan_id
  and Iop.Output_Pan_Type_Source_Id = 'EUPATH_0000096'
  and EUPATH_0020003 >= $$visit_date.min$$ 
  and EUPATH_0020003 <= $$visit_date.max$$ 
  group by iop.output_pan_id) mos
where pa.pan_id = core.pan_id
and round(core.visit_count / ((abs(least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EFO_0004950 + ( age.max_age * 365)) -
greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EFO_0004950 + ( age.min_age * 365))) + 1) / 365),1) >= $$visits_per_year.min$$
and round(core.visit_count / ((abs(least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EFO_0004950 + ( age.max_age * 365)) -
greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EFO_0004950 + ( age.min_age * 365))) + 1) / 365),1) <= $$visits_per_year.max$$
and pa.pan_id = mos.part_id(+) 
                ]]>   
        </sql>
     </sqlQuery>

     <sqlQuery name="ParticipantsByCharWizRelVis_prism2" isCacheable="true">
       <paramRef ref="clinicalVisitParams.visit_date" minDate="2017-09-01" maxDate="2019-12-31" groupRef="metaDataGroups.daterange"/>
       <paramRef ref="participantParams.duration_observation" groupRef="metaDataGroups.daterange"/>  
       <paramRef ref="participantParams.visits_visitage_metadata_prism" groupRef="metaDataGroups.daterange"/>
       <paramRef ref="participantParams.participants_prism" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="participantParams.households_prism" groupRef="metaDataGroups.part_household_characteristics"/>
       <paramRef ref="participantParams.visits_per_year" groupRef="metaDataGroups.part_visit_characteristics"/> 
       <paramRef ref="participantParams.visits_prism" groupRef="metaDataGroups.part_visit_characteristics"/>
       <paramRef ref="clinicalVisitParams.use_relative_visits" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="clinicalVisitParams.days_between" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="clinicalVisitParams.date_direction_fv" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="clinicalVisitParams.dateOperator_fv" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="participantParams.relative_visits_prism" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="D51b40fe2e2" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="participantParams.geographic_region_prism" visible="false" groupRef="metaDataGroups.relative_visits"/>
       <column name="source_id"/>
       <column name="project_id"/>
       <column name="visit_count"/>
       <column name="visits_per_year_obs"/>
       <column name="time_of_obs"/>
       <column name="ave_anoph"/>
       <sql>
           <![CDATA[
select pa.name, pa.name as source_id, '@PROJECT_ID@' as project_id, core.visit_count,
round(core.visit_count / ((abs(least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EFO_0004950 + ( age.max_age * 365)) -
      greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EFO_0004950 + ( age.min_age * 365))) + 1) / 365),1) as visits_per_year_obs,
round((abs(least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EFO_0004950 + ( age.max_age * 365)) - 
      greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EFO_0004950 + ( age.min_age * 365))) + 1) / 365,1) as time_of_obs,
mos.ave_anoph
from
(select pa.pan_id, nvl(visits.visit_count,0) as visit_count
from ApidbTuning.$$tbl_prefix$$Participants pa, 
(select input_pan_id,count(*) as visit_count
from
(select distinct io.input_pan_id, io.output_pan_id
from  ApidbTuning.$$tbl_prefix$$Panio io 
where io.output_pan_id in ($$visits_prism$$)
and Io.Input_Pan_Type_Source_Id = 'EUPATH_0000096'
$$dateOperator_fv$$
select distinct ioa.input_pan_id, ioa.output_pan_id
from ApidbTuning.$$tbl_prefix$$Panio ioa, ApidbTuning.$$tbl_prefix$$Panio iob, ApidbTuning.$$tbl_prefix$$Observations vis, ApidbTuning.$$tbl_prefix$$Observations rv
where vis.pan_id in ($$visits_prism$$)
and $$use_relative_visits$$ = 1
and rv.pan_id in ($$relative_visits_prism$$)
and vis.pan_id = ioa.output_pan_id
and rv.pan_id = iob.output_pan_id
and ioa.input_pan_id = iob.input_pan_id
and vis.pan_id != rv.pan_id
and vis.EUPATH_0000091 $$date_direction_fv$$ rv.EUPATH_0000091  
and abs(rv.EUPATH_0000091 - vis.EUPATH_0000091) >= $$days_between.min$$
and abs(rv.EUPATH_0000091 - vis.EUPATH_0000091) <= $$days_between.max$$
)
group by input_pan_id) visits
where pa.pan_id in ($$households_prism$$)
and pa.pan_id = visits.input_pan_id(+)) core, ApidbTuning.$$tbl_prefix$$Participants pa,
(select min(EUPATH_0000113) as min_age, max(EUPATH_0000113) as max_age
   from ApidbTuning.$$tbl_prefix$$Observations 
   where pan_id in ($$visits_visitage_metadata_prism$$)
   ) age,
(select iop.output_pan_id as part_id, round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as ave_anoph
  from ApidbTuning.$$tbl_prefix$$Panio iol, ApidbTuning.$$tbl_prefix$$LightTraps la, ApidbTuning.$$tbl_prefix$$Panio iop
  where iol.output_pan_id = la.pan_id
  and Iol.Input_Pan_Type_Source_Id = 'PCO_0000024'
  and iop.input_pan_id = iol.input_pan_id
  and Iop.Output_Pan_Type_Source_Id = 'EUPATH_0000096'
  and EUPATH_0020003 >= $$visit_date.min$$ 
  and EUPATH_0020003 <= $$visit_date.max$$ 
  group by iop.output_pan_id) mos
where pa.pan_id = core.pan_id
and round(core.visit_count / ((abs(least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EFO_0004950 + ( age.max_age * 365)) -
greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EFO_0004950 + ( age.min_age * 365))) + 1) / 365),1) >= $$visits_per_year.min$$
and round(core.visit_count / ((abs(least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EFO_0004950 + ( age.max_age * 365)) -
greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EFO_0004950 + ( age.min_age * 365))) + 1) / 365),1) <= $$visits_per_year.max$$
and pa.pan_id = mos.part_id(+) 
                ]]>   
        </sql>
     </sqlQuery>

     <sqlQuery name="ParticipantsByCharWizRelVis_maled"
          isCacheable="true">
       <paramRef ref="participantParams.geographic_region_maled" groupRef="metaDataGroups.geographic_loc"/>
       <paramRef ref="participantParams.households_maled" groupRef="metaDataGroups.part_household_characteristics"/>
       <paramRef ref="participantParams.participants_maled" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="participantParams.visits_maled" groupRef="metaDataGroups.part_event_characteristics"/>
       <paramRef ref="clinicalVisitParams.use_relative_visits" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.days_between" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.date_direction_fv" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.dateOperator_fv" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.relative_visits_maled" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="participantParams.visit_count" groupRef="metaDataGroups.event_summary_params"/> 
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="D3dbf92dc05" groupRef="metaDataGroups.event_summary_params"/>
       <column name="source_id"/>
       <column name="project_id"/>
       <column name="ave_age_visit"/>
       <column name="visit_count"/>
         <sql>
           <![CDATA[
select pa.name, pa.name as source_id, '@PROJECT_ID@' as project_id, 
                    count(*) as visit_count, 
   round(avg(number_value),1) -1 as ave_age_visit
from (select distinct participant_id,observation_id,number_value from ApidbTuning.$$tbl_prefix$$ObservationMD
      where observation_id in ($$visits_maled$$)
      and ontology_term_name = 'EUPATH_0000644'
$$dateOperator_fv$$
 select distinct vis.participant_id,vis.observation_id,vis.number_value
 from ApidbTuning.$$tbl_prefix$$ObservationMD vis, ApidbTuning.$$tbl_prefix$$ObservationMD rv
 where vis.observation_id in ($$visits_maled$$)
 and vis.ontology_term_name = 'EUPATH_0000644'
and $$use_relative_visits$$ = 1
and rv.observation_id in ($$relative_visits_maled$$)
and rv.ontology_term_name = 'EUPATH_0000644'
and vis.participant_id = rv.participant_id
and vis.observation_id != rv.observation_id
and vis.number_value $$date_direction_fv$$ rv.number_value  
and abs(rv.number_value - vis.number_value) >= $$days_between.min$$
and abs(rv.number_value - vis.number_value) <= $$days_between.max$$
group by vis.participant_id,vis.observation_id,vis.number_value
) main, ApidbTuning.$$tbl_prefix$$Participants pa
where pa.pan_id = main.participant_id
group by pa.name 
having count(*) >= $$visit_count.min$$
and count(*) <= $$visit_count.max$$
                ]]>   
        </sql>
     </sqlQuery>

     <sqlQuery name="ParticipantsByCharWizRelVis_india"
          isCacheable="true">
       <paramRef ref="participantParams.geographic_region_india" groupRef="metaDataGroups.geographic_loc"/>
       <paramRef ref="participantParams.households_india" groupRef="metaDataGroups.part_household_characteristics"/>
       <paramRef ref="participantParams.participants_india" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="participantParams.visits_india" groupRef="metaDataGroups.part_event_characteristics"/>
       <paramRef ref="clinicalVisitParams.use_relative_visits" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.days_between" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.date_direction_fv" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.dateOperator_fv" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.relative_visits_india" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="D05ea525fd3" groupRef="metaDataGroups.relative_events"/>
       <column name="source_id"/>
       <column name="project_id"/>
         <sql>
           <![CDATA[
select pa.name, pa.name as source_id, '@PROJECT_ID@' as project_id
from (select distinct participant_id,observation_id,date_value from ApidbTuning.$$tbl_prefix$$ObservationMD
      where observation_id in ($$visits_india$$)
      and ontology_term_name = 'EUPATH_0000091'
$$dateOperator_fv$$
 select distinct vis.participant_id,vis.observation_id,vis.date_value
 from ApidbTuning.$$tbl_prefix$$ObservationMD vis, ApidbTuning.$$tbl_prefix$$ObservationMD rv
 where vis.observation_id in ($$visits_india$$)
 and vis.ontology_term_name = 'EUPATH_0000091'
and $$use_relative_visits$$ = 1
and rv.observation_id in ($$relative_visits_india$$)
and rv.ontology_term_name = 'EUPATH_0000091'
and vis.participant_id = rv.participant_id
and vis.observation_id != rv.observation_id
and vis.date_value $$date_direction_fv$$ rv.date_value  
and abs(rv.date_value - vis.date_value) >= $$days_between.min$$
and abs(rv.date_value - vis.date_value) <= $$days_between.max$$
group by vis.participant_id,vis.observation_id,vis.date_value
) main, ApidbTuning.$$tbl_prefix$$Participants pa
where pa.pan_id = main.participant_id
group by pa.name 
                ]]>   
        </sql>
     </sqlQuery>

     <sqlQuery name="ParticipantsXSectional_india"
          isCacheable="true">
       <paramRef ref="participantParams.geographic_region_india" groupRef="metaDataGroups.geographic_loc"/>
       <paramRef ref="participantParams.households_india" groupRef="metaDataGroups.part_household_characteristics"/>
       <paramRef ref="participantParams.participants_india" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="participantParams.visits_india" groupRef="metaDataGroups.part_event_characteristics"/>
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="Da5c969d5fa" groupRef="metaDataGroups.part_event_characteristics"/>
       <column name="source_id"/>
       <column name="project_id"/>
         <sql>
           <![CDATA[
select pa.name, pa.name as source_id, '@PROJECT_ID@' as project_id
from ApidbTuning.$$tbl_prefix$$ObservationMD obs, ApidbTuning.$$tbl_prefix$$Participants pa
where obs.observation_id in ($$visits_india$$)
and pa.pan_id = obs.participant_id
group by pa.name 
                ]]>   
        </sql>
     </sqlQuery>

     <sqlQuery name="ParticipantsByCaseControl_gems"
          isCacheable="true">
       <paramRef ref="participantParams.case_control" groupRef="metaDataGroups.choose_case_control"/> 
       <paramRef ref="participantParams.study_arm" visible="false" groupRef="metaDataGroups.choose_case_control"/> 
       <paramRef ref="participantParams.geographic_region_gems" groupRef="metaDataGroups.geographic_loc"/>
       <paramRef ref="participantParams.household_gems" groupRef="metaDataGroups.part_household_characteristics"/>
       <paramRef ref="participantParams.participant_gems" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="participantParams.event_gems" groupRef="metaDataGroups.part_event_characteristics"/>
       <paramRef ref="participantParams.use_rel_case_control" groupRef="metaDataGroups.relative_case_control"/>
       <paramRef ref="participantParams.keep_remove" groupRef="metaDataGroups.relative_case_control"/>
       <paramRef ref="participantParams.relative_event_gems" groupRef="metaDataGroups.relative_case_control"/>
       <paramRef ref="participantParams.return_case_control" groupRef="metaDataGroups.results_options"/>
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="D841A9F5259" groupRef="metaDataGroups.relative_case_control"/> 
       <column name="source_id"/>
       <column name="project_id"/>
         <sql>
           <![CDATA[
with core as (
select distinct name, EUPATH_0010049, EUPATH_0010375
from (
select distinct name, EUPATH_0010049, EUPATH_0010375 from ApidbTuning.$$tbl_prefix$$Participants
      where pan_id in ($$event_gems$$) 
$$keep_remove$$
select distinct vis.name, vis.EUPATH_0010049, vis.EUPATH_0010375 from ApidbTuning.$$tbl_prefix$$Participants vis, ApidbTuning.$$tbl_prefix$$Participants rv
      where $$use_rel_case_control$$ = 1
      and vis.pan_id in ($$event_gems$$)
      and rv.pan_id in ($$relative_event_gems$$)
      and vis.EUPATH_0010049 = rv.EUPATH_0010049
      and vis.name != rv.name )
)
select name as source_id, '@PROJECT_ID@' as project_id from core
where 'selected' = $$return_case_control$$
UNION
select distinct pa.name as source_id, '@PROJECT_ID@' as project_id 
from core, ApidbTuning.$$tbl_prefix$$Participants pa
where 'caseid' = $$return_case_control$$
and core.EUPATH_0010049 = pa.EUPATH_0010049
/*
UNION
select distinct pa.name as source_id, '@PROJECT_ID@' as project_id 
from core, ApidbTuning.$$tbl_prefix$$Participants pa
where 'matching' = $$return_case_control$$
and core.EUPATH_0010049 = pa.EUPATH_0010049
and core.EUPATH_0010375 != pa.EUPATH_0010375
*/
                ]]>   
        </sql>
     </sqlQuery>

     <sqlQuery name="Participant_indiaFS"
          isCacheable="true">
       <paramRef ref="participantParams.participants_indiaFS" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="participantParams.visits_indiaFS" groupRef="metaDataGroups.part_event_characteristics"/>
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="D4902d9b7ec" groupRef="metaDataGroups.part_event_characteristics"/>
       <column name="source_id"/>
       <column name="project_id"/>
         <sql>
           <![CDATA[
select pa.name, pa.name as source_id, '@PROJECT_ID@' as project_id
from ApidbTuning.$$tbl_prefix$$PartObsIO obs, ApidbTuning.$$tbl_prefix$$Participants pa
where obs.observation_id in ($$visits_indiaFS$$)
and pa.pan_id = obs.participant_id
group by pa.name 
                ]]>   
        </sql>
     </sqlQuery>

     <sqlQuery name="ParticipantsByCaseControl_gems1a"
          isCacheable="true">
       <paramRef ref="participantParams.study_arm" groupRef="metaDataGroups.study_arm_case_control"/> 
       <paramRef ref="participantParams.case_control" groupRef="metaDataGroups.study_arm_case_control"/> 
       <paramRef ref="participantParams.geographic_region_gems" groupRef="metaDataGroups.geographic_loc"/>
       <paramRef ref="participantParams.household_gems" groupRef="metaDataGroups.part_household_characteristics"/>
       <paramRef ref="participantParams.participant_gems" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="participantParams.event_gems" groupRef="metaDataGroups.part_event_characteristics"/>
       <paramRef ref="participantParams.use_rel_case_control" groupRef="metaDataGroups.relative_case_control"/>
       <paramRef ref="participantParams.keep_remove" groupRef="metaDataGroups.relative_case_control"/>
       <paramRef ref="participantParams.relative_event_gems" groupRef="metaDataGroups.relative_case_control"/>
       <paramRef ref="participantParams.return_case_control" groupRef="metaDataGroups.results_options"/>
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="D2a6ace17a1" groupRef="metaDataGroups.relative_case_control"/> 
       <column name="source_id"/>
       <column name="project_id"/>
         <sql>
           <![CDATA[
with core as (
select distinct name, EUPATH_0010049, EUPATH_0010375
from (
select distinct name, EUPATH_0010049, EUPATH_0010375 from ApidbTuning.$$tbl_prefix$$Participants
      where pan_id in ($$event_gems$$) 
$$keep_remove$$
select distinct vis.name, vis.EUPATH_0010049, vis.EUPATH_0010375 from ApidbTuning.$$tbl_prefix$$Participants vis, ApidbTuning.$$tbl_prefix$$Participants rv
      where $$use_rel_case_control$$ = 1
      and vis.pan_id in ($$event_gems$$)
      and rv.pan_id in ($$relative_event_gems$$)
      and vis.EUPATH_0010049 = rv.EUPATH_0010049
      and vis.name != rv.name )
)
select name as source_id, '@PROJECT_ID@' as project_id from core
where 'selected' = $$return_case_control$$
UNION
select distinct pa.name as source_id, '@PROJECT_ID@' as project_id 
from core, ApidbTuning.$$tbl_prefix$$Participants pa
where 'caseid' = $$return_case_control$$
and core.EUPATH_0010049 = pa.EUPATH_0010049
/*
UNION
select distinct pa.name as source_id, '@PROJECT_ID@' as project_id 
from core, ApidbTuning.$$tbl_prefix$$Participants pa
where 'matching' = $$return_case_control$$
and core.EUPATH_0010049 = pa.EUPATH_0010049
and core.EUPATH_0010375 != pa.EUPATH_0010375
*/
                ]]>   
        </sql>
     </sqlQuery>

     <sqlQuery name="ParticipantsXSectional_sasia"
          isCacheable="true">
       <paramRef ref="participantParams.participants_sasia" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="participantParams.visits_sasia" groupRef="metaDataGroups.part_event_characteristics"/>
       <paramRef ref="clinicalVisitParams.use_relative_visits" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.days_between" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.date_direction_fv" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.dateOperator_fv" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.relative_visits_sasia" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="participantParams.visit_count" groupRef="metaDataGroups.event_summary_params"/> 
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="D13c737a528" groupRef="metaDataGroups.part_event_characteristics"/>
       <column name="source_id"/>
       <column name="project_id"/>
         <sql>
           <![CDATA[
with io as (
select distinct input_pan_id as participant_id, output_pan_id as observation_id
from ApidbTuning.$$tbl_prefix$$PANIO 
where input_pan_type_source_id = 'EUPATH_0000096' 
and output_pan_type_source_id = 'EUPATH_0000738'
)
select pa.name, pa.name as source_id, '@PROJECT_ID@' as project_id, 
                    count(*) as visit_count, 
   round(avg(number_value),1) -1 as ave_age_visit
from (select distinct io.participant_id,io.observation_id,nvl(o.EUPATH_0023016,0) as number_value from ApidbTuning.$$tbl_prefix$$Observations o, io
      where o.pan_id in ($$visits_sasia$$)
      and io.observation_id = o.pan_id
$$dateOperator_fv$$
 select distinct visio.participant_id,visio.observation_id,nvl(vis.EUPATH_0023016,0)
 from ApidbTuning.$$tbl_prefix$$Observations vis, io visio, ApidbTuning.$$tbl_prefix$$Observations rv, io rvio
 where vis.pan_id in ($$visits_sasia$$)
      and visio.observation_id = vis.pan_id
and $$use_relative_visits$$ = 1
and rv.pan_id in ($$relative_visits_sasia$$)
and rvio.observation_id = rv.pan_id
and visio.participant_id = rvio.participant_id
and visio.observation_id != rvio.observation_id
and nvl(vis.EUPATH_0023016,0) $$date_direction_fv$$ nvl(rv.EUPATH_0023016,0)  
and abs(nvl(rv.EUPATH_0023016,0) - nvl(vis.EUPATH_0023016,0)) >= $$days_between.min$$
and abs(nvl(rv.EUPATH_0023016,0) - nvl(vis.EUPATH_0023016,0)) <= $$days_between.max$$
group by visio.participant_id,visio.observation_id,nvl(vis.EUPATH_0023016,0)
) main, ApidbTuning.$$tbl_prefix$$Participants pa
where pa.pan_id = main.participant_id
group by pa.name 
having count(*) >= $$visit_count.min$$
and count(*) <= $$visit_count.max$$
                ]]>   
        </sql>
     </sqlQuery>

     <sqlQuery name="ParticipantsByRelativeVisits_amazperu"
          isCacheable="true">
       <paramRef ref="participantParams.geographic_region_amazperu" groupRef="metaDataGroups.geographic_loc"/>
       <paramRef ref="participantParams.households_amazperu" groupRef="metaDataGroups.part_household_characteristics"/>
       <paramRef ref="participantParams.participants_amazperu" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="participantParams.visits_amazperu" groupRef="metaDataGroups.part_event_characteristics"/>
       <paramRef ref="clinicalVisitParams.use_relative_visits" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.days_between" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.date_direction_fv" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.dateOperator_fv" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.relative_visits_amazperu" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="D897fe55e6f" groupRef="metaDataGroups.relative_events"/>
       <column name="source_id"/>
       <column name="project_id"/>
         <sql>
           <![CDATA[
select pa.name, pa.name as source_id, '@PROJECT_ID@' as project_id
from (select distinct participant_id,observation_id,date_value from ApidbTuning.$$tbl_prefix$$ObservationMD
      where observation_id in ($$visits_amazperu$$)
      and ontology_term_name = 'EUPATH_0004991'
$$dateOperator_fv$$
 select distinct vis.participant_id,vis.observation_id,vis.date_value
 from ApidbTuning.$$tbl_prefix$$ObservationMD vis, ApidbTuning.$$tbl_prefix$$ObservationMD rv
 where vis.observation_id in ($$visits_amazperu$$)
 and vis.ontology_term_name = 'EUPATH_0004991'
and $$use_relative_visits$$ = 1
and rv.observation_id in ($$relative_visits_amazperu$$)
and rv.ontology_term_name = 'EUPATH_0004991'
and vis.participant_id = rv.participant_id
and vis.observation_id != rv.observation_id
and vis.date_value $$date_direction_fv$$ rv.date_value  
and abs(rv.date_value - vis.date_value) >= $$days_between.min$$
and abs(rv.date_value - vis.date_value) <= $$days_between.max$$
group by vis.participant_id,vis.observation_id,vis.date_value
) main, ApidbTuning.$$tbl_prefix$$Participants pa
where pa.pan_id = main.participant_id
group by pa.name 
                ]]>   
        </sql>
     </sqlQuery>

<!-- transform(s) -->

      <!-- TEMPLATE_ANCHOR participantsByHouseholdsQuery -->                   

      <!-- TEMPLATE_ANCHOR participantsByObservationsQuery -->                   

  </querySet>
</wdkModel>
