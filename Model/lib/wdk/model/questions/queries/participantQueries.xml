 <wdkModel>

   <!-- notes

   -->

   <querySet name="ParticipantId" queryType="id" isCacheable="false">

     <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
     <!-- Source id  -->
     <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="ParticipantsBySourceID" includeProjects="ICEMR"
          isCacheable="true">
      <!-- <paramRef ref="participantParams.participantsBySourceID"/> -->
       <paramRef ref="participantParams.participantsBySourceID"/>
       <column name="source_id"/>
       <column name="project_id"/>
      <sql>
           <![CDATA[
 Select distinct pa.name as source_id, '@PROJECT_ID@' as project_id from  ApidbTuning.$$tbl_prefix$$Participants pa,
 ($$participantsBySourceID$$) ds where pa.name = ds.source_id
                ]]>   
        </sql>
     </sqlQuery>

     
     <!-- not used ..... no relative visits but leave in case decide to use at some point .... -->
     
     <sqlQuery name="ParticipantsByCharWiz" isCacheable="true" includeProjects="NotUsed">
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="ISASimple_ICEMR_PRISM_surveillance_RSRC" groupRef="metaDataGroups.geographic_loc"/>
       <paramRef ref="participantParams.geographic_region_prism" groupRef="metaDataGroups.geographic_loc"/>
       <paramRef ref="clinicalVisitParams.visit_date" groupRef="metaDataGroups.daterange"/>
       <paramRef ref="participantParams.duration_observation" groupRef="metaDataGroups.daterange"/>  
       <paramRef ref="participantParams.visits_visitage_metadata_prism" groupRef="metaDataGroups.daterange"/>
       <paramRef ref="participantParams.participants_prism" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="participantParams.households_prism" groupRef="metaDataGroups.part_household_characteristics"/>
       <paramRef ref="participantParams.visits_prism" groupRef="metaDataGroups.part_visit_characteristics"/>
       <paramRef ref="participantParams.parasite_density" groupRef="metaDataGroups.summary_params"/>
       <paramRef ref="participantParams.visits_per_year" groupRef="metaDataGroups.summary_params"/>
       <column name="source_id"/>
       <column name="project_id"/>
       <column name="ave_anoph"/>
       <column name="avg_hemo"/>
       <column name="avg_weight"/>
       <column name="ave_para_density"/>
       <column name="ave_age_visit"/>
       <column name="visit_count"/>
       <column name="visits_per_year_obs"/>
       <column name="time_of_obs"/>
         <sql>
           <![CDATA[
select pa.name, pa.name as source_id, '@PROJECT_ID@' as project_id, 
 round(count(*) / ((least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EUPATH_0000032 + ( age.max_age * 365)) - 
       greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EUPATH_0000032 + ( age.min_age * 365)) + 1) / 365),1) as visits_per_year_obs,
                    round((least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EUPATH_0000032 + ( age.max_age * 365)) - 
       greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EUPATH_0000032 + ( age.min_age * 365)) + 1) / 365,1) as time_of_obs, 
                    count(*) as visit_count, mos.ave_anoph, 
   round(exp(avg(case when ca.EUPATH_0000092 > 0.0 then ln(ca.EUPATH_0000092) else ln(0.00000000000001) end)),1) as ave_para_density,
   round(avg(ca.EUPATH_0000113),1) as ave_age_visit,
   round(avg(ca.EUPATH_0000047),1) as avg_hemo,
   round(avg(ca.IAO_0000414),1) as avg_weight
from ApidbTuning.$$tbl_prefix$$Observations ca, ApidbTuning.$$tbl_prefix$$Participants pa, ApidbTuning.$$tbl_prefix$$PANIO io,
   (select min(EUPATH_0000113) as min_age, max(EUPATH_0000113) as max_age
   from ApidbTuning.$$tbl_prefix$$Observations 
   where pan_id in (SELECT distinct md.internal FROM ($$visits_visitage_metadata_nf$$) md)
   ) age,
   (select da.pan_id, round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as ave_anoph
  from ApidbTuning.$$tbl_prefix$$Households da, ApidbTuning.$$tbl_prefix$$PANIO io, ApidbTuning.$$tbl_prefix$$LightTraps la
  where da.pan_id = io.input_pan_id
  and la.pan_id = io.output_pan_id
  and la.OBI_0001619 >= $$visit_date.min$$ 
  and la.OBI_0001619 <= $$visit_date.max$$ 
  group by da.pan_id) mos, ApidbTuning.$$tbl_prefix$$PANIO iom
where ca.pan_id in ($$visits_nf$$)
and ca.pan_id = io.output_pan_id
and pa.pan_id = io.input_pan_id
and iom.output_pan_id = pa.pan_id
and iom.input_pan_id = mos.pan_id(+)
group by pa.name, pa.EUPATH_0000152, pa.EUPATH_0000032, pa.EUPATH_0000151,age.max_age,age.min_age,mos.ave_anoph 
having count(*) / ((least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EUPATH_0000032 + ( age.max_age * 365)) - 
       greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EUPATH_0000032 + ( age.min_age * 365)) + 1) / 365) >= $$visits_per_year.min$$
 and count(*) / ((least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EUPATH_0000032 + ( age.max_age * 365)) - 
       greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EUPATH_0000032 + ( age.min_age * 365)) + 1) / 365) <= $$visits_per_year.max$$
 and round(exp(avg(case when ca.EUPATH_0000092 > 0.0 then ln(ca.EUPATH_0000092) else ln(0.00000000000001) end)),1) >= $$parasite_density.min$$
 and round(exp(avg(case when ca.EUPATH_0000092 > 0.0 then ln(ca.EUPATH_0000092) else ln(0.00000000000001) end)),1) <= $$parasite_density.max$$
                ]]>   
        </sql>
     </sqlQuery>

     <sqlQuery name="ParticipantsByCharWizRelVis_prism"
          isCacheable="true">
       <paramRef ref="participantParams.geographic_region_prism" groupRef="metaDataGroups.geographic_loc"/>
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="D0ad509829e" groupRef="metaDataGroups.geographic_loc"/>
       <paramRef ref="clinicalVisitParams.visit_date" groupRef="metaDataGroups.daterange"/>
       <paramRef ref="participantParams.duration_observation" groupRef="metaDataGroups.daterange"/>  
       <paramRef ref="participantParams.visits_visitage_metadata_prism" groupRef="metaDataGroups.daterange"/>
       <paramRef ref="participantParams.participants_prism" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="participantParams.households_prism" groupRef="metaDataGroups.part_household_characteristics"/>
       <paramRef ref="participantParams.visits_prism" groupRef="metaDataGroups.part_visit_characteristics"/>
       <paramRef ref="clinicalVisitParams.use_relative_visits" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="clinicalVisitParams.days_between" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="clinicalVisitParams.date_direction_fv" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="clinicalVisitParams.dateOperator_fv" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="participantParams.relative_visits_prism" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="participantParams.parasite_density" groupRef="metaDataGroups.summary_params"/>
       <paramRef ref="participantParams.visits_per_year" groupRef="metaDataGroups.summary_params"/>
       <column name="source_id"/>
       <column name="project_id"/>
       <column name="ave_anoph"/>
       <column name="avg_hemo"/>
       <column name="avg_weight"/>
       <column name="ave_para_density"/>
       <column name="ave_age_visit"/>
       <column name="visit_count"/>
       <column name="visits_per_year_obs"/>
       <column name="time_of_obs"/>
         <sql>
           <![CDATA[
select pa.name, pa.name as source_id, '@PROJECT_ID@' as project_id, 
round(count(*) / ((least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EUPATH_0000032 + ( age.max_age * 365)) -
greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EUPATH_0000032 + ( age.min_age * 365)) + 1) / 365),1) as visits_per_year_obs,
                    round((least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EUPATH_0000032 + ( age.max_age * 365)) - 
       greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EUPATH_0000032 + ( age.min_age * 365)) + 1) / 365,1) as time_of_obs, 
                    count(*) as visit_count, mos.ave_anoph, 
   round(exp(avg(case when ca.EUPATH_0000092 > 0.0 then ln(ca.EUPATH_0000092) else ln(0.00000000000001) end)),1) as ave_para_density,
   round(avg(ca.EUPATH_0000113),1) as ave_age_visit,
   round(avg(ca.EUPATH_0000047),1) as avg_hemo,
   round(avg(ca.IAO_0000414),1) as avg_weight
from (select distinct io.input_pan_id,io.output_pan_id from ApidbTuning.$$tbl_prefix$$Observations ca, ApidbTuning.$$tbl_prefix$$PANIO io
      where ca.pan_id in ($$visits_prism$$)
      and ca.pan_id = io.output_pan_id
$$dateOperator_fv$$
 select distinct ioa.input_pan_id,ioa.output_pan_id
 from ApidbTuning.$$tbl_prefix$$Observations seta, ApidbTuning.$$tbl_prefix$$Observations setb, ApidbTuning.$$tbl_prefix$$PANIO ioa, ApidbTuning.$$tbl_prefix$$PANIO iob
 where seta.pan_id in ($$visits_prism$$)
and $$use_relative_visits$$ = 1
and setb.pan_id in ($$relative_visits_prism$$)
and seta.pan_id = ioa.output_pan_id
and setb.pan_id = iob.output_pan_id
and ioa.input_pan_id = iob.input_pan_id
and seta.pan_id != setb.pan_id
and setb.EUPATH_0000091 $$date_direction_fv$$ seta.EUPATH_0000091  
and abs(setb.EUPATH_0000091 - seta.EUPATH_0000091) >= $$days_between.min$$
and abs(setb.EUPATH_0000091 - seta.EUPATH_0000091) <= $$days_between.max$$
) main,
ApidbTuning.$$tbl_prefix$$Observations ca, ApidbTuning.$$tbl_prefix$$Participants pa,
   (select min(EUPATH_0000113) as min_age, max(EUPATH_0000113) as max_age
   from ApidbTuning.$$tbl_prefix$$Observations 
   where pan_id in ($$visits_visitage_metadata_prism$$)
   ) age,
   (select da.pan_id, round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as ave_anoph
  from ApidbTuning.$$tbl_prefix$$Households da, ApidbTuning.$$tbl_prefix$$PANIO io, ApidbTuning.$$tbl_prefix$$LightTraps la
  where da.pan_id = io.input_pan_id
  and la.pan_id = io.output_pan_id
  and la.OBI_0001619 >= $$visit_date.min$$ 
  and la.OBI_0001619 <= $$visit_date.max$$ 
  group by da.pan_id) mos, ApidbTuning.$$tbl_prefix$$PANIO iom
where ca.pan_id = main.output_pan_id
and pa.pan_id = main.input_pan_id
and iom.output_pan_id = pa.pan_id
and iom.input_pan_id = mos.pan_id(+)
group by pa.name, pa.EUPATH_0000152, pa.EUPATH_0000032, pa.EUPATH_0000151,age.max_age,age.min_age,mos.ave_anoph 
having count(*) / ((least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EUPATH_0000032 + ( age.max_age * 365)) - 
       greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EUPATH_0000032 + ( age.min_age * 365)) + 1) / 365) >= $$visits_per_year.min$$
 and count(*) / ((least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EUPATH_0000032 + ( age.max_age * 365)) - 
       greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EUPATH_0000032 + ( age.min_age * 365)) + 1) / 365) <= $$visits_per_year.max$$
 and round(exp(avg(case when ca.EUPATH_0000092 > 0.0 then ln(ca.EUPATH_0000092) else ln(0.00000000000001) end)),1) >= $$parasite_density.min$$
 and round(exp(avg(case when ca.EUPATH_0000092 > 0.0 then ln(ca.EUPATH_0000092) else ln(0.00000000000001) end)),1) <= $$parasite_density.max$$
                ]]>   
        </sql>
     </sqlQuery>

     <sqlQuery name="ParticipantsByCharWizRelVis_maled"
          isCacheable="true">
       <paramRef ref="participantParams.geographic_region_maled" default="ISASimple_Gates_MAL-ED_stdm_tp_RSRC" groupRef="metaDataGroups.geographic_loc"/>
       <paramRef ref="participantParams.participants_nf_maled" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="participantParams.households_nf_maled" groupRef="metaDataGroups.part_household_characteristics"/>
       <paramRef ref="participantParams.visits_nf_maled" groupRef="metaDataGroups.part_event_characteristics"/>
       <paramRef ref="clinicalVisitParams.use_relative_visits" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.days_between" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.date_direction_fv" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.dateOperator_fv" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="clinicalVisitParams.relative_visits_nf_maled" groupRef="metaDataGroups.relative_events"/>
       <paramRef ref="participantParams.visit_count" groupRef="metaDataGroups.event_summary_params"/>
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="ISASimple_Gates_MAL-ED_stdm_tp_RSRC" groupRef="metaDataGroups.event_summary_params"/>
       <column name="source_id"/>
       <column name="project_id"/>
       <column name="ave_age_visit"/>
       <column name="visit_count"/>
         <sql>
           <![CDATA[
select pa.name, pa.name as source_id, '@PROJECT_ID@' as project_id, 
                    count(*) as visit_count, 
   round(avg(EUPATH_0000644),1) -1 as ave_age_visit
from (select distinct io.input_pan_id,io.output_pan_id,ca.EUPATH_0000644 from ApidbTuning.$$tbl_prefix$$Observations ca, ApidbTuning.$$tbl_prefix$$PANIO io
      where ca.pan_id in ($$visits_nf_maled$$)
      and ca.pan_id = io.output_pan_id
$$dateOperator_fv$$
 select ioa.input_pan_id,ioa.output_pan_id,seta.EUPATH_0000644
 from ApidbTuning.$$tbl_prefix$$Observations seta, ApidbTuning.$$tbl_prefix$$Observations setb, ApidbTuning.$$tbl_prefix$$PANIO ioa, ApidbTuning.$$tbl_prefix$$PANIO iob
 where seta.pan_id in ($$visits_nf_maled$$)
and $$use_relative_visits$$ = 1
and setb.pan_id in ($$relative_visits_nf_maled$$)
and seta.pan_id = ioa.output_pan_id
and setb.pan_id = iob.output_pan_id
and ioa.input_pan_id = iob.input_pan_id
and seta.pan_id != setb.pan_id
and setb.EUPATH_0000644 $$date_direction_fv$$ seta.EUPATH_0000644  
and abs(setb.EUPATH_0000644 - seta.EUPATH_0000644) >= $$days_between.min$$
and abs(setb.EUPATH_0000644 - seta.EUPATH_0000644) <= $$days_between.max$$
group by ioa.input_pan_id,ioa.output_pan_id,seta.EUPATH_0000644
) main, ApidbTuning.$$tbl_prefix$$Participants pa
where pa.pan_id = main.input_pan_id
group by pa.name 
having count(*) >= $$visit_count.min$$
and count(*) <= $$visit_count.max$$
                ]]>   
        </sql>
     </sqlQuery>

     <sqlQuery name="ParticipantsByCaseControl_gems"
          isCacheable="true">
       <paramRef ref="participantParams.geographic_region_gems" groupRef="metaDataGroups.geographic_loc"/>
       <paramRef ref="participantParams.case_control" groupRef="metaDataGroups.part_characteristics"/> 
       <paramRef ref="participantParams.participant_dwelling_gems" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="participantParams.event_gems" groupRef="metaDataGroups.part_event_characteristics"/>
       <paramRef ref="participantParams.use_rel_case_control" groupRef="metaDataGroups.relative_case_control"/>
       <paramRef ref="participantParams.keep_remove" groupRef="metaDataGroups.relative_case_control"/>
       <paramRef ref="participantParams.relative_event_gems" groupRef="metaDataGroups.relative_case_control"/>
       <paramRef ref="participantParams.return_case_control" groupRef="metaDataGroups.results_options"/>
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="D841A9F5259" groupRef="metaDataGroups.relative_case_control"/> 
       <column name="source_id"/>
       <column name="project_id"/>
         <sql>
           <![CDATA[
with core as (
select distinct name, EUPATH_0010049, EUPATH_0010375
from (
select distinct name, EUPATH_0010049, EUPATH_0010375 from ApidbTuning.$$tbl_prefix$$Participants
      where pan_id in ($$event_gems$$) -- (select pan_id from ApidbTuning.$$tbl_prefix$$Participants)
$$keep_remove$$
select distinct seta.name, seta.EUPATH_0010049, seta.EUPATH_0010375 from ApidbTuning.$$tbl_prefix$$Participants seta, ApidbTuning.$$tbl_prefix$$Participants setb
      where $$use_rel_case_control$$ = 1
      and setb.pan_id in ($$relative_event_gems$$)
      and seta.pan_id in ($$event_gems$$)
      and seta.EUPATH_0010049 = setb.EUPATH_0010049)
)
select name as source_id, '@PROJECT_ID@' as project_id from core
where 'selected' = $$return_case_control$$
UNION
select distinct pa.name as source_id, '@PROJECT_ID@' as project_id 
from core, ApidbTuning.$$tbl_prefix$$Participants pa
where 'caseid' = $$return_case_control$$
and core.EUPATH_0010049 = pa.EUPATH_0010049
/*
UNION
select distinct pa.name as source_id, '@PROJECT_ID@' as project_id 
from core, ApidbTuning.$$tbl_prefix$$Participants pa
where 'matching' = $$return_case_control$$
and core.EUPATH_0010049 = pa.EUPATH_0010049
and core.EUPATH_0010375 != pa.EUPATH_0010375
*/
                ]]>   
        </sql>
     </sqlQuery>

     <sqlQuery name="ParticipantsByCaseControlShort_gems"
          isCacheable="true">
       <paramRef ref="participantParams.case_control" groupRef="metaDataGroups.choose_case_control"/> 
       <paramRef ref="participantParams.all_data_gems" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="clinicalVisitParams.use_relative_visits" groupRef="metaDataGroups.relative_case_control"/>
       <paramRef ref="clinicalVisitParams.dateOperator_fv" groupRef="metaDataGroups.relative_case_control"/>
       <paramRef ref="participantParams.relative_event_gems" groupRef="metaDataGroups.relative_case_control"/>
       <paramRef ref="participantParams.return_case_control" groupRef="metaDataGroups.results_options"/>
       <paramRef ref="participantParams.tbl_prefix" visible="false" default="ISASimple_Gates_GEMS_gems1_case_control_RSRC" groupRef="metaDataGroups.relative_case_control"/> 
       <column name="source_id"/>
       <column name="project_id"/>
         <sql>
           <![CDATA[
with core as (
select distinct name, EUPATH_0010049, EUPATH_0010375
from (
select distinct name, EUPATH_0010049, EUPATH_0010375 from ApidbTuning.$$tbl_prefix$$Participants
      where pan_id in ($$all_data_gems$$) -- (select pan_id from ApidbTuning.$$tbl_prefix$$Participants)
$$dateOperator_fv$$
select distinct seta.name, seta.EUPATH_0010049, seta.EUPATH_0010375 from ApidbTuning.$$tbl_prefix$$Participants seta, ApidbTuning.$$tbl_prefix$$Participants setb
      where $$use_relative_visits$$ = 1
      and setb.pan_id in ($$relative_event_gems$$)
      and seta.pan_id in ($$all_data_gems$$)
      and seta.EUPATH_0010049 = setb.EUPATH_0010049)
)
select name as source_id, '@PROJECT_ID@' as project_id from core
where 'selected' = $$return_case_control$$
UNION
select distinct pa.name as source_id, '@PROJECT_ID@' as project_id 
from core, ApidbTuning.$$tbl_prefix$$Participants pa
where 'caseid' = $$return_case_control$$
and core.EUPATH_0010049 = pa.EUPATH_0010049
/*
UNION
select distinct pa.name as source_id, '@PROJECT_ID@' as project_id 
from core, ApidbTuning.$$tbl_prefix$$Participants pa
where 'matching' = $$return_case_control$$
and core.EUPATH_0010049 = pa.EUPATH_0010049
and core.EUPATH_0010375 != pa.EUPATH_0010375
*/
                ]]>   
        </sql>
    </sqlQuery>
    
<!-- transform(s) -->

    <sqlQuery name="ParticipantsByHouseholdIds" doNotTest="true"  includeProjects="ICEMR"
              displayName="ID" isCacheable="true">
      <paramRef ref="householdParams.household_result"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="household"/>
        <column name="wdk_weight"/>

        <sql>
            <![CDATA[
SELECT   pa.name as source_id , '@PROJECT_ID@' as project_id, da.name as household, wdk_weight
              FROM ($$household_result$$) source_set, ApidbTuning.$$tbl_prefix$$PANIO io, ApidbTuning.$$tbl_prefix$$Households da, ApidbTuning.$$tbl_prefix$$Participants pa
              WHERE source_set.source_id = da.name 
              AND da.pan_id = io.input_pan_id
              AND  io.output_pan_id = pa.pan_id
             ]]>
        </sql>
    </sqlQuery>
    
      <sqlQuery name="ParticipantsByClinicalVisits" doNotTest="true" includeProjects="ICEMR"
              displayName="ID" isCacheable="true">
      <paramRef ref="clinicalVisitParams.clinical_visit_result"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="num_of_visits"/>
        <column name="wdk_weight"/>

        <sql>
            <![CDATA[
SELECT   pa.name as source_id , '@PROJECT_ID@' as project_id, count(*) as num_of_visits , max(source_set.wdk_weight) as wdk_weight
              FROM ($$clinical_visit_result$$) source_set, ApidbTuning.$$tbl_prefix$$PANIO io, ApidbTuning.$$tbl_prefix$$Observations cva, ApidbTuning.$$tbl_prefix$$Participants pa
              WHERE source_set.source_id = cva.name 
              AND cva.pan_id = io.output_pan_id
              AND  io.input_pan_id = pa.pan_id
              GROUP BY pa.name
             ]]>
        </sql>
    </sqlQuery>
                   

  </querySet>
</wdkModel>
