<wdkModel>

  <!-- notes

  -->

  <querySet name="DwellingId" queryType="id" isCacheable="false" excludeProjects="TrichDB">

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Source id  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->


    <sqlQuery name="DwellingsBySourceID"
	      isCacheable="true">
      <paramRef ref="dwellingParams.dwellingsBySourceID" />
      <column name="source_id" />
      <column name="project_id" />
      <sql>

	<![CDATA[select distinct da.source_id, '@project_id@' as project_id from APIDBTUNING.DWELLINGATTRIBUTES da,
        ($$dwellingsBySourceID$$) ds WHERE da.source_id=ds.source_id]]>
      </sql>
      
    </sqlQuery>


    <!--sqlQuery name="DwellingsByMetadataCrossOld"
         isCacheable="true">
      <paramRef ref="participantParams.start_date"/>
      <paramRef ref="participantParams.end_date"/>
      <paramRef ref="participantParams.participants_by_metadata"/>
      <paramRef ref="dwellingParams.dwellings_by_metadata"/>
      <paramRef ref="participantParams.min_anoph"/>
      <paramRef ref="participantParams.max_anoph"/>
      <paramRef ref="clinicalVisitParams.visits_by_metadata"/>
      <paramRef ref="participantParams.min_visits"/>
      <paramRef ref="participantParams.max_visits"/>
      <paramRef ref="participantParams.min_para_density"/>
      <paramRef ref="participantParams.max_para_density"/>
      <column name="source_id"/>
      <column name="ave_visits"/>
      <column name="ave_anoph"/>
      <column name="num_persons"/>
      <column name="ave_para_density"/>
        <sql>
          <![CDATA[
select lt.dwelling_id as source_id,lt.ave_anoph, count(*) as num_persons, round(avg(ave_para_density),1) as ave_para_density, round(avg(num_visits),1) as ave_visits
from (select da.source_id as dwelling_id,round(avg(gravidgambie + fedgamb + gambiaeunableassess + unfedgamb),1) as ave_anoph, count(*) as num_collections 
       from apidbtuning.lighttrapattributes lta, apidbtuning.dwellingattributes da
       where da.source_id in ($$dwellings_by_metadata$$) 
       and da.source_id = lta.parent_id(+)
       and lta.collection_date(+) >= to_date($$start_date$$)
       and lta.collection_date(+) <= to_date($$end_date$$)
       group by da.source_id
       having nvl(round(avg(lta.gravidgambie(+) + lta.fedgamb(+) + lta.gambiaeunableassess(+) + lta.unfedgamb(+)),1),0) >= $$min_anoph$$ 
          and nvl(round(avg(lta.gravidgambie(+) + lta.fedgamb(+) + lta.gambiaeunableassess(+) + lta.unfedgamb(+)),1),0) <= $$max_anoph$$ ) lt,
(select pa.source_id as person_id, pa.parent_id, count(*) as num_visits, round(avg(ca.Parasite_density_in_count_per),1) as ave_para_density

from APIDBTUNING.PERSONATTRIBUTES pa, apidbtuning.clinicalvisitattributes ca
where pa.source_id in ($$participants_by_metadata$$)
and ca.source_id in ($$visits_by_metadata$$)
and ca.parent_id = pa.source_id
and ca.visit_date >= to_date($$start_date$$)
and ca.visit_date <= to_date($$end_date$$)
group by pa.source_id, pa.parent_id
having count(*) >= $$min_visits$$
and count(*) <= $$max_visits$$
and avg(Parasite_density_in_count_per) >= $$min_para_density$$
and avg(Parasite_density_in_count_per) <= $$max_para_density$$) per
where lt.dwelling_id = per.parent_id
group by lt.dwelling_id, lt.ave_anoph
               ]]>   
       </sql>
    </sqlQuery-->



    <sqlQuery name="DwellingsByMetadataCross"
         isCacheable="true">
      <paramRef ref="participantParams.start_date"/>
      <paramRef ref="participantParams.end_date"/>
      <paramRef ref="dwellingParams.dwellings_by_all_metadata"/>
      <paramRef ref="participantParams.min_anoph"/>
      <paramRef ref="participantParams.max_anoph"/>
      <column name="source_id"/>
      <column name="project_id"/>
      <column name="ave_num_anoph"/>
      <column name="start_date"/>
      <column name="end_date"/>

        <sql>
          <![CDATA[
                   select da.source_id, '@project_id@' as project_id, round(avg(SUM_FEMALE_AS_IN_A_COLLECTION),1) as ave_num_anoph,
                   $$start_date$$ as start_date, $$end_date$$ as end_date
                   from apidbtuning.lighttrapattributes lta, apidbtuning.dwellingattributes da
                   where da.source_id in  ($$dwellings_by_all_metadata$$)  
                   and da.source_id = lta.parent_id(+)
                   and lta.collection_date(+) >= to_date($$start_date$$, 'DD-MON-YYYY')
                   and lta.collection_date(+) <= to_date($$end_date$$, 'DD-MON-YYYY')
                   group by da.source_id, da.subcounty_in_uganda
                   having nvl(round(avg(lta.SUM_FEMALE_AS_IN_A_COLLECTION(+)),1),0) >= $$min_anoph$$ 
                   and nvl(round(avg(lta.SUM_FEMALE_AS_IN_A_COLLECTION(+)),1),0) <= $$max_anoph$$ 
          ]]>   
       </sql>
    </sqlQuery>                



<!-- transform(s) -->

    <sqlQuery name="DwellingsByParticipantIds" doNotTest="true"
              displayName="ID" isCacheable="true">
      <paramRef ref="participantParams.participant_result"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="participants"/>
        <column name="participant_count"/>
        <column name="wdk_weight"/>

        <sql>
            <![CDATA[
              SELECT DISTINCT pana.node_source_id as source_id , '@PROJECT_ID@' as project_id,  count(distinct source_set.source_id) as participant_count,
                listagg (pana.associated_node_source_id, ',') WITHIN GROUP (order by pana.associated_node_source_id )  as participants, max(source_set.wdk_weight) as wdk_weight
              FROM ($$participant_result$$) source_set, ApidbTuning.PANAssociations pana
              WHERE source_set.source_id = pana.associated_node_source_id AND associated_node_type='person' and node_type = 'dwelling'
              GROUP BY pana.node_source_id
             ]]>
        </sql>
    </sqlQuery>

     <sqlQuery name="DwellingsByLightTrapIds" doNotTest="true"
              displayName="ID" isCacheable="true">
      <paramRef ref="lighttrapParams.lighttrap_result"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="wdk_weight"/>

        <sql>
            <![CDATA[
              SELECT DISTINCT pana.node_source_id as source_id , '@PROJECT_ID@' as project_id, max(source_set.wdk_weight) as wdk_weight
              FROM ($$lighttrap_result$$) source_set, ApidbTuning.PANAssociations pana
              WHERE source_set.source_id = pana.associated_node_source_id AND associated_node_type='light_trap_data' and node_type = 'dwelling'
              GROUP BY pana.node_source_id
             ]]>
        </sql>
    </sqlQuery>
 
  </querySet>
</wdkModel>
