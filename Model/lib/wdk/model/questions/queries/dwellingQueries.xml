<wdkModel>

  <!-- notes

  -->

  <querySet name="DwellingId" queryType="id" isCacheable="false" excludeProjects="TrichDB">

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Source id  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->


    <sqlQuery name="DwellingsBySourceID"
	      isCacheable="true">
      <paramRef ref="dwellingParams.dwellingsBySourceID" />
      <column name="source_id" />
      <column name="project_id" />
      <sql>

	<![CDATA[select distinct da.source_id, '@project_id@' as project_id from APIDBTUNING.DWELLINGATTRIBUTES da,
        ($$dwellingsBySourceID$$) ds WHERE da.source_id=ds.source_id]]>
      </sql>
      
    </sqlQuery>



<!-- transform(s) -->

    <sqlQuery name="DwellingsByParticipantIds" doNotTest="true"
              displayName="ID" isCacheable="true">
      <paramRef ref="participantParams.participant_result"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="participants"/>
        <column name="participant_count"/>
        <column name="wdk_weight"/>

        <sql>
            <![CDATA[
              SELECT DISTINCT pana.node_source_id as source_id , '@PROJECT_ID@' as project_id,  count(distinct source_set.source_id) as participant_count,
                listagg (pana.associated_node_source_id, ',') WITHIN GROUP (order by pana.associated_node_source_id )  as participants, max(source_set.wdk_weight) as wdk_weight
              FROM ($$participant_result$$) source_set, ApidbTuning.PANAssociations pana
              WHERE source_set.source_id = pana.associated_node_source_id AND associated_node_type='person' and node_type = 'dwelling'
              GROUP BY pana.node_source_id
             ]]>
        </sql>
    </sqlQuery>

     <sqlQuery name="DwellingsByLightTrapIds" doNotTest="true"
              displayName="ID" isCacheable="true">
      <paramRef ref="lighttrapParams.lighttrap_result"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="wdk_weight"/>

        <sql>
            <![CDATA[
              SELECT DISTINCT pana.node_source_id as source_id , '@PROJECT_ID@' as project_id, max(source_set.wdk_weight) as wdk_weight
              FROM ($$lighttrap_result$$) source_set, ApidbTuning.PANAssociations pana
              WHERE source_set.source_id = pana.associated_node_source_id AND associated_node_type='light_trap_data' and node_type = 'dwelling'
              GROUP BY pana.node_source_id
             ]]>
        </sql>
    </sqlQuery>
 
  </querySet>
</wdkModel>
