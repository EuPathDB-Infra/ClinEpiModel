<wdkModel>

  <!-- notes

  -->

  <querySet name="ClinicalVisitId" queryType="id" isCacheable="false" excludeProjects="TrichDB">

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Source id  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->



      <sqlQuery name="ClinicalVisitsBySourceID"
         isCacheable="true">
     <!-- <paramRef ref="participantParams.participantsBySourceID"/> -->
      <paramRef ref="clinicalVisitParams.clinical_visits_by_sourceid"/>
      <column name="source_id"/>
      <column name="project_id"/>
     <sql>
          <![CDATA[
Select distinct cv.source_id, '@PROJECT_ID@' as project_id from  APIDBTUNING.CLINICALVISITATTRIBUTES cv,
($$clinical_visits_by_sourceid$$) cs where cv.source_id = cs.source_id
               ]]>   
       </sql>
    </sqlQuery>



<!--
       <sqlQuery name="VisitByRelativeDate"
         isCacheable="true">
      <paramRef ref="clinicalVisitParams.minAgeAtVisit" groupRef="metaDataGroups.age_at_visit"/>
      <paramRef ref="clinicalVisitParams.maxAgeAtVisit" groupRef="metaDataGroups.age_at_visit"/>
      <paramRef ref="participantParams.start_date" groupRef="metaDataGroups.daterange"/>
      <paramRef ref="participantParams.end_date" groupRef="metaDataGroups.daterange"/>
      <paramRef ref="participantParams.duration_observation" groupRef="metaDataGroups.daterange"/>  
      <paramRef ref="participantParams.participants_by_all_metadata" groupRef="metaDataGroups.visit_part_characteristics"/>
      <paramRef ref="clinicalVisitParams.visits_by_metadata" groupRef="metaDataGroups.visit_visit_characteristics"/>
      <paramRef ref="clinicalVisitParams.minDaysBetween" groupRef="metaDataGroups.relative_visits"/>
      <paramRef ref="clinicalVisitParams.maxDaysBetween" groupRef="metaDataGroups.relative_visits"/>
      <paramRef ref="clinicalVisitParams.date_direction" groupRef="metaDataGroups.relative_visits"/>
      <paramRef ref="clinicalVisitParams.dateOperator" groupRef="metaDataGroups.relative_visits"/>
      <paramRef ref="clinicalVisitParams.visits_by_metadata_2" groupRef="metaDataGroups.relative_visits"/>
      <column name="source_id"/>
      <column name="project_id"/>
      <column name="visit_date"/>
      <column name="participant_id"/>
      <column name="min_days_between"/>
      <column name="num_matching_visits"/>
        <sql>
          <![CDATA[
select source_id,parent_id as participant_id,visit_date,CASE when min(days_between) > 0 then min(days_between) else null end as min_days_between,CASE WHEN'$$dateOperator$$' = 'MINUS' THEN null else count(*) end as num_matching_visits
from (
select visits.source_id,visits.parent_id,visits.visit_date, abs(setb.visit_date - visits.visit_date) as days_between
from (
select ca.source_id, ca.parent_id ,ca.visit_date 
from APIDBTUNING.CLINICALVISITATTRIBUTES ca, apidbtuning.personattributes pa
where ca.source_id in ($$visits_by_metadata$$)
and ca.parent_id = pa.source_id
and pa.source_id in ($$participants_by_all_metadata$$)
$$dateOperator$$ 
select seta.source_id,seta.parent_id,seta.visit_date
from APIDBTUNING.CLINICALVISITATTRIBUTES seta, APIDBTUNING.CLINICALVISITATTRIBUTES setb
where seta.source_id in ($$visits_by_metadata$$)
and setb.source_id in ($$visits_by_metadata_2$$)
and seta.parent_id = setb.parent_id
and seta.source_id != setb.source_id
and setb.visit_date $$date_direction$$ seta.visit_date
and abs(setb.visit_date - seta.visit_date) >= $$minDaysBetween$$
and abs(setb.visit_date - seta.visit_date) <= $$maxDaysBetween$$) visits, 
APIDBTUNING.CLINICALVISITATTRIBUTES setb
where ('$$dateOperator$$' = 'MINUS'
and setb.source_id in ($$visits_by_metadata$$)
and setb.source_id = visits.source_id )
or (setb.source_id in ($$visits_by_metadata_2$$)
and visits.parent_id = setb.parent_id
and visits.source_id != setb.source_id
and setb.visit_date $$date_direction$$ visits.visit_date
and abs(setb.visit_date - visits.visit_date) >= $$minDaysBetween$$
and abs(setb.visit_date - visits.visit_date) <= $$maxDaysBetween$$)
)
group by source_id,parent_id,visit_date
               ]]>   
       </sql>
    </sqlQuery>                
-->
     <sqlQuery name="ClinicalVisitsByRelativeVisits"
          isCacheable="true">
       <paramRef ref="participantParams.geographic_region" groupRef="metaDataGroups.geographic_loc"/>
       <paramRef ref="participantParams.start_date" groupRef="metaDataGroups.daterange"/>
       <paramRef ref="participantParams.end_date" groupRef="metaDataGroups.daterange"/>
       <paramRef ref="participantParams.duration_observation" groupRef="metaDataGroups.daterange"/>  
       <paramRef ref="clinicalVisitParams.visits_visitage_metadata_nf" groupRef="metaDataGroups.age_at_visit"/>
       <paramRef ref="participantParams.dwellings_nf" groupRef="metaDataGroups.part_dwelling_characteristics"/>
       <paramRef ref="participantParams.participants_nf" groupRef="metaDataGroups.part_characteristics"/>
       <paramRef ref="clinicalVisitParams.visits_nf" groupRef="metaDataGroups.part_visit_characteristics"/>
       <paramRef ref="clinicalVisitParams.use_relative_visits" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="clinicalVisitParams.minDaysBetween" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="clinicalVisitParams.maxDaysBetween" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="clinicalVisitParams.date_direction_fv" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="clinicalVisitParams.dateOperator_fv" groupRef="metaDataGroups.relative_visits"/>
       <paramRef ref="clinicalVisitParams.relative_visits_nf" groupRef="metaDataGroups.relative_visits"/>
       <column name="source_id"/>
       <column name="project_id"/>
       <column name="min_days_between"/>
       <column name="num_matching_visits"/> 
       <sql>
           <![CDATA[
select name as source_id,'ClinEpiDB' as project_id,
CASE when min(days_between) > 0 then min(days_between) else null end as min_days_between,CASE WHEN '$$dateOperator_fv$$' = 'MINUS' THEN null else count(*) end as num_matching_visits
from (
select visits.protocol_app_node_id,visits.name,visits.input_node_id as parent_id,visits.EUPATH_0000091, abs(setb.EUPATH_0000091 - visits.EUPATH_0000091) as days_between
from (
select ca.protocol_app_node_id, ca.name, io.input_node_id ,ca.EUPATH_0000091 
from APIDBTUNING.CLINICALVISITATTRIBUTES ca,apidbtuning.protocolappnodeio io
where ca.protocol_app_node_id in ($$visits_nf$$)
and ca.protocol_app_node_id = io.output_node_id
$$dateOperator_fv$$
select seta.protocol_app_node_id,seta.name, ioa.input_node_id,seta.EUPATH_0000091
from APIDBTUNING.CLINICALVISITATTRIBUTES seta, APIDBTUNING.CLINICALVISITATTRIBUTES setb,
    apidbtuning.protocolappnodeio ioa, apidbtuning.protocolappnodeio iob
where seta.protocol_app_node_id in ($$visits_nf$$)
and $$use_relative_visits$$ = 1
and setb.protocol_app_node_id in ($$relative_visits_nf$$)
and seta.protocol_app_node_id = ioa.output_node_id
and setb.protocol_app_node_id = iob.output_node_id
and ioa.input_node_id = iob.input_node_id
and seta.protocol_app_node_id != setb.protocol_app_node_id
and setb.EUPATH_0000091 $$date_direction_fv$$ seta.EUPATH_0000091
and abs(setb.EUPATH_0000091 - seta.EUPATH_0000091) >= $$minDaysBetween$$
and abs(setb.EUPATH_0000091 - seta.EUPATH_0000091) <= $$maxDaysBetween$$) visits, 
APIDBTUNING.CLINICALVISITATTRIBUTES setb, apidbtuning.protocolappnodeio iob
where ('$$dateOperator_fv$$' = 'MINUS'
and setb.protocol_app_node_id in ($$visits_nf$$)
and setb.protocol_app_node_id = visits.protocol_app_node_id )
or (setb.protocol_app_node_id in ($$relative_visits_nf$$)
and visits.input_node_id = iob.input_node_id
and setb.protocol_app_node_id = iob.output_node_id
and visits.protocol_app_node_id != setb.protocol_app_node_id
and setb.EUPATH_0000091 $$date_direction_fv$$ visits.EUPATH_0000091
and abs(setb.EUPATH_0000091 - visits.EUPATH_0000091) >= $$minDaysBetween$$
and abs(setb.EUPATH_0000091 - visits.EUPATH_0000091) <= $$maxDaysBetween$$)
)
group by name,parent_id,EUPATH_0000091
                ]]>   
        </sql>
     </sqlQuery>

       
       <sqlQuery name="VisitsByParticipantIds" doNotTest="true" displayName="ID"
         isCacheable="true">
      <paramRef ref="participantParams.participant_result"/>
      <column name="project_id"/>
      <column name="source_id"/>     
      <column name="participant"/>
      <column name="wdk_weight"/>

        <sql>
          <![CDATA[
          SELECT DISTINCT pana.associated_node_source_id as source_id, '@PROJECT_ID@' as project_id,pana.node_source_id as participant,wdk_weight
          FROM ($$participant_result$$) source_set , ApidbTuning.panassociations pana
          WHERE source_set.source_id = pana.node_source_id AND node_type='person' AND associated_node_type='clinical_visit_data'
         
               ]]>   
       </sql>
    </sqlQuery>                
          
  </querySet>
</wdkModel>

