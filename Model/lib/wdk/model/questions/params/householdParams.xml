<wdkModel>

  <paramSet name="householdParams">
    
    <enumParam name="type"
               prompt="type"
               multiPick="false"
               quote="true"
               visible="false">
      <help>this is internal</help>
      <enumList>
        <enumValue default="true">
          <term>household</term>
          <internal>household</internal>
        </enumValue>
      </enumList>
    </enumParam>

       <dateRangeParam name="date_range"
                       prompt="Choose start and end dates "
                       minDate="2011-08-01"
                       maxDate="2017-09-30">
         <help>"select the earliest and latest dates to include for computing mosquito counts."</help>
<!--         <suggest default="{'min': '2011-08-05', 'max': '2016-06-30'}" />  -->

       </dateRangeParam>    

    <filterParam name="households_prism" 
                    ontologyQueryRef="ParticipantVQ.HouseholdOntology_prism"
                    metadataQueryRef="HouseholdVQ.HouseholdMetaData_prism"
                    backgroundQueryRef="HouseholdVQ.HouseholdMetaDataBkgd_prism"
                    prompt="Households"
                    countPredictsAnswerCount="true"
                    trimMetadataTerms="false"
                    dependedParamRef="participantParams.tbl_prefix,householdParams.geographic_region_prism,householdParams.date_range">
      <help>
        Select participants based on their characteristics. 
      </help>
    </filterParam>

     <filterParam name="geographic_region_prism" 
                    ontologyQueryRef="ParticipantVQ.RegionOntology_prism"
                    metadataQueryRef="HouseholdVQ.RegionMetaData_prism"
                    backgroundQueryRef="HouseholdVQ.RegionMetaData_prism"
                    prompt="Geographic Region"
                    filterDataTypeDisplayName="Households"
                    countPredictsAnswerCount="true"
                    dependedParamRef="participantParams.tbl_prefix"
                    trimMetadataTerms="false">
      <help>
        Select dwellngs based on geographic region. 
      </help>
    </filterParam>          

    <filterParam name="participants_prism" 
                      ontologyQueryRef="ParticipantVQ.ParticipantOntology_prism"
                      metadataQueryRef="HouseholdVQ.ParticipantMetaData_prism"
                      backgroundQueryRef="HouseholdVQ.ParticipantMetaDataBkgd_prism"
                      prompt="Participants"
                      countPredictsAnswerCount="true"
                      trimMetadataTerms="false"
                      dependedParamRef="participantParams.tbl_prefix,householdParams.households_prism">
         <help>
              Select participants based on their characteristics. 
         </help>
       </filterParam>

    <!--************************************************************-->
    <!--   india ICEMR section ... should be injected  -->
    <!--************************************************************-->

       <filterParam name="geographic_region_india" 
                       metadataQueryRef="HouseholdVQ.RegionMetaData_india"
                       backgroundQueryRef="HouseholdVQ.RegionMetaData_india"
                       ontologyQueryRef="ParticipantVQ.RegionOntology_india"
                       countPredictsAnswerCount="true"
                       filterDataTypeDisplayName="Households"
                       prompt="Geographic region"
                       dependedParamRef="participantParams.tbl_prefix"
                       trimMetadataTerms="false">
         <help>
           Select participants based on their geographic region. 
         </help>
    </filterParam>

    <filterParam name="households_india" 
                       metadataQueryRef="HouseholdVQ.HouseholdMetaData_india"
                       backgroundQueryRef="HouseholdVQ.HouseholdMetaDataBkgd_india"
                       ontologyQueryRef="ParticipantVQ.HouseholdOntology_india"
                       countPredictsAnswerCount="true"
                       filterDataTypeDisplayName="Households"
                       prompt="Households"
                       dependedParamRef="participantParams.tbl_prefix,householdParams.geographic_region_india"
                       trimMetadataTerms="false">
         <help>
           Select participants based on their geographic region. 
         </help>
    </filterParam>

       <filterParam name="participants_india" 
                      metadataQueryRef="HouseholdVQ.ParticipantMetaData_india"
                      ontologyQueryRef="ParticipantVQ.ParticipantOntology_india"
                      backgroundQueryRef="HouseholdVQ.ParticipantMetaDataBkgd_india"
                      countPredictsAnswerCount="true"
                      filterDataTypeDisplayName="Participants"
                      prompt="Personal characteristics"
                      trimMetadataTerms="false"
                      dependedParamRef="participantParams.tbl_prefix,householdParams.households_india">
         <help>
              Select participants based on their characteristics. 
         </help>
       </filterParam>



    <!-- TEMPLATE_ANCHOR householdSourceIdParam -->


    <!-- TEMPLATE_ANCHOR householdResultParam -->

 <enumParam name="district"
               prompt="Study site "
               multiPick="true"
               quote="true"
               visible="true">
      <help>Choose the study sites (districts) for your search.</help>
      <enumList>
        <enumValue default="true">
          <term>Tororo</term>
          <internal>tororo</internal>
        </enumValue>
        <enumValue default="true">
          <term>Kanungu</term>
          <internal>kanungu</internal>
        </enumValue>  
        <enumValue default="true">
          <term>Jinja</term>
          <internal>jinja</internal>
        </enumValue>  
      </enumList>
    </enumParam>

  </paramSet>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!--  Vocab queries-->  
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

 <querySet name="HouseholdVQ" queryType="vocab" isCacheable="true">

   <sqlQuery name="RegionMetaData_prism" isCacheable="false" >
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct m.pan_id as internal,  m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, ApidbTuning.$$tbl_prefix$$Households h
 where m.property_source_id = 'EUPATH_0000054'
 and m.pan_id = h.pan_id
        ]]>
      </sql>
    </sqlQuery>


    <sqlQuery name="HouseholdMetaData_prism" isCacheable="true">
      <paramRef ref="householdParams.date_range" />  
      <paramRef ref="householdParams.geographic_region_prism" />  
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
with mos as (
 select da.pan_id as internal, 'average anopheles' as ontology_term_name, null as string_value, 
   round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as number_value, null as date_value
  from ApidbTuning.$$tbl_prefix$$Households da, ApidbTuning.$$tbl_prefix$$PANIO io, ApidbTuning.$$tbl_prefix$$LightTraps la
  where da.pan_id in ($$geographic_region_prism$$)
  and da.pan_id = io.input_pan_id
  and la.pan_id = io.output_pan_id
  and EUPATH_0020003 >= $$date_range.min$$
  and EUPATH_0020003 <= $$date_range.max$$ 
  group by da.pan_id
  )
select distinct m.pan_id as internal,  m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, mos
 where m.pan_id in ($$geographic_region_prism$$)
 and m.pan_id = mos.internal
 union 
 select * from mos
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="HouseholdMetaDataBkgd_prism" isCacheable="true">
      <paramRef ref="householdParams.date_range" />  
      <paramRef ref="householdParams.geographic_region_prism" />  
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.pan_id as internal, property_source_id as ontology_term_name, string_value, number_value, date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m
 where m.category = 'Household'
 union
 select da.pan_id as internal,  'average anopheles' as ontology_term_name, null as string_value, 
   round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as number_value, null as date_value
  from ApidbTuning.$$tbl_prefix$$Households da, ApidbTuning.$$tbl_prefix$$PANIO io, ApidbTuning.$$tbl_prefix$$LightTraps la
  where da.pan_id = io.input_pan_id
  and la.pan_id = io.output_pan_id
  group by da.pan_id
          ]]>
    </sql>
    </sqlQuery>

   <sqlQuery name="ParticipantMetaData_prism" isCacheable="true">
     <paramRef ref="householdParams.households_prism" />  
     <paramRef ref="participantParams.tbl_prefix" />  
     <column name="ontology_term_name"/>
     <column name="internal"/>
     <column name="record_id"/>
     <column name="number_value"/>
     <column name="date_value"/>
     <column name="string_value"/>
     <sql>
         <![CDATA[
select distinct m.pan_id as internal, io.input_pan_id as record_id, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m, ApidbTuning.$$tbl_prefix$$PANIO io
 where io.input_pan_id in ($$households_prism$$)
 and io.output_pan_type_source_id = 'EUPATH_0000096'
 and m.pan_id = io.output_pan_id
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="ParticipantMetaDataBkgd_prism" isCacheable="true">
     <paramRef ref="participantParams.tbl_prefix" />  
     <column name="ontology_term_name"/>
     <column name="internal"/>
     <column name="record_id"/>
     <column name="number_value"/>
     <column name="date_value"/>
     <column name="string_value"/>
     <sql>
         <![CDATA[
select distinct m.pan_id as internal, io.input_pan_id as record_id, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m, ApidbTuning.$$tbl_prefix$$PANIO io
 where io.output_pan_type_source_id = 'EUPATH_0000096'
 and io.input_pan_type_source_id = 'PCO_0000024'
 and m.pan_id = io.output_pan_id
          ]]>
    </sql>
    </sqlQuery>

    <!--************************************************************-->
    <!--   india ICEMR section ... should be injected  -->
    <!--************************************************************-->

    <sqlQuery name="RegionMetaData_india" isCacheable="false">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select  household_id as internal, ontology_term_name, string_value, number_value, date_value
from ApidbTuning.$$tbl_prefix$$HouseholdMD
where ontology_term_name in ('EUPATH_0000452','EUPATH_0000407')
        ]]>
      </sql>
    </sqlQuery>

   <sqlQuery name="HouseholdMetaData_india" isCacheable="false">
     <paramRef ref="participantParams.tbl_prefix" />  
     <paramRef ref="householdParams.geographic_region_india" />  
     <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select  household_id as internal, ontology_term_name, string_value, number_value, date_value
from ApidbTuning.$$tbl_prefix$$HouseholdMD
where household_id in ($$geographic_region_india$$)
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="HouseholdMetaDataBkgd_india" isCacheable="false">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select  household_id as internal, ontology_term_name, string_value, number_value, date_value
from ApidbTuning.$$tbl_prefix$$HouseholdMD
          ]]>
    </sql>
    </sqlQuery>

   <sqlQuery name="ParticipantMetaData_india" isCacheable="false">
     <paramRef ref="participantParams.tbl_prefix" />  
     <paramRef ref="householdParams.households_india" />  
     <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="record_id"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select  household_id as record_id, participant_id as internal, ontology_term_name, string_value, number_value, date_value
from ApidbTuning.$$tbl_prefix$$ParticipantMD
where household_id in ($$households_india$$)
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="ParticipantMetaDataBkgd_india" isCacheable="false">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="record_id"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select  household_id as record_id, participant_id as internal, ontology_term_name, string_value, number_value, date_value
from ApidbTuning.$$tbl_prefix$$ParticipantMD
          ]]>
    </sql>
    </sqlQuery>


 </querySet>

</wdkModel>
