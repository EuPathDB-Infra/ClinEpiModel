<wdkModel>

  <paramSet name="clinicalVisitParams">
    
    <enumParam name="type"
               prompt="type"
               multiPick="false"
               quote="true"
               visible="false">
      <help>this is internal</help>
      <enumList>
        <enumValue default="true">
          <term>clinicalVisit</term>
          <internal>clinicalVisit</internal>
        </enumValue>
      </enumList>
    </enumParam>

        <datasetParam name="clinical_visits_by_sourceid" 
		  recordClassRef="ParticipantRecordClasses.ParticipantRecordClass"
		  prompt="Source ID input set">
      <help><![CDATA[Input a set of source IDs, or upload a file<br><br>

             It can be delimited by a comma, semi colon or any white space.<br><br>
             Its possible that not all the IDs in the list will be found in the database
             due to anumber of reasons such as unavailable ID mapping. It is currenly not
             possible to inform which IDs did not match anything in the database]]> </help>
     <suggest includeProjects="INIT" default="FILL" />
     <suggest default="100118844" />
      
    </datasetParam>

      <filterParamNew name="visits_by_metadata_nf" 
                      metadataQueryRef="ClinicalVisitVQ.ClinicalVisitMetadataNf"
                      ontologyQueryRef="ClinicalVisitVQ.ClinicalVisitOntologyNf"
                      prompt="ClinicalVisits"
                      dependedParamRef="clinicalVisitParams.minAgeAtVisit,clinicalVisitParams.maxAgeAtVisit,participantParams.start_date,participantParams.end_date,participantParams.duration_observation"
                      trimMetadataTerms="false">
         <help>
              Select reference samples. 
         </help>
       </filterParamNew>

    <filterParam name="visits_by_metadata"
                 queryRef="ClinicalVisitVQ.ClinicalVisits"
                 metadataQueryRef="ClinicalVisitVQ.ClinicalVisitMetadata"
                 metadataSpecQueryRef="ClinicalVisitVQ.NodeMetadataSpec"
                 prompt="ClinicalVisits"
                 multiPick="true"
                 quote="true"
                 dependedParamRef="clinicalVisitParams.minAgeAtVisit,clinicalVisitParams.maxAgeAtVisit,participantParams.start_date,participantParams.end_date,participantParams.duration_observation"
                 suppressNode="false">
         <help>
              Select clinical visits based on characteristics. 
         </help>
         <!-- <suggest selectMode="all" /> -->
       </filterParam>

    <filterParam name="visits_by_metadata_2"
                 queryRef="ClinicalVisitVQ.ClinicalVisits2"
                 metadataQueryRef="ClinicalVisitVQ.ClinicalVisitMetadata2"
                 metadataSpecQueryRef="ClinicalVisitVQ.NodeMetadataSpec"
                 prompt="ClinicalVisits to Compare"
                 multiPick="true"
                 quote="true"
                 suppressNode="false">
         <help>
              Select clinical visits based on characteristics.  These visits will be utilized to compare to the visits selected above based on your comparison criteria (days between and whether to keep or remove).
         </help>
         <!-- <suggest selectMode="all" /> -->
       </filterParam>

   <stringParam name="maxDaysBetween"
		 prompt="Max days between visits &lt;= "
		 number="true">
      <help>Specify the maximum number of days between visit to keep or remove and the following visit.</help>
      <suggest default="10"/>
      <regex>\d\d*</regex>
    </stringParam>

     <stringParam name="minDaysBetween"
		 prompt="Min days between visits &gt;= "
		 number="true">
      <help>Specify the minimum number of days between visit to keep or remove and the following visit.</help>
      <suggest default="1"/>
      <regex>\d\d*</regex>
    </stringParam>

   <stringParam name="minAgeAtVisit"
		 prompt="Age at visit &gt;= "
		 number="true">
      <help>Minimum age at time of visit.</help>
      <suggest default="0.5"/>
      <regex>\d\d*\.*\d*</regex>
    </stringParam>

   <stringParam name="maxAgeAtVisit"
		 prompt="Age at visit &lt;= "
		 number="true">
      <help>Maximum age at time of visit.</help>
      <suggest default="80"/>
      <regex>\d\d*\.*\d*</regex>
    </stringParam>

    <enumParam name="dateOperator"
               prompt="Keep or Remove visits "
               multiPick="false"
               quote="false"
               visible="true">
      <help>Choose how to compare these two visits.  Do you want to remove visits that have another visit within the specified time frame or keep them.</help>
      <enumList>
        <enumValue default="true">
          <term>remove</term>
          <internal>MINUS</internal>
        </enumValue>
        <enumValue>
          <term>keep</term>
          <internal>INTERSECT</internal>
        </enumValue>
      </enumList>
    </enumParam>

    <enumParam name="date_direction"
               prompt="Choose a direction "
               multiPick="false"
               quote="false"
               visible="true">
      <help>Choose a direction for the corresponding visit.  Will the matching visit be before or after relative to the first visit.</help>
      <enumList>
        <enumValue default="true">
          <term>after</term>
          <internal><![CDATA[>=]]></internal>
        </enumValue>
        <enumValue>
          <term>before</term>
          <internal><![CDATA[<=]]></internal>
        </enumValue>
      </enumList>
    </enumParam>

    <answerParam name="clinical_visit_result"
                  prompt="Input Result Set"
                  readonly="true"
                  visible="false">
       <recordClass ref="ClinicalVisitRecordClasses.ClinicalVisitRecordClass" />
    </answerParam>

  </paramSet>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!--  Vocab queries-->  
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

 <querySet name="ClinicalVisitVQ" queryType="vocab" isCacheable="true">
   <sqlQuery name="ClinicalVisits" excludeProjects="TrichDB,EuPathDB">
            <paramRef ref="clinicalVisitParams.minAgeAtVisit" />
            <paramRef ref="clinicalVisitParams.maxAgeAtVisit" />
            <paramRef ref="participantParams.start_date" />
            <paramRef ref="participantParams.end_date" />
            <paramRef ref="participantParams.duration_observation" />  
            <column name="internal"/>
            <column name="term"/>
            <sql>
         <![CDATA[
          select 
         ca.source_id  as term,
         ca.source_id  as internal
         from ApidbTuning.ClinicalVisitAttributes ca, ApidbTuning.personAttributes pa,
         (select CASE WHEN round($$maxAgeAtVisit$$) = $$maxAgeAtVisit$$ 
            THEN $$maxAgeAtVisit$$ + 0.99
            ELSE $$maxAgeAtVisit$$
            END as max_age
            from dual                    
         ) ma
         where ca.visit_date >= to_date($$start_date$$,'DD-MON-YYYY')
         and ca.visit_date <= to_date($$end_date$$, 'DD-MON-YYYY')
         and ca.age_since_birth_at_time_of_vi >= $$minAgeAtVisit$$
         and ca.age_since_birth_at_time_of_vi <= ma.max_age
         and ca.parent_id = pa.source_id
         and least(to_date(pa.last_date_observed,'YYYYMMDD'), to_date($$end_date$$,'DD-MON-YY'), to_date(pa.date_of_birth,'YYYYMMDD') + ( ma.max_age * 365)) - greatest(pa.app_date, to_date($$start_date$$, 'DD-MON-YYYY'), to_date(pa.date_of_birth,'YYYYMMDD') + ( $$minAgeAtVisit$$ * 365)) + 1 >= $$duration_observation$$
         ]]>
            </sql>
   </sqlQuery>
   <sqlQuery name="ClinicalVisits2" excludeProjects="TrichDB,EuPathDB">
            <column name="internal"/>
            <column name="term"/>
            <sql>
         <![CDATA[
          select 
         ca.source_id  as term,
         ca.source_id  as internal
         from ApidbTuning.ClinicalVisitAttributes ca
         ]]>
            </sql>
   </sqlQuery>
   <sqlQuery name="ClinicalVisitMetadata" isCacheable="true">
            <paramRef ref="clinicalVisitParams.minAgeAtVisit" />
            <paramRef ref="clinicalVisitParams.maxAgeAtVisit" />
            <paramRef ref="participantParams.start_date" />
            <paramRef ref="participantParams.end_date" />
            <paramRef ref="participantParams.duration_observation" />  
            <column name="term"/>
            <column name="property"/>
            <column name="value"/>
            <sql>
         <![CDATA[
   select c.source_id as term,
           c.ontology_term_source_id as property,
           (case when c.ontology_term_source_id in ( select distinct property 
                                     from apidbtuning.metadataspec
                                    where spec_property = 'type'
                                      and spec_value = 'date' )
                then substr(c.value,1,4) || '-' || substr(c.value,5,2)|| '-' || substr(c.value,7,2)
                else c.value
            end) as value
  from ApidbTuning.AppNodeCharacteristics c, ApidbTuning.ClinicalVisitAttributes ca, ApidbTuning.personAttributes pa,
        (select CASE WHEN round($$maxAgeAtVisit$$) = $$maxAgeAtVisit$$ 
            THEN $$maxAgeAtVisit$$ + 0.99
            ELSE $$maxAgeAtVisit$$
            END as max_age
            from dual                    
           ) ma
where c.type = 'clinical_visit_data'
and c.value is not null
and c.category not in ('subcounty in uganda','household id')
and c.ontology_term_source_id  in (select property 
                         from ApidbTuning.MetadataSpec
                    )
         and c.source_id = ca.source_id
         and ca.visit_date >= to_date($$start_date$$,'DD-MON-YYYY')
         and ca.visit_date <= to_date($$end_date$$, 'DD-MON-YYYY')
         and ca.age_since_birth_at_time_of_vi >= $$minAgeAtVisit$$
         and ca.age_since_birth_at_time_of_vi <= ma.max_age
         and ca.parent_id = pa.source_id
         and least(to_date(pa.last_date_observed,'YYYYMMDD'), to_date($$end_date$$,'DD-MON-YYYY'), to_date(pa.date_of_birth,'YYYYMMDD') + ( ma.max_age * 365)) - greatest(pa.app_date, to_date($$start_date$$,'DD-MON-YYYY'), to_date(pa.date_of_birth,'YYYYMMDD') + ( $$minAgeAtVisit$$ * 365)) + 1 >= $$duration_observation$$
]]>
            </sql>
   </sqlQuery>
   <sqlQuery name="ClinicalVisitMetadata2" isCacheable="true">
            <column name="term"/>
            <column name="property"/>
            <column name="value"/>
            <sql>
         <![CDATA[
   select c.source_id as term,
           c.ontology_term_source_id as property,
           c.value as value
  from ApidbTuning.AppNodeCharacteristics c
where c.type = 'clinical_visit_data'
and c.value is not null
and c.ontology_term_source_id not in ('county in uganda')
and lower(c.ontology_term_source_id) not in (select property 
                         from ApidbTuning.MetadataSpec
                        where lower(spec_value) in ('do not display'))
]]>
            </sql>
   </sqlQuery>
   <sqlQuery name="NodeMetadataSpec">
            <column name="property"/>
            <column name="spec_property"/>
            <column name="spec_value"/>
            <sql>
         <![CDATA[
select distinct * from (
            Select mds.* from (
  select distinct property, spec_property, spec_value
  from ApidbTuning.MetadataSpec
  where ( entity_type in 'clinical_visit_data')
  and property not in  (select distinct property
                                       from Apidbtuning.metadataspec
                                     where lower(spec_value) = 'do not display'
                                            or property in ('EUPATH_0000054', 'EUPATH_0000094','incidentmalaria','parent_id'))
    union select spec_value as property, 'parent' as spec_property, '' as spec_value
     from ApidbTuning.MetadataSpec
  where ( entity_type = 'clinical_visit_data')
  and spec_property = 'display'
  and property not in  (select distinct property
                                      from Apidbtuning.metadataspec
                                     where spec_property = 'parent'))mds,
  ( select property, nvl(spec_value, 9999999999) as ord_num from apidbtuning.metadataspec
     where spec_property = 'order_num') ord_num
     where mds.property = ord_num.property (+)
     and mds.spec_property not like 'order_num'
    order by to_number(ord_num), mds.property)

        ]]>
     </sql>
   </sqlQuery>

          <sqlQuery name="ClinicalVisitOntologyNf">
         <paramRef ref="clinicalVisitParams.minAgeAtVisit" />
         <paramRef ref="clinicalVisitParams.maxAgeAtVisit" />
         <paramRef ref="participantParams.start_date" />
         <paramRef ref="participantParams.end_date" />
         <paramRef ref="participantParams.duration_observation" />  
        <column name="ontology_term_name"/>
        <column name="parent_ontology_term_name"/>
        <column name="display_name"/>
        <column name="description"/>
        <column name="type"/>
        <column name="units"/>
        <column name="precision"/>
        <column name="is_range"/>
        <sql>
           <![CDATA[
select property as ontology_term_name, parent_ontology_term_name, display_name, description, units,
CASE WHEN type is null THEN 'string' ELSE type END as type, 
CASE WHEN range = 'range' THEN 1 ELSE 0 END as is_range, 
CASE WHEN type = 'number' THEN 1 ELSE null END as precision 
  from (
            Select distinct mds.* from (
  select distinct property, spec_property, spec_value
  from ApidbTuning.MetadataSpec
  where ( entity_type in 'clinical_visit_data')
  and property not in  (select distinct property
                                       from Apidbtuning.metadataspec
                                     where lower(spec_value) = 'do not display'
                                            or property in ('EUPATH_0000054', 'EUPATH_0000094','incidentmalaria','parent_id'))
    union select spec_value as property, 'parent' as spec_property, '' as spec_value
     from ApidbTuning.MetadataSpec
  where ( entity_type = 'clinical_visit_data')
  and spec_property = 'display'
  and property not in  (select distinct property
                                      from Apidbtuning.metadataspec
                                     where spec_property = 'parent'))mds,
  ( select property, nvl(spec_value, 9999999999) as ord_num from apidbtuning.metadataspec
     where spec_property = 'order_num') ord_num
     where mds.property = ord_num.property (+)
     and mds.spec_property not like 'order_num'
    order by to_number(ord_num), mds.property)
        pivot(max(spec_value) for spec_property in ('parent' as parent_ontology_term_name, 'display' as display_name, 'description' as description, 
    'type' as type, 'units' as units, 'filter' as range, 'categorized' as is_categorized))
    ]]>   
        </sql>
          </sqlQuery>

   <sqlQuery name="ClinicalVisitMetadataNf">
      <paramRef ref="clinicalVisitParams.minAgeAtVisit" />
      <paramRef ref="clinicalVisitParams.maxAgeAtVisit" />
      <paramRef ref="participantParams.start_date" />
      <paramRef ref="participantParams.end_date" />
      <paramRef ref="participantParams.duration_observation" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select ids.term as internal, ids.property as ontology_term_name,
cast(CASE WHEN ms.spec_value = 'number' THEN ids.value ELSE null END as number) as number_value,
CASE WHEN ms.spec_value = 'string' THEN ids.value ELSE cast(null as varchar2(10)) END as string_value,
cast(CASE WHEN ms.spec_value = 'date' THEN ids.value ELSE null END as date) as date_value
from
apidbtuning.metadataspec ms,
 (select c.source_id as term,
           c.ontology_term_source_id as property,
           (case when c.ontology_term_source_id in ( select distinct property 
                                     from apidbtuning.metadataspec
                                    where spec_property = 'type'
                                      and spec_value = 'date' )
                then substr(c.value,1,4) || '-' || substr(c.value,5,2)|| '-' || substr(c.value,7,2)
                else c.value
            end) as value
  from ApidbTuning.AppNodeCharacteristics c, ApidbTuning.ClinicalVisitAttributes ca, ApidbTuning.personAttributes pa,
        (select CASE WHEN round($$maxAgeAtVisit$$) = $$maxAgeAtVisit$$ 
            THEN $$maxAgeAtVisit$$ + 0.99
            ELSE $$maxAgeAtVisit$$
            END as max_age
            from dual                    
           ) ma
where c.type = 'clinical_visit_data'
and c.value is not null
and c.category not in ('subcounty in uganda','household id')
and c.ontology_term_source_id  in (select property 
                         from ApidbTuning.MetadataSpec
                    )
         and c.source_id = ca.source_id
         and ca.visit_date >= to_date($$start_date$$,'DD-MON-YYYY')
         and ca.visit_date <= to_date($$end_date$$, 'DD-MON-YYYY')
         and ca.age_since_birth_at_time_of_vi >= $$minAgeAtVisit$$
         and ca.age_since_birth_at_time_of_vi <= ma.max_age
         and ca.parent_id = pa.source_id
         and least(to_date(pa.last_date_observed,'YYYYMMDD'), to_date($$end_date$$,'DD-MON-YYYY'), to_date(pa.date_of_birth,'YYYYMMDD') + ( ma.max_age * 365)) - greatest(pa.app_date, to_date($$start_date$$,'DD-MON-YYYY'), to_date(pa.date_of_birth,'YYYYMMDD') + ( $$minAgeAtVisit$$ * 365)) + 1 >= $$duration_observation$$
         
         ) ids
         where ids.property = ms.property
         and ms.spec_property = 'type'        
         ]]>   
      </sql>
   </sqlQuery>
          
  </querySet>    

</wdkModel>
