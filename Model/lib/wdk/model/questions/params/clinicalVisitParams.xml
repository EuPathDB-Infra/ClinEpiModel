<wdkModel>

  <paramSet name="clinicalVisitParams">
    
    <enumParam name="type"
               prompt="type"
               multiPick="false"
               quote="true"
               visible="false">
      <help>this is internal</help>
      <enumList>
        <enumValue default="true">
          <term>clinicalVisit</term>
          <internal>clinicalVisit</internal>
        </enumValue>
      </enumList>
    </enumParam>

        <datasetParam name="clinical_visits_by_sourceid" 
		  recordClassRef="ParticipantRecordClasses.ParticipantRecordClass"
		  prompt="Source ID input set">
      <help><![CDATA[Input a set of source IDs, or upload a file<br><br>

             It can be delimited by a comma, semi colon or any white space.<br><br>
             Its possible that not all the IDs in the list will be found in the database
             due to anumber of reasons such as unavailable ID mapping. It is currenly not
             possible to inform which IDs did not match anything in the database]]> </help>
     <suggest includeProjects="INIT" default="FILL" />
     <suggest default="100118844" />
      
    </datasetParam>

    <filterParamNew name="visits_nf" 
                    metadataQueryRef="ClinicalVisitVQ.VisitMetaData"
                    ontologyQueryRef="ClinicalVisitVQ.VisitOntology"
                    backgroundQueryRef="ClinicalVisitVQ.VisitMetaDataBkgd"
                    prompt="Visits"
                    trimMetadataTerms="false"
                    dependedParamRef="clinicalVisitParams.visits_visitage_metadata_nf,participantParams.start_date,participantParams.end_date,participantParams.duration_observation,participantParams.dwellings_nf,participantParams.geographic_region,participantParams.participants_nf">
      <help>
        Select participants based on their visit characteristics. 
      </help>
    </filterParamNew>

     <filterParamNew name="relative_visits_nf" 
                    metadataQueryRef="ClinicalVisitVQ.VisitMetaDataRelVis"
                    ontologyQueryRef="ClinicalVisitVQ.VisitOntology"
                    backgroundQueryRef="ClinicalVisitVQ.VisitMetaDataBkgd"
                    prompt="Relative Visits"
                    trimMetadataTerms="false"
                    dependedParamRef="clinicalVisitParams.visits_visitage_metadata_nf,participantParams.start_date,participantParams.end_date,participantParams.duration_observation,participantParams.dwellings_nf,participantParams.geographic_region,participantParams.participants_nf">
      <help>
        Select participants based on their visit characteristics. 
      </help>
    </filterParamNew>

       <filterParamNew name="visits_visitage_metadata_nf" 
                      metadataQueryRef="ClinicalVisitVQ.ClinicalVisitAgeMetadataNf"
                      ontologyQueryRef="ClinicalVisitVQ.ClinicalVisitAgeOntologyNf"
                      backgroundQueryRef="ClinicalVisitVQ.ClinicalVisitAgeMetadataBkgdNf"
                      prompt="ClinicalVisits"
                      dependedParamRef="participantParams.geographic_region"
                      trimMetadataTerms="false">
         <help>
              Select reference samples. 
         </help>
       </filterParamNew>



    <filterParam name="visits_by_metadata"
                 queryRef="ClinicalVisitVQ.ClinicalVisits"
                 metadataQueryRef="ClinicalVisitVQ.ClinicalVisitMetadata"
                 metadataSpecQueryRef="ClinicalVisitVQ.NodeMetadataSpec"
                 prompt="ClinicalVisits"
                 multiPick="true"
                 quote="true"
                 dependedParamRef="clinicalVisitParams.minAgeAtVisit,clinicalVisitParams.maxAgeAtVisit,participantParams.start_date,participantParams.end_date,participantParams.duration_observation"
                 suppressNode="false">
         <help>
              Select clinical visits based on characteristics. 
         </help>
         <!-- <suggest selectMode="all" /> -->
       </filterParam>

    <filterParam name="visits_by_metadata_2"
                 queryRef="ClinicalVisitVQ.ClinicalVisits2"
                 metadataQueryRef="ClinicalVisitVQ.ClinicalVisitMetadata2"
                 metadataSpecQueryRef="ClinicalVisitVQ.NodeMetadataSpec"
                 prompt="ClinicalVisits to Compare"
                 multiPick="true"
                 quote="true"
                 suppressNode="false">
         <help>
              Select clinical visits based on characteristics.  These visits will be utilized to compare to the visits selected above based on your comparison criteria (days between and whether to keep or remove).
         </help>
         <!-- <suggest selectMode="all" /> -->
       </filterParam>

   <stringParam name="maxDaysBetween"
		 prompt="Max days between visits &lt;= "
		 number="true">
      <help>Specify the maximum number of days between visit to keep or remove and the following visit.</help>
      <suggest default="10"/>
      <regex>\d\d*</regex>
    </stringParam>

     <stringParam name="minDaysBetween"
		 prompt="Min days between visits &gt;= "
		 number="true">
      <help>Specify the minimum number of days between visit to keep or remove and the following visit.</help>
      <suggest default="1"/>
      <regex>\d\d*</regex>
    </stringParam>

   <stringParam name="minAgeAtVisit"
		 prompt="Age at visit &gt;= "
		 number="true">
      <help>Minimum age at time of visit.</help>
      <suggest default="0.5"/>
      <regex>\d\d*\.*\d*</regex>
    </stringParam>

   <stringParam name="maxAgeAtVisit"
		 prompt="Age at visit &lt;= "
		 number="true">
      <help>Maximum age at time of visit.</help>
      <suggest default="80"/>
      <regex>\d\d*\.*\d*</regex>
    </stringParam>

    <enumParam name="dateOperator"
               prompt="Keep or Remove visits "
               multiPick="false"
               quote="false"
               visible="true">
      <help>Choose how to compare these two visits.  Do you want to remove visits that have another visit within the specified time frame or keep them.</help>
      <enumList>
        <enumValue default="true">
          <term>remove</term>
          <internal>MINUS</internal>
        </enumValue>
        <enumValue>
          <term>keep</term>
          <internal>INTERSECT</internal>
        </enumValue>
      </enumList>
    </enumParam>

    <enumParam name="date_direction"
               prompt="Choose a direction "
               multiPick="false"
               quote="false"
               visible="true">
      <help>Choose a direction for the corresponding visit.  Will the matching visit be before or after relative to the first visit.</help>
      <enumList>
        <enumValue default="true">
          <term>after</term>
          <internal><![CDATA[>=]]></internal>
        </enumValue>
        <enumValue>
          <term>before</term>
          <internal><![CDATA[<=]]></internal>
        </enumValue>
      </enumList>
    </enumParam>

    <flatVocabParam name="use_relative_visits"
               prompt="Use relative visits"
               multiPick="false"
               quote="false"
               visible="true"
               queryRef="ClinicalVisitVQ.useRelativeVisits">
      <help>You MUST change this parameter to Yes in order to use relative visits! If you decide to not use relative visits, set this parameter to No and make certain "Keep or remove visits" is set to remove.</help>
    </flatVocabParam>


    <flatVocabParam name="dateOperator_fv"
               prompt="Keep or Remove visits "
               multiPick="false"
               quote="false"
               visible="true"
               queryRef="ClinicalVisitVQ.dateOperator">
      <help>Choose how to compare these two visits.  Do you want to remove visits that have another visit within the specified time frame or keep them.</help>
    </flatVocabParam>

    <flatVocabParam name="date_direction_fv"
               prompt="Choose a direction "
               multiPick="false"
               quote="false"
               visible="true"
               queryRef="ClinicalVisitVQ.dateDirection">
      <help>Choose a direction for the corresponding visit.  Will the matching visit be before or after relative to the first visit.</help>
    </flatVocabParam>

    <answerParam name="clinical_visit_result"
                  prompt="Input Result Set"
                  readonly="true"
                  visible="false">
       <recordClass ref="ClinicalVisitRecordClasses.ClinicalVisitRecordClass" />
    </answerParam>

  </paramSet>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!--  Vocab queries-->  
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

 <querySet name="ClinicalVisitVQ" queryType="vocab" isCacheable="true">

        <sqlQuery name="dateDirection">
            <column name="internal" />
            <column name="term" />
            <sql>
              <![CDATA[
                       SELECT 'after' as term, '>=' as internal from dual
                       UNION
                       SELECT 'before' as term, '<=' as internal from dual
              ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="dateOperator">
            <column name="internal" />
            <column name="term" />
            <sql>
            <![CDATA[
                     SELECT * from (
                     SELECT 'remove' as term, 'MINUS' as internal from dual
                     UNION
                     SELECT 'keep' as term, 'INTERSECT' as internal from dual )
                     ORDER by term desc
            ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="useRelativeVisits">
            <column name="internal" />
            <column name="term" />
            <sql>
            <![CDATA[
                     SELECT 'No' as term, 0 as internal from dual
                     UNION
                     SELECT 'Yes' as term, 1 as internal from dual
            ]]>
            </sql>
        </sqlQuery>
   
   <sqlQuery name="ClinicalVisits" excludeProjects="TrichDB,EuPathDB">
            <paramRef ref="clinicalVisitParams.minAgeAtVisit" />
            <paramRef ref="clinicalVisitParams.maxAgeAtVisit" />
            <paramRef ref="participantParams.start_date" />
            <paramRef ref="participantParams.end_date" />
            <paramRef ref="participantParams.duration_observation" />  
            <column name="internal"/>
            <column name="term"/>
            <sql>
         <![CDATA[
          select 
         ca.source_id  as term,
         ca.source_id  as internal
         from ApidbTuning.ClinicalVisitAttributes ca, ApidbTuning.personAttributes pa,
         (select CASE WHEN round($$maxAgeAtVisit$$) = $$maxAgeAtVisit$$ 
            THEN $$maxAgeAtVisit$$ + 0.99
            ELSE $$maxAgeAtVisit$$
            END as max_age
            from dual                    
         ) ma
         where ca.visit_date >= to_date($$start_date$$,'DD-MON-YYYY')
         and ca.visit_date <= to_date($$end_date$$, 'DD-MON-YYYY')
         and ca.age_since_birth_at_time_of_vi >= $$minAgeAtVisit$$
         and ca.age_since_birth_at_time_of_vi <= ma.max_age
         and ca.parent_id = pa.source_id
         and least(to_date(pa.last_date_observed,'YYYYMMDD'), to_date($$end_date$$,'DD-MON-YY'), to_date(pa.date_of_birth,'YYYYMMDD') + ( ma.max_age * 365)) - greatest(pa.app_date, to_date($$start_date$$, 'DD-MON-YYYY'), to_date(pa.date_of_birth,'YYYYMMDD') + ( $$minAgeAtVisit$$ * 365)) + 1 >= $$duration_observation$$
         ]]>
            </sql>
   </sqlQuery>
   <sqlQuery name="ClinicalVisits2" excludeProjects="TrichDB,EuPathDB">
            <column name="internal"/>
            <column name="term"/>
            <sql>
         <![CDATA[
          select 
         ca.source_id  as term,
         ca.source_id  as internal
         from ApidbTuning.ClinicalVisitAttributes ca
         ]]>
            </sql>
   </sqlQuery>
   <sqlQuery name="ClinicalVisitMetadata" isCacheable="true">
            <paramRef ref="clinicalVisitParams.minAgeAtVisit" />
            <paramRef ref="clinicalVisitParams.maxAgeAtVisit" />
            <paramRef ref="participantParams.start_date" />
            <paramRef ref="participantParams.end_date" />
            <paramRef ref="participantParams.duration_observation" />  
            <column name="term"/>
            <column name="property"/>
            <column name="value"/>
            <sql>
         <![CDATA[
   select c.source_id as term,
           c.ontology_term_source_id as property,
           (case when c.ontology_term_source_id in ( select distinct property 
                                     from apidbtuning.metadataspec
                                    where spec_property = 'type'
                                      and spec_value = 'date' )
                then substr(c.value,1,4) || '-' || substr(c.value,5,2)|| '-' || substr(c.value,7,2)
                else c.value
            end) as value
  from ApidbTuning.AppNodeCharacteristics c, ApidbTuning.ClinicalVisitAttributes ca, ApidbTuning.personAttributes pa,
        (select CASE WHEN round($$maxAgeAtVisit$$) = $$maxAgeAtVisit$$ 
            THEN $$maxAgeAtVisit$$ + 0.99
            ELSE $$maxAgeAtVisit$$
            END as max_age
            from dual                    
           ) ma
where c.type = 'clinical_visit_data'
and c.value is not null
and c.category not in ('subcounty in uganda','household id')
and c.ontology_term_source_id  in (select property 
                         from ApidbTuning.MetadataSpec
                    )
         and c.source_id = ca.source_id
         and ca.visit_date >= to_date($$start_date$$,'DD-MON-YYYY')
         and ca.visit_date <= to_date($$end_date$$, 'DD-MON-YYYY')
         and ca.age_since_birth_at_time_of_vi >= $$minAgeAtVisit$$
         and ca.age_since_birth_at_time_of_vi <= ma.max_age
         and ca.parent_id = pa.source_id
         and least(to_date(pa.last_date_observed,'YYYYMMDD'), to_date($$end_date$$,'DD-MON-YYYY'), to_date(pa.date_of_birth,'YYYYMMDD') + ( ma.max_age * 365)) - greatest(pa.app_date, to_date($$start_date$$,'DD-MON-YYYY'), to_date(pa.date_of_birth,'YYYYMMDD') + ( $$minAgeAtVisit$$ * 365)) + 1 >= $$duration_observation$$
]]>
            </sql>
   </sqlQuery>
   <sqlQuery name="ClinicalVisitMetadata2" isCacheable="true">
            <column name="term"/>
            <column name="property"/>
            <column name="value"/>
            <sql>
         <![CDATA[
   select c.source_id as term,
           c.ontology_term_source_id as property,
           c.value as value
  from ApidbTuning.AppNodeCharacteristics c
where c.type = 'clinical_visit_data'
and c.value is not null
and c.ontology_term_source_id not in ('county in uganda')
and lower(c.ontology_term_source_id) not in (select property 
                         from ApidbTuning.MetadataSpec
                        where lower(spec_value) in ('do not display'))
]]>
            </sql>
   </sqlQuery>
   <sqlQuery name="NodeMetadataSpec">
            <column name="property"/>
            <column name="spec_property"/>
            <column name="spec_value"/>
            <sql>
         <![CDATA[
select distinct * from (
            Select mds.* from (
  select distinct property, spec_property, spec_value
  from ApidbTuning.MetadataSpec
  where ( entity_type in 'clinical_visit_data')
  and property not in  (select distinct property
                                       from Apidbtuning.metadataspec
                                     where lower(spec_value) = 'do not display'
                                            or property in ('EUPATH_0000054', 'EUPATH_0000094','incidentmalaria','parent_id'))
    union select spec_value as property, 'parent' as spec_property, '' as spec_value
     from ApidbTuning.MetadataSpec
  where ( entity_type = 'clinical_visit_data')
  and spec_property = 'display'
  and property not in  (select distinct property
                                      from Apidbtuning.metadataspec
                                     where spec_property = 'parent'))mds,
  ( select property, nvl(spec_value, 9999999999) as ord_num from apidbtuning.metadataspec
     where spec_property = 'order_num') ord_num
     where mds.property = ord_num.property (+)
     and mds.spec_property not like 'order_num'
    order by to_number(ord_num), mds.property)

        ]]>
     </sql>
   </sqlQuery>

   <sqlQuery name="ClinicalVisitOntologyNf">
     <!--         <paramRef ref="clinicalVisitParams.minAgeAtVisit" />
          <paramRef ref="clinicalVisitParams.maxAgeAtVisit" />
          <paramRef ref="participantParams.start_date" />
          <paramRef ref="participantParams.end_date" />
          <paramRef ref="participantParams.duration_observation" />  -->
        <column name="ontology_term_name"/>
        <column name="parent_ontology_term_name"/>
        <column name="display_name"/>
        <column name="description"/>
        <column name="type"/>
        <column name="units"/>
        <column name="precision"/>
        <column name="is_range"/>
        <sql>
           <![CDATA[
                       select o.ontology_term_name, o.parent_ontology_term_name, o.display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.metadataontology o, 
(select distinct term
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'clinical visit information') md
 where o.ontology_term_name = md.term               
    ]]>   
        </sql>
          </sqlQuery>

   <sqlQuery name="ClinicalVisitMetadataNf">
     <!-- <paramRef ref="clinicalVisitParams.minAgeAtVisit" />
      <paramRef ref="clinicalVisitParams.maxAgeAtVisit" />
      <paramRef ref="participantParams.start_date" />
      <paramRef ref="participantParams.end_date" />
      <paramRef ref="participantParams.duration_observation" />  -->
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct protocol_app_node_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'clinical visit information'
         ]]>   
      </sql>
   </sqlQuery>

   <sqlQuery name="ClinicalVisitAgeOntologyNf">
      <paramRef ref="participantParams.geographic_region" /> 
        <column name="ontology_term_name"/>
        <column name="parent_ontology_term_name"/>
        <column name="display_name"/>
        <column name="description"/>
        <column name="type"/>
        <column name="units"/>
        <column name="precision"/>
        <column name="is_range"/>
        <sql>
           <![CDATA[
                       select o.ontology_term_name, 'dummy' as parent_ontology_term_name, o.display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.metadataontology o
where ontology_term_name = 'age since birth at time of visit'
union
                 select 'dummy' as ontology_term_name, null as parent_ontology_term_name, 'Dwelling' as display_name, null as description, null as units, 'string' as type, 0 as is_range,
                 null as precision from dual
    ]]>   
        </sql>
      </sqlQuery>
          
   <sqlQuery name="ClinicalVisitAgeMetadataNf">
      <paramRef ref="participantParams.geographic_region" /> 
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct pa.output_Node_Id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
 from apidbtuning.metadata m,
 (select distinct io.input_node_id, io.output_node_id
  from apidbtuning.protocolappnodeio io
  where io.input_node_id in ($$geographic_region$$)
  ) pa
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'clinical visit information'
 and m.term = 'age since birth at time of visit'
 and pa.output_node_id = m.protocol_app_node_id
         ]]>   
      </sql>
   </sqlQuery>

      <sqlQuery name="ClinicalVisitAgeMetadataBkgdNf">
      <paramRef ref="participantParams.geographic_region" /> 
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct protocol_app_node_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'clinical visit information'
 and term = 'age since birth at time of visit'
          ]]>   
      </sql>
   </sqlQuery>

      <sqlQuery name="VisitOntology">
      <paramRef ref="clinicalVisitParams.visits_visitage_metadata_nf" />
     <paramRef ref="participantParams.start_date" />
     <paramRef ref="participantParams.end_date" />
     <paramRef ref="participantParams.duration_observation" />  
     <paramRef ref="participantParams.dwellings_nf" />  
     <paramRef ref="participantParams.geographic_region" />  
     <paramRef ref="participantParams.participants_nf" />  
     <column name="ontology_term_name"/>
     <column name="parent_ontology_term_name"/>
     <column name="display_name"/>
     <column name="description"/>
     <column name="type"/>
     <column name="units"/>
     <column name="precision"/>
     <column name="is_range"/>
    <sql>
         <![CDATA[
with leaf as ( select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.metadataontology o, 
(select distinct term
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'clinical visit information') md
 where o.ontology_term_name = md.term),
first as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from leaf where parent_ontology_term_name is not null) par
 where o.ontology_term_name = par.parent_ontology_term_name),
 second as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from first where parent_ontology_term_name is not null) gpar
 where o.ontology_term_name = gpar.parent_ontology_term_name)
 select * from leaf
 union
 select * from first
 union
 select * from second
 union
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from second where parent_ontology_term_name is not null) ggpar
 where o.ontology_term_name = ggpar.parent_ontology_term_name
         ]]>
    </sql>
   </sqlQuery>

       <sqlQuery name="VisitMetaData">
         <paramRef ref="clinicalVisitParams.visits_visitage_metadata_nf" />
         <paramRef ref="participantParams.start_date" />
         <paramRef ref="participantParams.end_date" />
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.dwellings_nf" />  
         <paramRef ref="participantParams.geographic_region" />  
         <paramRef ref="participantParams.participants_nf" />  
         <column name="ontology_term_name"/>
         <column name="internal"/>
         <column name="number_value"/>
         <column name="date_value"/>
         <column name="string_value"/>
         <sql>
           <![CDATA[
select distinct va.protocol_app_node_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata m, apidbtuning.protocolappnodeio io, apidbtuning.clinicalvisitattributes va
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'clinical visit information'
 and m.protocol_app_node_id = va.protocol_app_node_id
 and io.output_Node_Id = va.protocol_app_node_id
 and va.protocol_app_node_id in ($$visits_visitage_metadata_nf$$)
 and io.input_node_id in ($$participants_nf$$)
 and va.EUPATH_0000091 >= to_date($$start_date$$,'DD-MON-YYYY')
 and va.EUPATH_0000091 <= to_date($$end_date$$,'DD-MON-YYYY')
          ]]>
    </sql>
    </sqlQuery>    

    <sqlQuery name="VisitMetaDataRelVis">
         <paramRef ref="clinicalVisitParams.visits_visitage_metadata_nf" />
         <paramRef ref="participantParams.start_date" />
         <paramRef ref="participantParams.end_date" />
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.dwellings_nf" />  
         <paramRef ref="participantParams.geographic_region" />  
         <paramRef ref="participantParams.participants_nf" />  
         <column name="ontology_term_name"/>
         <column name="internal"/>
         <column name="number_value"/>
         <column name="date_value"/>
         <column name="string_value"/>
         <sql>
           <![CDATA[
select distinct va.protocol_app_node_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata m, apidbtuning.protocolappnodeio io, apidbtuning.clinicalvisitattributes va
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'clinical visit information'
 and m.protocol_app_node_id = va.protocol_app_node_id
 and io.output_Node_Id = va.protocol_app_node_id
 and io.input_node_id in ($$participants_nf$$)
          ]]>
    </sql>
    </sqlQuery>    

    <sqlQuery name="VisitMetaDataBkgd">
         <paramRef ref="clinicalVisitParams.visits_visitage_metadata_nf" />
         <paramRef ref="participantParams.start_date" />
         <paramRef ref="participantParams.end_date" />
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.dwellings_nf" />  
         <paramRef ref="participantParams.geographic_region" />  
         <paramRef ref="participantParams.participants_nf" />  
         <column name="ontology_term_name"/>
         <column name="internal"/>
         <column name="number_value"/>
         <column name="date_value"/>
         <column name="string_value"/>
         <sql>
           <![CDATA[
 select distinct protocol_app_node_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata 
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'clinical visit information'
          ]]>
    </sql>
    </sqlQuery>
   
  </querySet>    

</wdkModel>
