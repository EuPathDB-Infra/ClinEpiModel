<wdkModel>

  <paramSet name="lightTrapParams">
    
    <enumParam name="type"
               prompt="type"
               multiPick="false"
               quote="true"
               visible="false">
      <help>this is internal</help>
      <enumList>
        <enumValue default="true">
          <term>household</term>
          <internal>household</internal>
        </enumValue>
      </enumList>
    </enumParam>


<!--                    ontologyValuesQueryRef="ParticipantVQ.RegionOntologyValues_prism" -->
    <filterParamNew name="geographic_region_prism" 
                    ontologyQueryRef="ParticipantVQ.RegionOntology_prism"
                    metadataQueryRef="lightTrapVQ.RegionMetaData_prism"
                    prompt="Geographic Region"
                    filterDataTypeDisplayName="Households"
                    countPredictsAnswerCount="true"
                    trimMetadataTerms="false"
                    dependedParamRef="participantParams.tbl_prefix">
      <help>
        Select light trap collections based on geographic region. 
      </help>
     </filterParamNew>
     
<!--                    ontologyValuesQueryRef="ParticipantVQ.HouseholdOntologyValues_prism" -->
     <filterParamNew name="households_prism" 
                    ontologyQueryRef="ParticipantVQ.HouseholdOntology_prism"
                    metadataQueryRef="lightTrapVQ.HouseholdMetaData_prism"
                    backgroundQueryRef="lightTrapVQ.HouseholdMetaDataBkgd_prism"
                    useIdTransformSqlForInternalValue="true"
                    prompt="Households"
                    countPredictsAnswerCount="true"
                    trimMetadataTerms="false"
                    dependedParamRef="participantParams.tbl_prefix,lightTrapParams.geographic_region_prism,householdParams.date_range">
      <help>
        Select light trap collections based on the characteristics of the household where collection was performed. 
      </help>
    </filterParamNew>

<!--                    ontologyValuesQueryRef="lightTrapVQ.LightTrapOntologyValues_prism" -->
    <filterParamNew name="lighttraps_prism" 
                    ontologyQueryRef="lightTrapVQ.LightTrapOntology_prism"
                    metadataQueryRef="lightTrapVQ.LightTrapMetaData_prism"
                    backgroundQueryRef="lightTrapVQ.LightTrapMetaDataBkgd_prism"
                    prompt="CDC Light Trap Collections"
                    filterDataTypeDisplayName="Collections"
                    countPredictsAnswerCount="true"
                    trimMetadataTerms="false"
                    dependedParamRef="participantParams.tbl_prefix,householdParams.date_range,lightTrapParams.households_prism">
      <help>
        Select light trap collections based on the characteristics of the household where collection was performed. 
      </help>
    </filterParamNew>


      <!-- TEMPLATE_ANCHOR lightTrapSourceIdParam -->


      <!-- TEMPLATE_ANCHOR lightTrapResultParam -->

 <enumParam name="district"
               prompt="Study site "
               multiPick="true"
               quote="true"
               visible="true">
      <help>Choose the study sites (districts) for your search.</help>
      <enumList>
        <enumValue default="true">
          <term>Tororo</term>
          <internal>tororo</internal>
        </enumValue>
        <enumValue default="true">
          <term>Kanungu</term>
          <internal>kanungu</internal>
        </enumValue>  
        <enumValue default="true">
          <term>Jinja</term>
          <internal>jinja</internal>
        </enumValue>  
      </enumList>
    </enumParam>

  </paramSet>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!--  Vocab queries-->  
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

 <querySet name="lightTrapVQ" queryType="vocab" isCacheable="true">

    <sqlQuery name="RegionMetaData_prism" isCacheable="false" >
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="internal_for_counts"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select m.pan_id as internal,  io.output_pan_id as internal_for_counts, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, ApidbTuning.$$tbl_prefix$$PANIO io
 where m.property_source_id = 'EUPATH_0000054'
 and m.pan_id = io.input_pan_id
 and io.output_pan_type_source_id = 'EUPATH_0000055'
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="HouseholdMetaData_prism" isCacheable="true">
      <paramRef ref="householdParams.date_range" />  
      <paramRef ref="lightTrapParams.geographic_region_prism" />  
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="internal_for_counts"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
with mos as (
 select da.pan_id, 'average anopheles' as ontology_term_name, null as string_value, 
   round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as number_value, null as date_value
  from ApidbTuning.$$tbl_prefix$$Households da, ApidbTuning.$$tbl_prefix$$PANIO io, ApidbTuning.$$tbl_prefix$$LightTraps la
  where da.pan_id in ($$geographic_region_prism$$)
  and da.pan_id = io.input_pan_id
  and la.pan_id = io.output_pan_id
  and la.OBI_0001619 >= $$date_range.min$$
  and la.OBI_0001619 <= $$date_range.max$$ 
  group by da.pan_id
  )
select distinct m.pan_id as internal, io.output_pan_id as internal_for_counts, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, mos, ApidbTuning.$$tbl_prefix$$PANIO io
 where m.pan_id in ($$geographic_region_prism$$)
 and m.pan_id = mos.pan_id
 and m.pan_id = io.input_pan_id
 and io.output_pan_type_source_id = 'EUPATH_0000055'
 union 
 select mos.pan_id as internal, io.output_pan_id as internal_for_counts, mos.ontology_term_name, mos.string_value,mos.number_value, mos.date_value 
 from mos, ApidbTuning.$$tbl_prefix$$PANIO io
 where mos.pan_id = io.input_pan_id
 and io.output_pan_type_source_id = 'EUPATH_0000055'
          ]]>
    </sql>
    </sqlQuery>

     <sqlQuery name="HouseholdMetaDataBkgd_prism" isCacheable="true">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="internal_for_counts"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
with mos as (
 select da.pan_id, 'average anopheles' as ontology_term_name, null as string_value, 
   round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as number_value, null as date_value
  from ApidbTuning.$$tbl_prefix$$Households da, ApidbTuning.$$tbl_prefix$$PANIO io, ApidbTuning.$$tbl_prefix$$LightTraps la
  where da.pan_id = io.input_pan_id
  and la.pan_id = io.output_pan_id
  group by da.pan_id
  )
select distinct m.pan_id as internal, io.output_pan_id as internal_for_counts, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, mos, ApidbTuning.$$tbl_prefix$$PANIO io
 where m.pan_id = mos.pan_id
 and m.pan_id = io.input_pan_id
 and io.output_pan_type_source_id = 'EUPATH_0000055'
 union 
 select mos.pan_id as internal, io.output_pan_id as internal_for_counts, mos.ontology_term_name, mos.string_value,mos.number_value, mos.date_value 
 from mos, ApidbTuning.$$tbl_prefix$$PANIO io
 where mos.pan_id = io.input_pan_id
 and io.output_pan_type_source_id = 'EUPATH_0000055'
          ]]>
    </sql>
    </sqlQuery>   

    <sqlQuery name="LightTrapOntology_prism">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="parent_ontology_term_name"/>
      <column name="display_name"/>
      <column name="description"/>
      <column name="type"/>
      <column name="units"/>
      <column name="precision"/>
      <column name="is_range"/>
      <sql>
        <![CDATA[
 select distinct o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from ApidbTuning.$$tbl_prefix$$Ontology o
     CONNECT BY o.parent_ontology_term_source_id = PRIOR o.ontology_term_source_id
     START WITH o.ontology_term_source_id =  'EUPATH_0000327'
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="LightTrapMetaData_prism">
      <paramRef ref="householdParams.date_range" />  
      <paramRef ref="lightTrapParams.households_prism" />  
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="internal_for_counts"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct m.pan_id as internal, m.pan_id as internal_for_counts, property_source_id as ontology_term_name, string_value, number_value, date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, ApidbTuning.$$tbl_prefix$$LightTraps lta
 where lta.pan_id in ($$households_prism$$)
 and lta.OBI_0001619 >= $$date_range.min$$
 and lta.OBI_0001619 <= $$date_range.max$$ 
 and m.pan_id = lta.pan_id 
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="LightTrapMetaDataBkgd_prism">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="internal_for_counts"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct m.pan_id as internal, m.pan_id as internal_for_counts, property_source_id as ontology_term_name, string_value, number_value, date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m
 where m.category = 'CDC light trap assay'
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="LightTrapOntologyValues_prism" isCacheable="true">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
 select distinct m.pan_id as internal, property_source_id as ontology_term_name, string_value, number_value, date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, apidbtuning.$$tbl_prefix$$Ontology o
 where o.type is not null
and o.is_range = 0
and m.property_source_id = o.ontology_term_source_id
and m.category = 'CDC light trap assay'
        ]]>
      </sql>
    </sqlQuery>

 </querySet>

</wdkModel>
