<wdkModel>

  <paramSet name="lighttrapParams">
    
    <enumParam name="type"
               prompt="type"
               multiPick="false"
               quote="true"
               visible="false">
      <help>this is internal</help>
      <enumList>
        <enumValue default="true">
          <term>dwelling</term>
          <internal>dwelling</internal>
        </enumValue>
      </enumList>
    </enumParam>

    <filterParam name="lighttraps_by_all_metadata"
                 queryRef="ltsVQ.Lighttraps"
                 metadataQueryRef="ltsVQ.LighttrapMetadataCross"
                 metadataSpecQueryRef="ltsVQ.NodeMetadataSpecCross"
                 prompt="Mosquito Collections"
                 multiPick="true"
                 quote="true"
                 dependedParamRef="participantParams.start_date,participantParams.end_date"
                 suppressNode="true">
         <help>
              Select dwellings based on Characteristics. 
         </help>
         <!-- <suggest selectMode="all" /> -->
       </filterParam>

    <datasetParam name="collectionsBySourceID"
		  recordClassRef="LightTrapRecordClasses.LightTrapRecordClass"
		  prompt="Source ID input set">
      <help><![CDATA[Input a set of source ID's, or upload a file <br><br>

               It can be delimited by a comma, semi colon or any white space<br><br>

               Its possible that not all ID's in the list will be found in the database
               due to a number of reasons such as unavailable ID maping. Its also currently not
               possible to inform which ID's did not match anything in the database]]></help>
      <suggest includeProjects="INIT" default="FILL" />
      <suggest default="T3-WSWX" />      
    </datasetParam>

    <answerParam name="lighttrap_result"
                  prompt="Input Result Set"
                  readonly="true"
                  visible="false">
       <recordClass ref="LightTrapRecordClasses.LightTrapRecordClass" />
    </answerParam>

 <enumParam name="district"
               prompt="Study site "
               multiPick="true"
               quote="true"
               visible="true">
      <help>Choose the study sites (districts) for your search.</help>
      <enumList>
        <enumValue default="true">
          <term>Tororo</term>
          <internal>tororo</internal>
        </enumValue>
        <enumValue default="true">
          <term>Kanungu</term>
          <internal>kanungu</internal>
        </enumValue>  
        <enumValue default="true">
          <term>Jinja</term>
          <internal>jinja</internal>
        </enumValue>  
      </enumList>
    </enumParam>

  </paramSet>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!--  Vocab queries-->  
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

 <querySet name="ltsVQ" queryType="vocab" isCacheable="true">
   <sqlQuery name="Lighttraps" excludeProjects="TrichDB,EuPathDB">
            <paramRef ref="participantParams.start_date" />
            <paramRef ref="participantParams.end_date" />
            <column name="internal"/>
            <column name="term"/>
            <sql>
         <![CDATA[
          select 
         nvl(pan.source_id,pan.name)  as term,
         nvl(pan.source_id,pan.name)  as internal
  from ApidbTuning.LighttrapAttributes pan
  where pan.collection_date between to_date($$start_date$$,'DD-MON-YYYY') and to_date($$end_date$$,'DD-MON-YYYY')
         ]]>
            </sql>
   </sqlQuery>

   <sqlQuery name="LighttrapMetadataCross">
            <paramRef ref="participantParams.start_date" />
            <paramRef ref="participantParams.end_date" />
            <column name="term"/>
            <column name="property"/>
            <column name="value"/>
            <sql>
         <![CDATA[
          select * from (
           select name as term,
           ontology_term_source_id as property,
                      (case when ontology_term_source_id in ( select distinct property 
                                     from apidbtuning.metadataspec
                                    where spec_property = 'type'
                                      and spec_value = 'date' )
                then substr(value,1,4) || '-' || substr(value,5,2)|| '-' || substr(value,7,2)
                else value
            end) as value
  from ApidbTuning.AppNodeCharacteristics
where type = 'light_trap_data'
and ontology_term_source_id in (select distinct property
                       from ApidbTuning.MetadataSpec
                      )
union
select lts.name as term,
             dwelling.ontology_term_source_id as property,
               (case when dwelling.ontology_term_source_id in ( select distinct property 
                                     from apidbtuning.metadataspec
                                    where spec_property = 'type'
                                      and spec_value = 'date' )
                then substr(dwelling.value,1,4) || '-' || substr(dwelling.value,5,2)|| '-' || substr(dwelling.value,7,2)
                else dwelling.value
            end) as value

from ApidbTuning.AppNodeCharacteristics dwelling,
     ApidbTuning.AppNodeCharacteristics lts,
     APIDBTUNING.PANAssociations pan

where  dwelling.type = 'dwelling'
and  lts.type ='light_trap_data'
  and dwelling.SOURCE_ID = pan.node_source_id
  and lts.source_id = pan.associated_node_source_id
)
where value is not null 
         ]]>
            </sql>
   </sqlQuery>

   <sqlQuery name="DwellingMetadata">
            <column name="term"/>
            <column name="property"/>
            <column name="value"/>
            <sql>
         <![CDATA[
   select name as term,
           ontology_term_source_id as property,
           value as value
  from ApidbTuning.AppNodeCharacteristics
where type = 'dwelling'
and value is not null
]]>
            </sql>
   </sqlQuery>


   <sqlQuery name="NodeMetadataSpec">
            <column name="property"/>
            <column name="spec_property"/>
            <column name="spec_value"/>
            <sql>
         <![CDATA[
select distinct property, spec_property, spec_value
  from ApidbTuning.MetadataSpec
 where entity_type ='dwelling'
    or entity_type ='all' 
        ]]>
     </sql>
   </sqlQuery>

   <sqlQuery name="NodeMetadataSpecCross">
            <column name="property"/>
            <column name="spec_property"/>
            <column name="spec_value"/>
            <sql>
         <![CDATA[
select distinct * from (
            Select mds.* from (
select distinct property, spec_property, spec_value
  from ApidbTuning.MetadataSpec
  where entity_type in 'dwelling' or entity_type = 'light_trap_data'
Union
select distinct property, 'parent' as spec_property, 'Characteristics' as spec_value
from    ( select distinct spec_value as property
    from apidbtuning.metadataspec
    where spec_property = 'parent'
    and (entity_type in 'dwelling' or entity_type = 'light_trap_data')
    and spec_value not in
        (select distinct property
           from Apidbtuning.metadataspec
          where spec_property = 'parent'
            and lower(spec_value) != 'do not display'))
union
select distinct property, 'parent' as spec_property, 'Characteristics' as spec_value
from apidbtuning.metadataspec
where lower(property) in ('district in uganda','age at time of visit')

union
select 'Characteristics' as property, 'display' as spec_property, 'Characteristics' as spec_value
from dual
union
select distinct property, 'parent' as spec_property, 'Uncategorized Characteristics' as spec_value from ApidbTuning.Metadataspec where
property not in ( select property from ApidbTuning.Metadataspec
                   where Spec_Property = 'parent'
                   union
                  select spec_value from ApidbTuning.Metadataspec
                   where Spec_Property = 'parent'
                   union
                  select distinct property
                    from apidbtuning.metadataspec
                   where lower(property) in ('district in uganda','age at time of visit'))
and (entity_type in 'light_trap_data' or entity_type = 'dwelling')
union
select distinct 'Uncategorized Characteristics', 'display' as spec_property, 'Uncategorized Characteristics' as spec_value from dual
)mds,
  ( select property, nvl(spec_value, 9999999999) as ord_num from apidbtuning.metadataspec
     where spec_property = 'order_num') ord_num
     where mds.property = ord_num.property (+)
     and mds.spec_property not like 'order_num'
    order by to_number(ord_num), mds.property)
 
        ]]>
     </sql>
   </sqlQuery>   

 </querySet>

</wdkModel>
