<wdkModel>

  <paramSet name="dwellingParams">
    
    <enumParam name="type"
               prompt="type"
               multiPick="false"
               quote="true"
               visible="false">
      <help>this is internal</help>
      <enumList>
        <enumValue default="true">
          <term>dwelling</term>
          <internal>dwelling</internal>
        </enumValue>
      </enumList>
    </enumParam>

    <filterParamNew name="dwellings_nf" 
                    ontologyQueryRef="DwellingVQ.DwellingOntology"
                    metadataQueryRef="DwellingVQ.DwellingMetaData"
                    backgroundQueryRef="DwellingVQ.DwellingMetaDataBkgd"
                    prompt="Dwelling"
                    trimMetadataTerms="false"
                    dependedParamRef="dwellingParams.geographic_region,participantParams.start_date,participantParams.end_date">
      <help>
        Select participants based on their characteristics. 
      </help>
    </filterParamNew>

     <filterParamNew name="geographic_region" 
                    metadataQueryRef="DwellingVQ.RegionMetaData"
                    ontologyQueryRef="DwellingVQ.RegionOntology"
                    prompt="Dwelling"
                    trimMetadataTerms="false">
      <help>
        Select dwellngs based on geographic region. 
      </help>
    </filterParamNew>          

    <filterParamNew name="participants_nf" 
                      metadataQueryRef="DwellingVQ.ParticipantMetaData"
                      summaryMetadataQueryRef="DwellingVQ.ParticipantSummaryMetaData"
                      ontologyQueryRef="DwellingVQ.ParticipantOntology"
                      backgroundQueryRef="DwellingVQ.ParticipantMetaDataBkgd"
                      prompt="Participants"
                      trimMetadataTerms="false"
                      dependedParamRef="participantParams.start_date,participantParams.end_date,dwellingParams.dwellings_nf,dwellingParams.geographic_region">
         <help>
              Select participants based on their characteristics. 
         </help>
       </filterParamNew>


    <datasetParam name="dwellingsBySourceID"
		  recordClassRef="DwellingRecordClasses.DwellingRecordClass"
		  prompt="Source ID input set">
      <help><![CDATA[Input a set of source ID's, or upload a file <br><br>

               It can be delimited by a comma, semi colon or any white space<br><br>

               Its possible that not all ID's in the list will be found in the database
               due to a number of reasons such as unavailable ID maping. Its also currently not
               possible to inform which ID's did not match anything in the database]]></help>
      <suggest default="HH101009801" />
      
    </datasetParam>
    <answerParam name="dwelling_result"
                  prompt="Input Result Set"
                  readonly="true"
                  visible="false">
       <recordClass ref="DwellingRecordClasses.DwellingRecordClass" />
    </answerParam>

 <enumParam name="district"
               prompt="Study site "
               multiPick="true"
               quote="true"
               visible="true">
      <help>Choose the study sites (districts) for your search.</help>
      <enumList>
        <enumValue default="true">
          <term>Tororo</term>
          <internal>tororo</internal>
        </enumValue>
        <enumValue default="true">
          <term>Kanungu</term>
          <internal>kanungu</internal>
        </enumValue>  
        <enumValue default="true">
          <term>Jinja</term>
          <internal>jinja</internal>
        </enumValue>  
      </enumList>
    </enumParam>

  </paramSet>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!--  Vocab queries-->  
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

 <querySet name="DwellingVQ" queryType="vocab" isCacheable="true">

   <sqlQuery name="DwellingOntology">
     <paramRef ref="participantParams.start_date" />
     <paramRef ref="participantParams.end_date" />
     <paramRef ref="dwellingParams.geographic_region" />  
     <column name="ontology_term_name"/>
     <column name="parent_ontology_term_name"/>
     <column name="display_name"/>
     <column name="description"/>
     <column name="type"/>
     <column name="units"/>
     <column name="precision"/>
     <column name="is_range"/>
    <sql>
         <![CDATA[
   with leaf as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.metadataontology o, 
(select distinct term
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'Dwelling type') md
 where o.ontology_term_name = md.term),
first as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from leaf where parent_ontology_term_name is not null) par
 where o.ontology_term_name = par.parent_ontology_term_name),
 second as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from first where parent_ontology_term_name is not null) gpar
 where o.ontology_term_name = gpar.parent_ontology_term_name)
 select * from leaf
 union
 select * from first
 union
 select * from second
 union
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from second where parent_ontology_term_name is not null) ggpar
 where o.ontology_term_name = ggpar.parent_ontology_term_name
 union
 select 'average anopheles' as ontology_term_name, null as parent_ontology_term_name, 'Average Anopheles Collected' as display_name, 'Average number of Anopheles collected in monthly CDC light traps during the dates of this search' as description, null as units, 'number' as type, 1 as is_range,
 null as precision from dual
         ]]>
    </sql>
   </sqlQuery>
          
    <sqlQuery name="DwellingMetaDataBkgd">
     <paramRef ref="participantParams.start_date" />
     <paramRef ref="participantParams.end_date" />
     <paramRef ref="dwellingParams.geographic_region" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.protocol_app_node_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata m
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'Dwelling type'
 union
 select da.protocol_app_node_id, 'average anopheles' as ontology_term_name, null as string_value, 
   round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as number_value, null as date_value
  from apidbtuning.dwellingattributes da, apidbtuning.protocolappnodeio io, apidbtuning.lighttrapattributes la
  where da.protocol_app_node_id = io.input_node_id
  and la.protocol_app_node_id = io.output_node_id
  group by da.protocol_app_node_id
          ]]>
    </sql>
    </sqlQuery>

        <sqlQuery name="DwellingMetaData" isCacheable="true">
     <paramRef ref="participantParams.start_date" />
     <paramRef ref="participantParams.end_date" />
     <paramRef ref="dwellingParams.geographic_region" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.protocol_app_node_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata m
 where m.protocol_app_node_id in ($$geographic_region$$)
 union
 select da.protocol_app_node_id, 'average anopheles' as ontology_term_name, null as string_value, 
   round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as number_value, null as date_value
  from apidbtuning.dwellingattributes da, apidbtuning.protocolappnodeio io, apidbtuning.lighttrapattributes la
  where da.protocol_app_node_id in ($$geographic_region$$)
  and da.protocol_app_node_id = io.input_node_id
  and la.protocol_app_node_id = io.output_node_id
  and la.OBI_0001619 >= to_date($$start_date$$,'DD-MON-YYYY') 
  and la.OBI_0001619 <= to_date($$end_date$$,'DD-MON-YYYY') 
  group by da.protocol_app_node_id
          ]]>
    </sql>
    </sqlQuery>

   <sqlQuery name="RegionOntology">
     <column name="ontology_term_name"/>
     <column name="parent_ontology_term_name"/>
     <column name="display_name"/>
     <column name="description"/>
     <column name="type"/>
     <column name="units"/>
     <column name="precision"/>
     <column name="is_range"/>
    <sql>
         <![CDATA[
                 select o.ontology_term_name, 'dummy' as parent_ontology_term_name, o.display_name, o.description, o.units,o.type,o.is_range,o.precision
                 from apidbtuning.metadataontology o 
                 where o.ontology_term_name = 'Subcounty in Uganda'
                 union
                 select 'dummy' as ontology_term_name, null as parent_ontology_term_name, 'Dwelling type' as display_name, null as description, null as units, 'string' as type, 0 as is_range,
                 null as precision from dual
         ]]>
    </sql>
   </sqlQuery>
   
   <sqlQuery name="RegionMetaData">
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct protocol_app_node_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'Dwelling type'
 and source_id = 'EUPATH_0000054'
          ]]>
    </sql>
    </sqlQuery>
    
   <sqlQuery name="ParticipantOntology">
     <paramRef ref="participantParams.start_date" />
     <paramRef ref="participantParams.end_date" />
     <paramRef ref="dwellingParams.dwellings_nf" />  
     <paramRef ref="dwellingParams.geographic_region" />  
     <column name="ontology_term_name"/>
     <column name="parent_ontology_term_name"/>
     <column name="display_name"/>
     <column name="description"/>
     <column name="type"/>
     <column name="units"/>
     <column name="precision"/>
     <column name="is_range"/>
    <sql>
         <![CDATA[
with leaf as ( 
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.metadataontology o, 
(select distinct term
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'Participant') md
 where o.ontology_term_name = md.term),
first as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from leaf where parent_ontology_term_name is not null) par
 where o.ontology_term_name = par.parent_ontology_term_name),
 second as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from first where parent_ontology_term_name is not null) gpar
 where o.ontology_term_name = gpar.parent_ontology_term_name)
 select * from leaf
 union
 select * from first
 union
 select * from second
 union
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from second where parent_ontology_term_name is not null) ggpar
 where o.ontology_term_name = ggpar.parent_ontology_term_name
         ]]>
    </sql>
   </sqlQuery>

   <sqlQuery name="ParticipantMetaData" isCacheable="true">
     <paramRef ref="participantParams.start_date" />
     <paramRef ref="participantParams.end_date" />
     <paramRef ref="dwellingParams.dwellings_nf" />  
     <paramRef ref="dwellingParams.geographic_region" />  
     <column name="ontology_term_name"/>
     <column name="internal"/>
     <column name="number_value"/>
     <column name="date_value"/>
     <column name="string_value"/>
     <sql>
         <![CDATA[
select distinct m.protocol_app_node_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
from apidbtuning.metadata m, apidbtuning.protocolappnodeio io
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'Participant'
 and m.protocol_app_node_id = io.output_node_id
 and io.input_node_id in ($$dwellings_nf$$)
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="ParticipantSummaryMetaData" isCacheable="false">
     <paramRef ref="participantParams.start_date" />
     <paramRef ref="participantParams.end_date" />
     <paramRef ref="dwellingParams.dwellings_nf" />  
     <paramRef ref="dwellingParams.geographic_region" />  
     <column name="ontology_term_name"/>
     <column name="internal"/>
     <column name="number_value"/>
     <column name="date_value"/>
     <column name="string_value"/>
     <sql>
         <![CDATA[
select distinct io.input_node_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
from apidbtuning.metadata m, apidbtuning.protocolappnodeio io
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'Participant'
 and m.protocol_app_node_id = io.output_node_id
 and io.input_node_id in ($$dwellings_nf$$)
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="ParticipantMetaDataBkgd">
      <paramRef ref="participantParams.start_date" />
      <paramRef ref="participantParams.end_date" />
      <paramRef ref="dwellingParams.dwellings_nf" />  
      <paramRef ref="dwellingParams.geographic_region" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.protocol_app_node_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
from apidbtuning.metadata m, apidbtuning.protocolappnodeio io
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'Participant'
 and m.protocol_app_node_id = io.output_node_id
 and io.input_node_id in (select protocol_app_node_id from apidbtuning.dwellingattributes)
          ]]>
    </sql>
    </sqlQuery>


 </querySet>

</wdkModel>
