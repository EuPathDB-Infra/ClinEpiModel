<wdkModel>

  <paramSet name="participantParams">
    
    <enumParam name="type"
               prompt="type"
               multiPick="false"
               quote="true"
               visible="false">
      <help>this is internal</help>
      <enumList>
        <enumValue default="true">
          <term>person</term>
          <internal>person</internal>
        </enumValue>
        <enumValue>
          <term>household</term>
          <internal>household</internal>
        </enumValue>  
      </enumList>
    </enumParam>

     <filterParam name="participants_by_all_metadata"
                 queryRef="ParticipantVQ.Participants"
                 metadataQueryRef="ParticipantVQ.ParticipantMetadataXProto"
                 metadataSpecQueryRef="ParticipantVQ.NodeMetadataSpecXProto"
                 prompt="Participant"
                 multiPick="true"
                 quote="true"
                 dependedParamRef="clinicalVisitParams.minAgeAtVisit,clinicalVisitParams.maxAgeAtVisit,participantParams.start_date,participantParams.end_date,participantParams.duration_observation"
                 suppressNode="true">
         <help>
              Select participants based on Characteristics. 
         </help>
         <!-- <suggest selectMode="all" /> -->
       </filterParam>

       <filterParamNew name="geographic_region" 
                       metadataQueryRef="ParticipantVQ.RegionMetaData"
                       ontologyQueryRef="ParticipantVQ.RegionOntology"
                       prompt="Participant"
                       trimMetadataTerms="false">
         <help>
           Select participants based on their geographic region. 
         </help>
    </filterParamNew>

       <filterParamNew name="dwellings_nf" 
                      metadataQueryRef="ParticipantVQ.DwellingMetaData"
                      ontologyQueryRef="ParticipantVQ.DwellingOntology"
                      backgroundQueryRef="ParticipantVQ.DwellingMetaDataBkgd"
                      prompt="Participants"
                      dependedParamRef="clinicalVisitParams.visits_visitage_metadata_nf,participantParams.start_date,participantParams.end_date,participantParams.duration_observation,participantParams.geographic_region"
                      trimMetadataTerms="false">
         <help>
              Select participants based on their characteristics. 
         </help>
       </filterParamNew>

       <filterParamNew name="participants_nf" 
                      metadataQueryRef="ParticipantVQ.ParticipantMetaData"
                      ontologyQueryRef="ParticipantVQ.ParticipantOntology"
                      backgroundQueryRef="ParticipantVQ.ParticipantMetaDataBkgd"
                      prompt="Participants"
                      trimMetadataTerms="false"
                      dependedParamRef="clinicalVisitParams.visits_visitage_metadata_nf,participantParams.start_date,participantParams.end_date,participantParams.duration_observation,participantParams.dwellings_nf,participantParams.geographic_region">
         <help>
              Select participants based on their characteristics. 
         </help>
       </filterParamNew>

       <filterParamNew name="visits_nf" 
                      metadataQueryRef="ParticipantVQ.VisitMetaData"
                      ontologyQueryRef="ParticipantVQ.VisitOntology"
                      backgroundQueryRef="ParticipantVQ.VisitMetaDataBkgd"
                      prompt="Visits"
                      trimMetadataTerms="false"
                      dependedParamRef="clinicalVisitParams.visits_visitage_metadata_nf,participantParams.start_date,participantParams.end_date,participantParams.duration_observation,participantParams.dwellings_nf,participantParams.geographic_region,participantParams.participants_nf">
         <help>
              Select participants based on their visit characteristics. 
         </help>
       </filterParamNew>

    
    <datasetParam name="participantsBySourceID" 
		  recordClassRef="ParticipantRecordClasses.ParticipantRecordClass"
		  prompt="Source ID input set">
      <help><![CDATA[Input a set of source IDs, or upload a file<br><br>

             It can be delimited by a comma, semi colon or any white space.<br><br>
             Its possible that not all the IDs in the list will be found in the database
             due to anumber of reasons such as unavailable ID mapping. It is currenly not
             possible to inform which IDs did not match anything in the database]]> </help>
     <suggest includeProjects="INIT" default="FILL" />
     <suggest default="3001" />
      
    </datasetParam>

   <stringParam name="duration_observation"
		 prompt="Days of observation &gt;= "
		 number="true">
      <help>Specify the minimum number of days from the date range that the participant was observed (ie, in the study).</help>
      <suggest default="1"/>
      <regex>\d\d*</regex>
    </stringParam>

   <stringParam name="max_visits"
		 prompt="Number of visits / year &lt;= "
		 number="true">
      <help>Specify the maximum number of visits per participant per year that match your visit criteria.</help>
      <suggest default="365"/>
      <regex>\d\d*\.*\d*</regex>
    </stringParam>

   <stringParam name="min_visits"
		 prompt="Number of visits / year &gt;= "
		 number="true">
      <help>Specify the minimum number of visits per participant per year that match your visit criteria.</help>
      <suggest default="0.1"/>
      <regex>\d\d*\.*\d*</regex>
    </stringParam>
   <stringParam name="max_para_density"
		 prompt="Geometric mean parasite density &lt;= "
		 number="true">
      <help>Specify the maximum average parasite density across the visits that match your visit criteria.</help>
      <suggest default="1000000"/>
      <regex>\d\d*</regex>
    </stringParam>

   <stringParam name="min_para_density"
		 prompt="Geometric mean parasite density &gt;= "
		 number="true">
      <help>Specify the minimum average parasite density across the visits that match your visit criteria.</help>
      <suggest default="0"/>
      <regex>\d\d*</regex>
    </stringParam>

   <stringParam name="max_anoph"
		 prompt="Average number of anopheles &lt;= "
		 number="true">
      <help>Specify the maximum average number of anopheles mosquitos collected per dwelling over the date range specified that match your criteria.</help>
      <suggest default="1000"/>
      <regex>\d\d*</regex>
    </stringParam>

   <stringParam name="min_anoph"
		 prompt="Average number of anopheles &gt;= "
		 number="true">
      <help>Specify the minimum average number of anopheles mosquitos collected per dwelling over the date range specified that match your criteria.</help>
      <suggest default="0"/>
      <regex>\d\d*</regex>
    </stringParam>

   <stringParam name="end_date"
		 prompt="Latest date to include in this search: "
		 number="false">
      <help>Put in the latest date to include for identifying participant visits and computing anopheles counts.</help>
      <suggest default="30-JUN-2016"/>
      <regex>\d\d*-\w\w\w-\d\d\d\d</regex>
    </stringParam>

   <stringParam name="start_date"
		 prompt="Earliest date to include in this search: "
		 number="false">
      <!-- visibleHelp>Put in the earliest date to include for identifying participant visits and computing anopheles counts.</visibleHelp -->
      <help>Put in the earliest date to include for identifying participant visits and computing anopheles counts.</help>
      <suggest default="05-AUG-2011"/>
      <regex>\d\d*-\w\w\w-\d\d\d\d</regex>
    </stringParam>

    <answerParam name="participant_result"
                  prompt="Input Result Set"
                  readonly="true"
                  visible="false">
       <recordClass ref="ParticipantRecordClasses.ParticipantRecordClass" />
    </answerParam>

  </paramSet>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!--  Vocab queries-->  
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

 <querySet name="ParticipantVQ" queryType="vocab" isCacheable="true">
   <sqlQuery name="Participants" excludeProjects="TrichDB,EuPathDB">
            <paramRef ref="clinicalVisitParams.minAgeAtVisit" />
            <paramRef ref="clinicalVisitParams.maxAgeAtVisit" />
            <paramRef ref="participantParams.start_date" />
            <paramRef ref="participantParams.end_date" />
            <paramRef ref="participantParams.duration_observation" />  
            <column name="internal"/>
            <column name="term"/>
            <sql>
         <![CDATA[
          select 
         nvl(pa.source_id,pa.name)  as term,
         nvl(pa.source_id,pa.name)  as internal
  from ApidbTuning.PersonAttributes pa, 
           (select CASE WHEN round($$maxAgeAtVisit$$) = $$maxAgeAtVisit$$ 
            THEN $$maxAgeAtVisit$$ + 0.99
            ELSE $$maxAgeAtVisit$$
            END as max_age
            from dual                    
           ) ma
  where least(to_date(pa.last_date_observed,'YYYYMMDD'), to_date($$end_date$$,'DD-MON-YYYY'), to_date(pa.date_of_birth,'YYYYMMDD') + ( ma.max_age * 365)) - greatest(pa.app_date, to_date($$start_date$$,'DD-MON-YYYY'), to_date(pa.date_of_birth,'YYYYMMDD') + ( $$minAgeAtVisit$$ * 365)) + 1 >= $$duration_observation$$
         ]]>
            </sql>

   </sqlQuery>

   <sqlQuery name="ParticipantMetadataCross">
            <column name="term"/>
            <column name="property"/>
            <column name="value"/>
            <sql>
         <![CDATA[
select * from (
                   select name as term,
           ontology_term_source_id as property,
           value as value
  from ApidbTuning.AppNodeCharacteristics
where type = 'person'
union 
select person.name as term,
             dwelling.ontology_term_source_id as property,
             dwelling.value as value
from ApidbTuning.AppNodeCharacteristics person,
     ApidbTuning.AppNodeCharacteristics dwelling,
     APIDBTUNING.PANAssociations pan
     
where  person.type = 'person'
  and  dwelling.type ='dwelling'
  and person.SOURCE_ID = pan.node_source_id
  and dwelling.source_id = pan.associated_node_source_id
  union 
  select person.name as term,
             cvd.ontology_term_source_id as property,
             cvd.value as value
from ApidbTuning.AppNodeCharacteristics person,
     ApidbTuning.AppNodeCharacteristics cvd,
     APIDBTUNING.PANAssociations pan
     
where  person.type = 'person'
  and  cvd.type ='clinical_visit_data'
  and person.SOURCE_ID = pan.node_source_id
  and cvd.source_id = pan.associated_node_source_id
    union 
select person.name as term,
             ltd.ontology_term_source_id as property,
             ltd.value as value
from ApidbTuning.AppNodeCharacteristics person,
     ApidbTuning.AppNodeCharacteristics ltd,
     APIDBTUNING.PANAssociations pan
     
where  person.type = 'person'
  and  ltd.type ='light_trap_data'
  and person.SOURCE_ID = pan.node_source_id
  and ltd.source_id = pan.associated_node_source_id)
where value is not null
order by term
]]>
            </sql>
   </sqlQuery>

   <sqlQuery name="ParticipantMetadataXProto">
            <paramRef ref="clinicalVisitParams.minAgeAtVisit" />
            <paramRef ref="clinicalVisitParams.maxAgeAtVisit" />
            <paramRef ref="participantParams.start_date" />
            <paramRef ref="participantParams.end_date" />
            <paramRef ref="participantParams.duration_observation" />  
            <column name="term"/>
            <column name="property"/>
            <column name="value"/>
            <sql>
         <![CDATA[
select li.* from (
           select name as term,
           ontology_term_source_id as property,
           (case when ontology_term_source_id in ( select distinct property 
                                     from apidbtuning.metadataspec
                                    where spec_property = 'type'
                                      and spec_value = 'date' )
                then substr(value,1,4) || '-' || substr(value,5,2)|| '-' || substr(value,7,2)
                else value
            end) as value
  from ApidbTuning.AppNodeCharacteristics
     
where type = 'person'
and ontology_term_source_id  in (select distinct property 
                       from ApidbTuning.MetadataSpec
                      
                      ) 
union 
select person.name as term,
             dwelling.ontology_term_source_id as property,
             dwelling.value as value
from ApidbTuning.AppNodeCharacteristics person,
     ApidbTuning.AppNodeCharacteristics dwelling,
     APIDBTUNING.PANAssociations pan
     
where  person.type = 'person'
  and  dwelling.type ='dwelling'
  and person.SOURCE_ID = pan.associated_node_source_id
  and dwelling.source_id = pan.node_source_id
) li, ApidbTuning.personAttributes pa,
        (select CASE WHEN round($$maxAgeAtVisit$$) = $$maxAgeAtVisit$$ 
            THEN $$maxAgeAtVisit$$ + 0.99
            ELSE $$maxAgeAtVisit$$
            END as max_age
            from dual                    
           ) ma
where li.value is not null
and li.term = pa.source_id
and least(to_date(pa.last_date_observed,'YYYYMMDD'), to_date($$end_date$$,'DD-MON-YYYY'), to_date(pa.date_of_birth,'YYYYMMDD') + ( ma.max_age * 365)) - greatest(pa.app_date, to_date($$start_date$$,'DD-MON-YYYY'), to_date(pa.date_of_birth,'YYYYMMDD') + ( $$minAgeAtVisit$$ * 365)) + 1 >= $$duration_observation$$
order by term

]]>
            </sql>
   </sqlQuery>

   <sqlQuery name="ParticipantMetadata">
            <column name="term"/>
            <column name="property"/>
            <column name="value"/>
            <sql>
         <![CDATA[
   select name as term,
           ontology_term_source_id as property,
           value as value
  from ApidbTuning.AppNodeCharacteristics
]]>
            </sql>
   </sqlQuery>


   <sqlQuery name="NodeMetadataSpec">
            <column name="property"/>
            <column name="spec_property"/>
            <column name="spec_value"/>
            <sql>
         <![CDATA[
select distinct property, spec_property, spec_value
  from ApidbTuning.MetadataSpec
where property not in (select property 
                         from ApidbTuning.MetadataSpec
                        where lower(spec_value) = 'do not display'
                      ) 
order by property
        ]]>
     </sql>
   </sqlQuery>

   <sqlQuery name="NodeMetadataSpecXProto">
            <column name="property"/>
            <column name="spec_property"/>
            <column name="spec_value"/>
            <sql>
         <![CDATA[
select distinct * from (
            Select mds.* from (
  select distinct property as property, spec_property, spec_value
  from ApidbTuning.MetadataSpec
  where ( entity_type in 'person' or entity_type = 'dwelling')
  and property not in  (select distinct property
                                       from Apidbtuning.metadataspec
                                     where lower(spec_value) = 'do not display'
                                            or property = 'rltshp')
    union select spec_value as property, 'parent' as spec_property, '' as spec_value
     from ApidbTuning.MetadataSpec
  where ( entity_type in 'person' or entity_type = 'dwelling')
  and spec_property = 'display'
  and property not in  (select distinct property
                                      from Apidbtuning.metadataspec
                                     where spec_property not in ( 'parent', 'leaf') ))mds,
  ( select property, nvl(spec_value, 9999999999) as ord_num from apidbtuning.metadataspec
     where spec_property = 'order_num') ord_num
     where mds.property = ord_num.property (+)
     and mds.spec_property not like 'order_num'
    order by to_number(ord_num), mds.property)


        ]]>
     </sql>
   </sqlQuery>

   <sqlQuery name="ParticipantOntology">
     <paramRef ref="clinicalVisitParams.visits_visitage_metadata_nf" />
     <paramRef ref="participantParams.start_date" />
     <paramRef ref="participantParams.end_date" />
     <paramRef ref="participantParams.duration_observation" />  
     <paramRef ref="participantParams.dwellings_nf" />  
     <paramRef ref="participantParams.geographic_region" />  
     <column name="ontology_term_name"/>
     <column name="parent_ontology_term_name"/>
     <column name="display_name"/>
     <column name="description"/>
     <column name="type"/>
     <column name="units"/>
     <column name="precision"/>
     <column name="is_range"/>
    <sql>
         <![CDATA[
/*                  select o.ontology_term_name, o.parent_ontology_term_name, o.display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.metadataontology o, 
(select distinct term
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'study participant information') md
 where o.ontology_term_name = md.term
*/
with leaf as ( select o.ontology_term_name, o.parent_ontology_term_name, o.display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.metadataontology o, 
(select distinct term
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'study participant information') md
 where o.ontology_term_name = md.term)
 select * from leaf
 union
 select distinct parent_ontology_term_name as ontology_term_name, null as parent_ontology_term_name, parent_ontology_term_name as diaplay_name,
 null as description, null as units, null as type, null as is_range, null as precision
 from leaf
 where parent_ontology_term_name is not null
         ]]>
    </sql>
   </sqlQuery>

       <sqlQuery name="ParticipantMetaData">
         <paramRef ref="clinicalVisitParams.visits_visitage_metadata_nf" />
         <paramRef ref="participantParams.start_date" />
         <paramRef ref="participantParams.end_date" />
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.dwellings_nf" />  
         <paramRef ref="participantParams.geographic_region" />  
     <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.protocol_app_node_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
from apidbtuning.metadata m
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'study participant information'
 and m.protocol_app_node_id in ($$dwellings_nf$$)
          ]]>
    </sql>
    </sqlQuery>

           <sqlQuery name="ParticipantMetaDataBkgd">
         <paramRef ref="clinicalVisitParams.visits_visitage_metadata_nf" />
         <paramRef ref="participantParams.start_date" />
         <paramRef ref="participantParams.end_date" />
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.dwellings_nf" />  
         <paramRef ref="participantParams.geographic_region" />  
     <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.protocol_app_node_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
from apidbtuning.metadata m
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'study participant information'
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="RegionOntology">
      <column name="ontology_term_name"/>
      <column name="parent_ontology_term_name"/>
      <column name="display_name"/>
      <column name="description"/>
      <column name="type"/>
      <column name="units"/>
      <column name="precision"/>
      <column name="is_range"/>
      <sql>
        <![CDATA[
                 select o.ontology_term_name, 'dummy' as parent_ontology_term_name, o.display_name, o.description, o.units,o.type,o.is_range,o.precision
                 from apidbtuning.metadataontology o 
                 where o.ontology_term_name = 'subcounty in Uganda'
                 union
                 select 'dummy' as ontology_term_name, null as parent_ontology_term_name, 'Dwelling' as display_name, null as description, null as units, 'string' as type, 0 as is_range,
                 null as precision from dual
        ]]>
      </sql>
    </sqlQuery>
    
    <sqlQuery name="RegionMetaData">
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
--TODO: use participantAttributes to make part more efficient
select distinct Part.output_Node_Id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata m,
 (select distinct io.output_node_id,io.input_node_id
  from apidbtuning.protocolappnodeio io --, apidbtuning.participantattributes pa
  where io.output_node_id in (select distinct protocol_app_node_id from apidbtuning.metadata where category = 'study participant information') --= pa.protocol_app_node_id
  ) part
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'dwelling'
 and m.term = 'subcounty in Uganda'
 and part.input_node_id = m.protocol_app_node_id
        ]]>
      </sql>
    </sqlQuery>

       <sqlQuery name="DwellingOntology">
         <paramRef ref="clinicalVisitParams.visits_visitage_metadata_nf" />
         <paramRef ref="participantParams.start_date" />
         <paramRef ref="participantParams.end_date" />
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.geographic_region" />  
        <column name="ontology_term_name"/>
        <column name="parent_ontology_term_name"/>
        <column name="display_name"/>
        <column name="description"/>
        <column name="type"/>
        <column name="units"/>
        <column name="precision"/>
        <column name="is_range"/>
    <sql>
--TODO:  union in light trap summary ontology
--TODO:  put in proper recursive search against ontology to get parent tree
  with leaf as (select o.ontology_term_name, o.parent_ontology_term_name, o.display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.metadataontology o, 
(select distinct term
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'dwelling') md
 where o.ontology_term_name = md.term)
 select * from leaf
 union
 select distinct parent_ontology_term_name as ontology_term_name, null as parent_ontology_term_name, parent_ontology_term_name as diaplay_name,
 null as description, null as units, null as type, null as is_range, null as precision
 from leaf
 where parent_ontology_term_name is not null
 union
 select 'average anopheles' as ontology_term_name, null as parent_ontology_term_name, 'Average Anopheles Collected' as display_name, 'Average number of Anopheles collected in monthly CDC light traps during the dates of this search' as description, null as units, 'number' as type, 1 as is_range,
 null as precision from dual
 
    </sql>
    </sqlQuery>

    <sqlQuery name="DwellingMetaData">
      <paramRef ref="clinicalVisitParams.visits_visitage_metadata_nf" />
      <paramRef ref="participantParams.start_date" />
      <paramRef ref="participantParams.end_date" />
      <paramRef ref="participantParams.duration_observation" />  
      <paramRef ref="participantParams.geographic_region" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
--TODO once dates correct type remove to_date for attribute columns and to_number for age column
with part as ( select distinct io.input_node_id, io.output_node_id 
  from (select min(EUPATH_0000113) as min_age, max(EUPATH_0000113) as max_age
   from apidbtuning.clinicalvisitattributes 
   where protocol_app_node_id in ($$visits_visitage_metadata_nf$$)
   ) age,
   apidbtuning.participantattributes pa, apidbtuning.protocolappnodeio io
   where pa.protocol_app_node_id in ($$geographic_region$$)
   AND least(pa.EUPATH_0000152, to_date($$end_date$$,'DD-MON-YYYY'), pa.EUPATH_0000032 + ( age.max_age * 365)) - 
       greatest(to_date(pa.EUPATH_0000151,'YYYY-MM-DD'), to_date($$start_date$$,'DD-MON-YYYY'), pa.EUPATH_0000032 + ( age.min_age * 365)) + 1 >= 1
 and pa.protocol_app_node_id = io.output_node_id)
 select distinct Part.output_Node_Id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata m, part
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'dwelling'
 and part.input_node_id = m.protocol_app_node_id
 union
 select part.output_node_id as internal, 'average anopheles' as ontology_term_name, null as string_value, nvl(mos.avg_anoph,0) as number_value, null as date_value
 from (select da.protocol_app_node_id, round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as avg_anoph
  from apidbtuning.dwellingattributes da, apidbtuning.protocolappnodeio io, apidbtuning.lighttrapattributes la
  where da.protocol_app_node_id = io.input_node_id
  and la.protocol_app_node_id = io.output_node_id
  and la.OBI_0001619 >= to_date($$start_date$$,'DD-MON-YYYY') 
  and la.OBI_0001619 <= to_date($$end_date$$,'DD-MON-YYYY') 
  group by da.protocol_app_node_id) mos, part
 where part.input_node_id = mos.protocol_app_node_id(+)
          ]]>
    </sql>    

    </sqlQuery>

    <sqlQuery name="DwellingMetaDataBkgd">
      <paramRef ref="clinicalVisitParams.visits_visitage_metadata_nf" />
      <paramRef ref="participantParams.start_date" />
      <paramRef ref="participantParams.end_date" />
      <paramRef ref="participantParams.duration_observation" />  
      <paramRef ref="participantParams.geographic_region" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
 with part as (
select io.input_node_id, io.output_node_id
  from apidbtuning.protocolappnodeio io, apidbtuning.participantattributes pa
  where io.output_node_id = pa.protocol_app_node_id
)
select distinct Part.output_Node_Id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata m, part
  where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'dwelling'
 and part.input_node_id = m.protocol_app_node_id
 union
 select part.output_node_id as internal, 'average anopheles' as ontology_term_name, null as string_value, mos.avg_anoph as number_value, null as date_value
 from (select da.protocol_app_node_id, round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as avg_anoph
  from apidbtuning.dwellingattributes da, apidbtuning.protocolappnodeio io, apidbtuning.lighttrapattributes la
  where da.protocol_app_node_id = io.input_node_id
  and la.protocol_app_node_id = io.output_node_id
  group by da.protocol_app_node_id) mos, part
  where part.input_node_id = mos.protocol_app_node_id(+)
          ]]>
    </sql>    

    </sqlQuery>

   <sqlQuery name="VisitOntology">
      <paramRef ref="clinicalVisitParams.visits_visitage_metadata_nf" />
     <paramRef ref="participantParams.start_date" />
     <paramRef ref="participantParams.end_date" />
     <paramRef ref="participantParams.duration_observation" />  
     <paramRef ref="participantParams.dwellings_nf" />  
     <paramRef ref="participantParams.geographic_region" />  
     <paramRef ref="participantParams.participants_nf" />  
     <column name="ontology_term_name"/>
     <column name="parent_ontology_term_name"/>
     <column name="display_name"/>
     <column name="description"/>
     <column name="type"/>
     <column name="units"/>
     <column name="precision"/>
     <column name="is_range"/>
    <sql>
         <![CDATA[
with leaf as ( select o.ontology_term_name, o.parent_ontology_term_name, o.display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.metadataontology o, 
(select distinct term
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'clinical visit information') md
 where o.ontology_term_name = md.term)
 select * from leaf
 union
 select distinct parent_ontology_term_name as ontology_term_name, null as parent_ontology_term_name, parent_ontology_term_name as diaplay_name,
 null as description, null as units, null as type, null as is_range, null as precision
 from leaf
 where parent_ontology_term_name is not null 
         ]]>
    </sql>
   </sqlQuery>

       <sqlQuery name="VisitMetaData">
         <paramRef ref="clinicalVisitParams.visits_visitage_metadata_nf" />
         <paramRef ref="participantParams.start_date" />
         <paramRef ref="participantParams.end_date" />
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.dwellings_nf" />  
         <paramRef ref="participantParams.geographic_region" />  
         <paramRef ref="participantParams.participants_nf" />  
         <column name="ontology_term_name"/>
         <column name="internal"/>
         <column name="number_value"/>
         <column name="date_value"/>
         <column name="string_value"/>
         <sql>
           <![CDATA[
select distinct va.protocol_app_node_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata m, apidbtuning.protocolappnodeio io, apidbtuning.clinicalvisitattributes va
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'clinical visit information'
 and m.protocol_app_node_id = va.protocol_app_node_id
 and va.protocol_app_node_id in ($$visits_visitage_metadata_nf$$)
 and io.output_Node_Id = va.protocol_app_node_id
 and io.input_node_id in ($$participants_nf$$)
 and va.EUPATH_0000091 >= to_date($$start_date$$,'DD-MON-YYYY')
 and va.EUPATH_0000091 <= to_date($$end_date$$,'DD-MON-YYYY')
          ]]>
    </sql>
    </sqlQuery>    

    <sqlQuery name="VisitMetaDataBkgd">
         <paramRef ref="clinicalVisitParams.visits_visitage_metadata_nf" />
         <paramRef ref="participantParams.start_date" />
         <paramRef ref="participantParams.end_date" />
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.dwellings_nf" />  
         <paramRef ref="participantParams.geographic_region" />  
         <paramRef ref="participantParams.participants_nf" />  
         <column name="ontology_term_name"/>
         <column name="internal"/>
         <column name="number_value"/>
         <column name="date_value"/>
         <column name="string_value"/>
         <sql>
           <![CDATA[
 select distinct protocol_app_node_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata 
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'clinical visit information'
          ]]>
    </sql>
    </sqlQuery>

  </querySet>    

      <groupSet name="metaDataGroups">
        
        <group name="daterange" displayName="Time period" displayType="ShowHide">
            <description>
                <![CDATA[
Select the minimum and maximum dates (ie, the date range) to be considered in this search.  Also set the number of days that the participant was in the study (observed) over that date range.  Note: the observation time is impacted by the age range selected in the previous parameter. Data currently loaded ranges 05-AUG-2015 to 31-MAR-2015
                ]]>
            </description>
        </group>
        <group name="age_at_visit" displayName="Age" displayType="ShowHide">
            <description>
                <![CDATA[
You can modify the age range of the participants at the time of their visits.  The defaults include all children in the study aged between 0.5 and 11 years, adults from 18 to 75 years of age.
                ]]>
            </description>
        </group>
        <group name="part_characteristics" displayName="Personal characteristics" displayType="ShowHide">
            <description>
                <![CDATA[
You can restrict the participants returned in your search by selecting their characteristics such as genotype information.
                ]]>
            </description>
        </group>
        <group name="visit_part_characteristics" displayName="Personal characteristics" displayType="ShowHide">
            <description>
                <![CDATA[
You can restrict visits returned based on participants by selecting characteristics about where they live including their dwelling type and their own characteristics such as genotype information.
                ]]>
            </description>
        </group>
        <group name="part_dwelling_characteristics" displayName="Dwellings" displayType="ShowHide">
            <description>
                <![CDATA[
You can restrict participants returned based on where they live including their region, dwelling type and mosquito collections in their home. 
                ]]>
            </description>
        </group>
        <group name="geographic_loc" displayName="Geographic Region" displayType="ShowHide">
            <description>
                <![CDATA[
You can restrict based on the region where they live. 
                ]]>
            </description>
        </group>
        <group name="visit_visit_characteristics" displayName="Visit visits" displayType="ShowHide">
            <description>
                <![CDATA[
You can restrict the visits returned in your search by selecting characteristics such as the type of visit, diagnosis, visit tpye, etc.
                ]]>
            </description>
        </group>
        <group name="visit_characteristics" displayName="Visits" displayType="ShowHide">
            <description>
                <![CDATA[
You can restrict the participants returned in your search by selecting characteristics of their clinical visits such as the type of their visit and their diagnosis at that visit.  Note that the numbers shown as you make selections are the number of visits selected, not the number of participants.
                ]]>
            </description>
        </group>
       <group name="part_visit_characteristics" displayName="Visits" displayType="ShowHide">
            <description>
                <![CDATA[
You can restrict the participants returned in your search by selecting characteristics of their clinical visits such as the type of their visit and their diagnosis at that visit.  Note that the numbers shown as you make selections are the number of visits selected, not the number of participants.
                ]]>
            </description>
        </group>
        <group name="summary_params" displayName="Visit aggregates" displayType="ShowHide">
            <description>
                <![CDATA[
You can further restrict the participants returned in your search by setting summary values such as the average parasitemia or the number of visits / year of the visits matching the previous step characteristics.
                ]]>
            </description>
        </group>
        <group name="relative_visits" displayName="Relative visits" displayType="ShowHide">
            <description>
                <![CDATA[
                         You can further restrict the visits you have selected above by removing (or keeping) those visits based on a relative visit you define below.  For example, you may want to only keep visits with a diagnosis of asymptomatic parasitemia from above if they are not followed within 14 days by a visit where the participant was diagnosed with malaria.  In this instance, set the number of days to 14, direction after and remove visits where diagnosis of malaria = yes.
                ]]>
            </description>
        </group>


    </groupSet>

</wdkModel>
