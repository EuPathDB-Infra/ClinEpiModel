<wdkModel>

  <constant name="participantIdTransformSql1">
    <![CDATA[
      select distinct io.output_pan_id as internal
       from ApidbTuning.$$tbl_prefix$$PANIO io,
         (##FILTERED_IDS##) fi
       where io.input_pan_id = fi.internal
        and io.output_pan_type_source_id = 'EUPATH_0000096'
    ]]>   
  </constant>
  
  <constant name="participantIdTransformSql2">
    <![CDATA[
      select distinct io.input_pan_id as internal
       from ApidbTuning.$$tbl_prefix$$PANIO io,
        (##FILTERED_IDS##) fi
       where io.output_pan_id = fi.internal
        and io.input_pan_type_source_id = 'EUPATH_0000096'
    ]]>     
  </constant>
  
  <constant name="participantIdTransformSql3">
    <![CDATA[
      select internal from (##FILTERED_IDS##)
    ]]> 
  </constant>   

  <paramSet name="participantParams">
    
    <enumParam name="type"
               prompt="type"
               multiPick="false"
               quote="true"
               visible="false">
      <help>this is internal</help>
      <enumList>
        <enumValue default="true">
          <term>person</term>
          <internal>person</internal>
        </enumValue>
        <enumValue>
          <term>household</term>
          <internal>household</internal>
        </enumValue>  
      </enumList>
    </enumParam>

    <stringParam name="dataset"
		 prompt="Study: "
		 number="false">
      <help>Specify the dataset for this study</help>
      <suggest default="Default Study"/>
    </stringParam>

        <stringParam name="tbl_prefix"
		 prompt="Table Prefix: "
		 number="false"
                 isSql="true">
      <help>Specify the dataset for this study</help>
      <suggest default="Default prefix"/>
    </stringParam>

    <numberParam name="duration_observation"
		 prompt="Days of observation &gt;= "
		 integer="true"
                 min="1"
                 max="2000">
      <help>Specify the minimum number of days that the participant was observed (ie, met the age/date criteria).</help>
      <suggest default="1"/>
    </numberParam>

    <numberRangeParam name="visit_count"
                      prompt="Number of Matching Observations: "
                      integer="true"
                      min="1"
                      max="1000">
      <help>Set the range of number of observations that match your search criteria.</help>
      <!--         <suggest default="{'min': '1', 'max': '10'}" />  -->
    </numberRangeParam>

        <numberRangeParam name="visits_per_year"
                      prompt="Observations per year:"
                      integer="false"
                      min="0"
                      max="365"
                      step="0.1">
      <help>Set the range of number of observations that match your search criteria.</help>
      <!--         <suggest default="{'min': '1', 'max': '10'}" />  -->
    </numberRangeParam>

    <numberRangeParam name="parasite_density"
                      prompt="Parasite Density (geometric mean):"
                      integer="true"
                      min="0"
                      max="1000000">
      <help>Set the range of days between observations to compare to observations selected in the previous step</help>
      <!--         <suggest default="{'min': '1', 'max': '10'}" />  -->
    </numberRangeParam> 



    <datasetParam name="participantsBySourceID" 
		  recordClassRef="ParticipantRecordClasses.ParticipantRecordClass"
		  prompt="Source ID input set">
      <help><![CDATA[Input a set of source IDs, or upload a file<br><br>

             It can be delimited by a comma, semi colon or any white space.<br><br>
             Its possible that not all the IDs in the list will be found in the database
             due to anumber of reasons such as unavailable ID mapping. It is currenly not
             possible to inform which IDs did not match anything in the database]]> </help>
     <suggest includeProjects="INIT" default="FILL" />
     <suggest default="3001" />
      
    </datasetParam>

    <answerParam name="participant_result"
                 prompt="Input Result Set"
                 readonly="true"
                 visible="false">
      <recordClass ref="ParticipantRecordClasses.ParticipantRecordClass" />
    </answerParam>

    <!--************************************************************-->
    <!--   PRISM section ... should be injected  -->
    <!--   TODO: DELETE THIS AND COPY OVER FROM BRANCH ... ADD PRISM SUFFIX -->
    <!--************************************************************-->

       <filterParamNew name="geographic_region" 
                       metadataQueryRef="ParticipantVQ.RegionMetaData"
                       ontologyQueryRef="ParticipantVQ.RegionOntology"
                       filterDataTypeDisplayName="Participants"
                       prompt="Geographic region"
                       trimMetadataTerms="false">
         <help>
           Select participants based on their geographic region. 
         </help>
    </filterParamNew>

       <filterParamNew name="households_nf" 
                      metadataQueryRef="ParticipantVQ.HouseholdMetaData"
                      ontologyQueryRef="ParticipantVQ.HouseholdOntology"
                      backgroundQueryRef="ParticipantVQ.HouseholdMetaDataBkgd"
                      useIdTransformSqlForInternalValue="true"
                      prompt="Households"
                      dependedParamRef="participantParams.visits_visitage_metadata_nf,clinicalVisitParams.visit_date,participantParams.duration_observation,participantParams.geographic_region,participantParams.participants_nf"
                      trimMetadataTerms="false">
         <idTransformSql>%%participantIdTransformSql3%%</idTransformSql>             
         <help>
              Select participants based on the characteristics of the household where they live. 
         </help>
       </filterParamNew>

       <filterParamNew name="participants_nf" 
                      metadataQueryRef="ParticipantVQ.ParticipantMetaData"
                      ontologyQueryRef="ParticipantVQ.ParticipantOntology"
                      backgroundQueryRef="ParticipantVQ.ParticipantMetaDataBkgd"
                      prompt="Participants"
                      trimMetadataTerms="false"
                      dependedParamRef="participantParams.visits_visitage_metadata_nf,clinicalVisitParams.visit_date,participantParams.duration_observation,participantParams.geographic_region">
         <help>
           Select participants based on their characteristics. 
         </help>
       </filterParamNew>

       <filterParamNew name="visits_nf" 
                    metadataQueryRef="ParticipantVQ.VisitMetaData"
                    ontologyQueryRef="ParticipantVQ.VisitOntology"
                    backgroundQueryRef="ParticipantVQ.VisitMetaDataBkgd"
                    prompt="Clincial Observations"
                    trimMetadataTerms="false"
                    dependedParamRef="participantParams.visits_visitage_metadata_nf,clinicalVisitParams.visit_date,participantParams.duration_observation,participantParams.households_nf,participantParams.geographic_region,participantParams.participants_nf">
      <idTransformSql>%%participantIdTransformSql3%%</idTransformSql>    
      <help>
        Select participants based on their visit characteristics. 
      </help>
    </filterParamNew>

    <filterParamNew name="visits_visitage_metadata_nf" 
                      metadataQueryRef="ParticipantVQ.ClinicalVisitAgeMetaDataNf"
                      ontologyQueryRef="ParticipantVQ.ClinicalVisitAgeOntologyNf"
                      backgroundQueryRef="ParticipantVQ.ClinicalVisitAgeMetaDataBkgdNf"
                      prompt="Age at visit"
                      dependedParamRef="participantParams.geographic_region,clinicalVisitParams.visit_date"
                      trimMetadataTerms="false">
         <idTransformSql>%%participantIdTransformSql3%%</idTransformSql>                 
         <help>
              Select reference samples. 
         </help>
       </filterParamNew>


    <!--************************************************************-->
    <!--   MAL-ED section ... should be injected  -->
    <!--************************************************************-->

       <filterParamNew name="geographic_region_maled" 
                       metadataQueryRef="ParticipantVQ.RegionMetaData_maled"
                       ontologyQueryRef="ParticipantVQ.RegionOntology_maled"
                       filterDataTypeDisplayName="Participants"
                       prompt="Geographic region"
                       dependedParamRef="participantParams.tbl_prefix"
                       trimMetadataTerms="false">
         <help>
           Select participants based on their geographic region. 
         </help>
    </filterParamNew>

       <filterParamNew name="households_nf_maled" 
                      metadataQueryRef="ParticipantVQ.HouseholdMetaData_maled"
                      ontologyQueryRef="ParticipantVQ.HouseholdOntology_maled"
                      backgroundQueryRef="ParticipantVQ.HouseholdMetaDataBkgd_maled"
                      useIdTransformSqlForInternalValue="true"
                      prompt="Households"
                      dependedParamRef="participantParams.tbl_prefix,participantParams.participants_nf_maled"
                      trimMetadataTerms="false">
         <idTransformSql>%%participantIdTransformSql1%%</idTransformSql>             
         <help>
              Select participants based on the characteristics of the household where they live. 
         </help>
       </filterParamNew>

       <filterParamNew name="participants_nf_maled" 
                      metadataQueryRef="ParticipantVQ.ParticipantMetaData_maled"
                      ontologyQueryRef="ParticipantVQ.ParticipantOntology_maled"
                      backgroundQueryRef="ParticipantVQ.ParticipantMetaDataBkgd_maled"
                      filterDataTypeDisplayName="Participants"
                      prompt="Personal characteristics"
                      trimMetadataTerms="false"
                      dependedParamRef="participantParams.tbl_prefix,participantParams.geographic_region_maled">
         <help>
              Select participants based on their characteristics. 
         </help>
       </filterParamNew>

       <filterParamNew name="visits_nf_maled" 
                       metadataQueryRef="ParticipantVQ.VisitMetaData_maled"
                       ontologyQueryRef="ParticipantVQ.VisitOntology_maled"
                       backgroundQueryRef="ParticipantVQ.VisitMetaDataBkgd_maled"
                       prompt="Observations"
                       trimMetadataTerms="false"
                       dependedParamRef="participantParams.tbl_prefix,participantParams.households_nf_maled">
         <idTransformSql>%%participantIdTransformSql2%%</idTransformSql>   
         <help>
           Select participants based on their visit characteristics. 
         </help>
       </filterParamNew>

    
    <!--************************************************************-->
    <!--   GEMS section ... -->
    <!--************************************************************-->

    <!--  ontologyQueryRef="ParticipantVQ.GeographicRegionOntology_gems" -->

       <filterParamNew name="geographic_region_gems" 
                       ontologyQueryRef="ParticipantVQ.GeographicRegionOntology_gems" 
                       metadataQueryRef="ParticipantVQ.GeographicRegionMetaData_gems"
                       ontologyValuesQueryRef="ParticipantVQ.GeographicRegionOntologyValues_gems"
                       filterDataTypeDisplayName="Participants"
                       prompt="Study Site"
                       trimMetadataTerms="false"
                       countPredictsAnswerCount="true"
                       dependedParamRef="participantParams.tbl_prefix">
         <help>
           Select participants based on their personal and household
           characteristics.
         </help>
       </filterParamNew>
       
       <filterParamNew name="participant_dwelling_gems" 
                       metadataQueryRef="ParticipantVQ.ParticipantDwellingMetaData_gems"
                       ontologyQueryRef="ParticipantVQ.ParticipantDwellingOntology_gems"
                       backgroundQueryRef="ParticipantVQ.AllParticipantNoDependencies_gems"
                       ontologyValuesQueryRef="ParticipantVQ.AllParticipantNoDependenciesOntologyValues_gems"
                       filterDataTypeDisplayName="Participants"
                       prompt="Participant"
                       trimMetadataTerms="false"
                       countPredictsAnswerCount="true"
                       dependedParamRef="participantParams.tbl_prefix,participantParams.case_control,participantParams.geographic_region_gems">
         <help>
           Select participants based on study site. 
         </help>
       </filterParamNew>

       <enumParam name="case_control"
                  prompt="Cases or Controls"
                  multiPick="false"
                  quote="false"
                  visible="true">
         <help>Choose whether to search for cases, controls or either.</help>
         <enumList>
           <enumValue default="true">
             <term>Both Cases and Controls</term>
             <internal>'case','control'</internal>
           </enumValue>
           <enumValue>
             <term>Cases</term>
             <internal>'case'</internal>
           </enumValue>
           <enumValue>
             <term>Controls</term>
             <internal>'control'</internal>
           </enumValue>  
         </enumList>
       </enumParam>

       <filterParamNew name="all_data_gems" 
                       metadataQueryRef="ParticipantVQ.AllDataMetaData_gems"
                       ontologyQueryRef="ParticipantVQ.AllDataOntology_gems"
                       backgroundQueryRef="ParticipantVQ.AllParticipantNoDependencies_gems"
                       ontologyValuesQueryRef="ParticipantVQ.AllParticipantNoDependenciesOntologyValues_gems"
                       filterDataTypeDisplayName="Participants"
                       prompt="Participant"
                       trimMetadataTerms="false"
                       countPredictsAnswerCount="true"
                       dependedParamRef="participantParams.tbl_prefix,participantParams.case_control">
         <help>
           Select participants based on variables associated with their enrollment or followup events. 
         </help>
       </filterParamNew>

       <filterParamNew name="event_gems" 
                       metadataQueryRef="ParticipantVQ.EventMetaData_gems"
                       ontologyQueryRef="ParticipantVQ.EventOntology_gems"
                       backgroundQueryRef="ParticipantVQ.AllParticipantNoDependencies_gems"
                       ontologyValuesQueryRef="ParticipantVQ.EventOntologyValues_gems"
                       filterDataTypeDisplayName="Participants"
                       prompt="Observations"
                       trimMetadataTerms="false"
                       countPredictsAnswerCount="true"
                       dependedParamRef="participantParams.tbl_prefix,participantParams.participant_dwelling_gems">
         <help>
           Select participants based on variables associated with their enrollment or followup events. 
         </help>
       </filterParamNew>       

       <enumParam name="use_rel_case_control"
                prompt="Compare Cases / Controls"
                multiPick="false"
                quote="false"
                visible="true">
       <help>You MUST change this parameter to Yes in order to use relative observations! If you decide to not use relative observations, set this parameter to No and make certain "Keep or remove observations" is set to remove.</help>
         <enumList>
           <enumValue default="true">
             <term>No</term>
             <internal>0</internal>
           </enumValue>
           <enumValue>
             <term>Yes</term>
             <internal>1</internal>
           </enumValue>  
         </enumList>
       </enumParam>

        <flatVocabParam name="keep_remove"
               prompt="Keep or Remove participants based on case control comparisons"
               multiPick="false"
               quote="false"
               visible="true"
               dependedParamRef="participantParams.use_rel_case_control"
               queryRef="ParticipantVQ.KeepRemove">
      <help>Choose what to do as you compare cases and controls.  Do you want to keep or remove participants with cases and controls that match your selected criteria. </help>
    </flatVocabParam>

       <filterParamNew name="relative_event_gems" 
                       ontologyQueryRef="ParticipantVQ.EventOntology_gems"
                       metadataQueryRef="ParticipantVQ.RelativeEventMetaData_gems"
                       backgroundQueryRef="ParticipantVQ.AllParticipantNoDependencies_gems"
                       ontologyValuesQueryRef="ParticipantVQ.EventOntologyValues_gems"
                       filterDataTypeDisplayName="Participants"
                       prompt="Related Case or Control"
                       trimMetadataTerms="false"
                       countPredictsAnswerCount="false"
                       dependedParamRef="participantParams.tbl_prefix,participantParams.case_control">
         <help>
           Modify participants selected based on information about their related case or control. 
         </help>
       </filterParamNew>    

       <enumParam name="return_case_control"
                  prompt="Which participants to return"
                  multiPick="false"
                  quote="true"
                  visible="true">
         <help>Choose whether to return just the participants you have selected, to include the cases/controls for those selected participants, or to return only the related cases/controls for the selected participants.</help>
         <enumList>
           <enumValue default="true">
             <term>Return selected participants only</term>
             <internal>selected</internal>
           </enumValue>
           <enumValue>
             <term>Return both the selected participants and their matching cases/controls</term>
             <internal>caseid</internal>
           </enumValue>  
<!--           <enumValue>
             <term>Return only the matching cases / controls for the selected participants</term>
             <internal>matching</internal>
           </enumValue>  
-->
         </enumList>
       </enumParam>
       
  </paramSet>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!--  Vocab queries-->  
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

 <querySet name="ParticipantVQ" queryType="vocab" isCacheable="true">

    <!--************************************************************-->
    <!--   PRISM section ... should be injected  -->
    <!--************************************************************-->

   <sqlQuery name="ParticipantOntology">
     <column name="ontology_term_name"/>
     <column name="parent_ontology_term_name"/>
     <column name="display_name"/>
     <column name="description"/>
     <column name="type"/>
     <column name="units"/>
     <column name="precision"/>
     <column name="is_range"/>
    <sql>
         <![CDATA[
with leaf as ( 
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from ApidbTuning.$$tbl_prefix$$Ontology o, 
(select distinct term
 from ApidbTuning.$$tbl_prefix$$MetaData
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'Child'
 and source_id != 'EUPATH_0000032') md
 where o.ontology_term_name = md.term),
first as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from leaf where parent_ontology_term_name is not null) par
 where o.ontology_term_name = par.parent_ontology_term_name),
 second as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from first where parent_ontology_term_name is not null) gpar
 where o.ontology_term_name = gpar.parent_ontology_term_name)
 select * from leaf
 union
 select * from first
 union
 select * from second
 union
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from second where parent_ontology_term_name is not null) ggpar
 where o.ontology_term_name = ggpar.parent_ontology_term_name
         ]]>
    </sql>
   </sqlQuery>

       <sqlQuery name="ParticipantMetaData" isCacheable="true">
         <paramRef ref="participantParams.visits_visitage_metadata_nf" />
         <paramRef ref="clinicalVisitParams.visit_date" /> 
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.geographic_region" />  
     <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.pan_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
  from (select min(EUPATH_0000113) as min_age, max(EUPATH_0000113) as max_age
   from ApidbTuning.$$tbl_prefix$$Observations 
   where pan_id in ($$visits_visitage_metadata_nf$$)
   ) age,
   ApidbTuning.$$tbl_prefix$$Participants pa, ApidbTuning.$$tbl_prefix$$PANIO iov, ApidbTuning.$$tbl_prefix$$MetaData m
   where pa.pan_id in ($$geographic_region$$)
   AND least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EUPATH_0000032 + ( age.max_age * 365)) - 
       greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EUPATH_0000032 + ( age.min_age * 365)) + 1 >= $$duration_observation$$
       and pa.pan_id = iov.input_pan_id
       and iov.output_pan_id in ($$visits_visitage_metadata_nf$$)
       and pa.pan_id = m.pan_id
       and m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
       and m.category = 'Child'
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="ParticipantMetaDataBkgd">
         <paramRef ref="participantParams.visits_visitage_metadata_nf" />
         <paramRef ref="clinicalVisitParams.visit_date" /> 
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.geographic_region" />  
     <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.pan_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'Child'
          ]]>
    </sql>
    </sqlQuery>

    
    <sqlQuery name="VisitOntology">
     <column name="ontology_term_name"/>
     <column name="parent_ontology_term_name"/>
     <column name="display_name"/>
     <column name="description"/>
     <column name="type"/>
     <column name="units"/>
     <column name="precision"/>
     <column name="is_range"/>
    <sql>
         <![CDATA[
with leaf as ( select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from ApidbTuning.$$tbl_prefix$$Ontology o, 
(select distinct term
 from ApidbTuning.$$tbl_prefix$$MetaData
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category in ('Visit','Specimen type')
 and source_id != 'EUPATH_0000094') md
 where o.ontology_term_name = md.term),
first as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from leaf where parent_ontology_term_name is not null) par
 where o.ontology_term_name = par.parent_ontology_term_name),
 second as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from first where parent_ontology_term_name is not null) gpar
 where o.ontology_term_name = gpar.parent_ontology_term_name)
 select * from leaf
 union
 select * from first
 union
 select * from second
 union
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from second where parent_ontology_term_name is not null) ggpar
 where o.ontology_term_name = ggpar.parent_ontology_term_name
         ]]>
    </sql>
   </sqlQuery>

       <sqlQuery name="VisitMetaData" isCacheable="true">
         <paramRef ref="participantParams.visits_visitage_metadata_nf" />
         <paramRef ref="clinicalVisitParams.visit_date" /> 
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.households_nf" />  
         <paramRef ref="participantParams.geographic_region" />  
         <paramRef ref="participantParams.participants_nf" />  
         <column name="ontology_term_name"/>
         <column name="internal"/>
         <column name="number_value"/>
         <column name="date_value"/>
         <column name="string_value"/>
         <sql>
           <![CDATA[
with valid as (
select distinct io.output_pan_id as visit_id, io.input_pan_id as part_id
from ApidbTuning.$$tbl_prefix$$PANIO io
where io.input_pan_id in ($$households_nf$$)
and io.output_pan_id in ($$visits_visitage_metadata_nf$$)
)
select distinct valid.visit_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, valid
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'Visit'
 and m.pan_id = valid.visit_id
  union
 select valid.visit_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m, valid, ApidbTuning.$$tbl_prefix$$PANIO ios
where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
and m.category = 'Specimen type' 
and m.term = 'Specimen type'
and ios.output_pan_id = m.pan_id
and ios.input_pan_id = valid.visit_id
          ]]>
    </sql>
    </sqlQuery>    

    <sqlQuery name="VisitMetaDataBkgd">
         <paramRef ref="participantParams.visits_visitage_metadata_nf" />
         <paramRef ref="clinicalVisitParams.visit_date" /> 
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.households_nf" />  
         <paramRef ref="participantParams.geographic_region" />  
         <paramRef ref="participantParams.participants_nf" />  
         <column name="ontology_term_name"/>
         <column name="internal"/>
         <column name="number_value"/>
         <column name="date_value"/>
         <column name="string_value"/>
         <sql>
           <![CDATA[
 select distinct pan_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from ApidbTuning.$$tbl_prefix$$MetaData 
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'Visit'
 union
 select io.input_pan_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m, ApidbTuning.$$tbl_prefix$$PANIO io
where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
and m.category = 'Specimen type' 
and m.term = 'Specimen type'
and io.output_pan_id = m.pan_id
          ]]>
    </sql>
    </sqlQuery>

       <sqlQuery name="ClinicalVisitAgeOntologyNf">
         <column name="ontology_term_name"/>
         <column name="parent_ontology_term_name"/>
         <column name="display_name"/>
         <column name="description"/>
         <column name="type"/>
         <column name="units"/>
         <column name="precision"/>
         <column name="is_range"/>
         <sql>
           <![CDATA[
                       select o.ontology_term_name, 'dummy' as parent_ontology_term_name, o.display_name, o.description, o.units,o.type,o.is_range,o.precision
from ApidbTuning.$$tbl_prefix$$Ontology o
where ontology_term_name = 'Age at time of visit'
union
                 select 'dummy' as ontology_term_name, null as parent_ontology_term_name, 'Household' as display_name, null as description, null as units, 'string' as type, 0 as is_range,
                 null as precision from dual
    ]]>   
        </sql>
      </sqlQuery>
          
   <sqlQuery name="ClinicalVisitAgeMetaDataNf" isCacheable="true">
      <paramRef ref="participantParams.geographic_region" /> 
      <paramRef ref="clinicalVisitParams.visit_date" /> 
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct pa.output_pan_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, ApidbTuning.$$tbl_prefix$$Observations cva,
 (select distinct io.input_pan_id, io.output_pan_id
  from ApidbTuning.$$tbl_prefix$$PANIO io
  where io.input_pan_id in ($$geographic_region$$)
  ) pa
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'Visit'
 and m.property_source_id = 'EUPATH_0000113'
 and pa.output_pan_id = m.pan_id
 and pa.output_pan_id = cva.pan_id
 and cva.EUPATH_0000091 >= $$visit_date.min$$
 and cva.EUPATH_0000091 <= $$visit_date.max$$
         ]]>   
      </sql>
   </sqlQuery>

      <sqlQuery name="ClinicalVisitAgeMetaDataBkgdNf" >
      <paramRef ref="participantParams.geographic_region" /> 
      <paramRef ref="clinicalVisitParams.visit_date" /> 
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct pan_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from ApidbTuning.$$tbl_prefix$$MetaData
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'Visit'
 and source_id = 'EUPATH_0000113'
          ]]>   
      </sql>
   </sqlQuery>

   <sqlQuery name="RegionOntology">
     <column name="ontology_term_name"/>
     <column name="parent_ontology_term_name"/>
     <column name="display_name"/>
     <column name="description"/>
     <column name="type"/>
     <column name="units"/>
     <column name="precision"/>
     <column name="is_range"/>
    <sql>
         <![CDATA[
                  select o.ontology_term_name, 'dummy' as parent_ontology_term_name, o.display_name, o.description, o.units,o.type,o.is_range,o.precision
                  from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct source_id
                  from ApidbTuning.$$tbl_prefix$$MetaData
                  where source_id in ('EUPATH_0000054','OBI_0001627','EUPATH_0000452')) ds
                  where ds.source_id = o.ontology_term_source_id
                  union
                  select 'dummy' as ontology_term_name, null as parent_ontology_term_name, 'Household' as display_name, null as description, null as units, 'string' as type, 0 as is_range,
                  null as precision from dual
         ]]>
    </sql>
   </sqlQuery>

    <sqlQuery name="RegionMetaData" >
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
 select pa.pan_id as internal, mt.property as ontology_term_name, da.EUPATH_0000054 as string_value, cast(null as number) as number_value, cast(null as date) as date_value
 from ApidbTuning.$$tbl_prefix$$Participants pa, ApidbTuning.$$tbl_prefix$$Households da, apidbtuning.PropertyTypes mt
 where pa.EUPATH_0000094 = da.name
 and mt.property_source_id = 'EUPATH_0000054'
        ]]>
      </sql>
    </sqlQuery>

       <sqlQuery name="HouseholdOntology">
        <column name="ontology_term_name"/>
        <column name="parent_ontology_term_name"/>
        <column name="display_name"/>
        <column name="description"/>
        <column name="type"/>
        <column name="units"/>
        <column name="precision"/>
        <column name="is_range"/>
    <sql>
   with leaf as (
 select o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from ApidbTuning.$$tbl_prefix$$Ontology o, 
(select distinct term
 from ApidbTuning.$$tbl_prefix$$MetaData
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and category = 'Household type'
 and source_id != 'EUPATH_0000094') md
 where o.ontology_term_name = md.term),
first as (
 select o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from leaf where parent_ontology_term_name is not null) par
 where o.ontology_term_name = par.parent_ontology_term_name),
 second as (
 select o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from first where parent_ontology_term_name is not null) gpar
 where o.ontology_term_name = gpar.parent_ontology_term_name)
 select * from leaf
 union
 select * from first
 union
 select * from second
 union
 select o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from second where parent_ontology_term_name is not null) ggpar
 where o.ontology_term_name = ggpar.parent_ontology_term_name
 union
 select 'average anopheles' as ontology_term_name, null as parent_ontology_term_name, 'Average Anopheles Collected' as display_name, 'Average number of Anopheles collected in monthly CDC light traps during the dates of this search' as description, null as units, 'number' as type, 1 as is_range,
 null as precision from dual
    </sql>
    </sqlQuery>

    <sqlQuery name="HouseholdMetaData" isCacheable="true">
      <paramRef ref="participantParams.visits_visitage_metadata_nf" />
      <paramRef ref="clinicalVisitParams.visit_date" /> 
      <paramRef ref="participantParams.duration_observation" />  
      <paramRef ref="participantParams.geographic_region" />  
      <paramRef ref="participantParams.participants_nf" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
with part as ( select distinct io.input_pan_id as household_id, io.output_pan_id as part_id
  from ApidbTuning.$$tbl_prefix$$Participants pa, ApidbTuning.$$tbl_prefix$$PANIO io
   where pa.pan_id in ($$participants_nf$$)
       and pa.pan_id = io.output_pan_id)
 select distinct Part.household_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, part
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'Household type'
 and part.household_id = m.pan_id
 union
 select part.household_id as internal, 'average anopheles' as ontology_term_name, null as string_value, nvl(mos.avg_anoph,0) as number_value, null as date_value
 from (select da.pan_id, round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as avg_anoph
  from ApidbTuning.$$tbl_prefix$$Households da, ApidbTuning.$$tbl_prefix$$PANIO io, ApidbTuning.$$tbl_prefix$$LightTraps la
  where da.pan_id = io.input_pan_id
  and la.pan_id = io.output_pan_id
  and la.OBI_0001619 >= $$visit_date.min$$ 
  and la.OBI_0001619 <= $$visit_date.max$$ 
  group by da.pan_id) mos, part
  where part.household_id = mos.pan_id(+)
          ]]>
    </sql>    

    </sqlQuery>

    <sqlQuery name="HouseholdMetaDataBkgd">
      <paramRef ref="participantParams.visits_visitage_metadata_nf" />
      <paramRef ref="clinicalVisitParams.visit_date" /> 
      <paramRef ref="participantParams.duration_observation" />  
      <paramRef ref="participantParams.geographic_region" />  
      <paramRef ref="participantParams.participants_nf" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
with part as ( select distinct io.input_pan_id as household_id, io.output_pan_id as part_id
  from ApidbTuning.$$tbl_prefix$$Participants pa, ApidbTuning.$$tbl_prefix$$PANIO io
   where pa.pan_id = io.output_pan_id)
 select distinct Part.household_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, part
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC'
 and m.category = 'Household type'
 and part.household_id = m.pan_id
 union
 select part.household_id as internal, 'average anopheles' as ontology_term_name, null as string_value, nvl(mos.avg_anoph,0) as number_value, null as date_value
 from (select da.pan_id, round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as avg_anoph
  from ApidbTuning.$$tbl_prefix$$Households da, ApidbTuning.$$tbl_prefix$$PANIO io, ApidbTuning.$$tbl_prefix$$LightTraps la
  where da.pan_id = io.input_pan_id
  and la.pan_id = io.output_pan_id
  group by da.pan_id) mos, part
  where part.household_id = mos.pan_id(+)
          ]]>
    </sql>    

    </sqlQuery>

    <!--************************************************************-->
    <!--   MAL-ED section ... should be injected  -->
    <!--************************************************************-->

   <sqlQuery name="ParticipantOntology_maled">
     <column name="ontology_term_name"/>
     <column name="parent_ontology_term_name"/>
     <column name="display_name"/>
     <column name="description"/>
     <column name="type"/>
     <column name="units"/>
     <column name="precision"/>
     <column name="is_range"/>
    <sql>
         <![CDATA[
 select distinct o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from ApidbTuning.$$tbl_prefix$$Ontology o
     CONNECT BY o.ontology_term_source_id = PRIOR o.parent_ontology_term_source_id
     START WITH o.ontology_term_source_id IN 
(select distinct source_id
 from ApidbTuning.$$tbl_prefix$$MetaData
 where dataset_name = 'ISASimple_Gates_MAL-ED_stdm_tp_RSRC' --$$dataset$$ 
 and category = 'Participant'
 and source_id != 'EUPATH_0000032')
 order by display_name
         ]]>
    </sql>
   </sqlQuery>

   <sqlQuery name="ParticipantMetaData_maled" isCacheable="true">
     <paramRef ref="participantParams.tbl_prefix" />  
     <paramRef ref="participantParams.geographic_region_maled" />  
     <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.pan_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m
 where m.dataset_name = $$dataset$$
 and m.category = 'Participant'
 and m.pan_id in ($$geographic_region_maled$$)
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="ParticipantMetaDataBkgd_maled">
      <paramRef ref="participantParams.tbl_prefix" />  
         <paramRef ref="participantParams.geographic_region_maled" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.pan_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m
 where m.dataset_name = $$dataset$$
 and m.category = 'Participant'
          ]]>
    </sql>
    </sqlQuery>

    
    <sqlQuery name="VisitOntology_maled">
      <column name="ontology_term_name"/>
      <column name="parent_ontology_term_name"/>
      <column name="display_name"/>
      <column name="description"/>
      <column name="type"/>
      <column name="units"/>
      <column name="precision"/>
      <column name="is_range"/>
      <sql>
         <![CDATA[
 select distinct o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from ApidbTuning.$$tbl_prefix$$Ontology o
     CONNECT BY o.ontology_term_source_id = PRIOR o.parent_ontology_term_source_id
     START WITH o.ontology_term_source_id IN 
(select distinct source_id
 from ApidbTuning.$$tbl_prefix$$MetaData
 where dataset_name = 'ISASimple_Gates_MAL-ED_stdm_tp_RSRC' --$$dataset$$ 
 and category = 'Event'
 and source_id != 'EUPATH_0000094')
 order by display_name
         ]]>
    </sql>
   </sqlQuery>

       <sqlQuery name="VisitMetaData_maled" isCacheable="true">
         <paramRef ref="participantParams.households_nf_maled" />  
         <paramRef ref="participantParams.tbl_prefix" />  
         <column name="ontology_term_name"/>
         <column name="internal"/>
         <column name="number_value"/>
         <column name="date_value"/>
         <column name="string_value"/>
         <sql>
           <![CDATA[
select distinct valid.visit_id as internal, source_id as ontology_term_name, string_value, number_value, date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, (
select distinct io.output_pan_id as visit_id, io.input_pan_id as part_id
from ApidbTuning.$$tbl_prefix$$PANIO io
where io.input_pan_id in ($$households_nf_maled$$)
and io.output_pan_type_source_id = 'EUPATH_0000738'
) valid
 where m.dataset_name = $$dataset$$
 and m.category = 'Event'
 and m.pan_id = valid.visit_id
          ]]>
    </sql>
    </sqlQuery>    

    <sqlQuery name="VisitMetaDataBkgd_maled">
      <paramRef ref="participantParams.households_nf_maled" />  
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
 select distinct pan_id as internal, source_id as ontology_term_name, string_value, number_value, date_value
 from ApidbTuning.$$tbl_prefix$$MetaData 
 where dataset_name = $$dataset$$
 and category = 'Event'
          ]]>
    </sql>
    </sqlQuery>

   <sqlQuery name="RegionOntology_maled">
     <paramRef ref="participantParams.tbl_prefix" />  
     <column name="ontology_term_name"/>
     <column name="parent_ontology_term_name"/>
     <column name="display_name"/>
     <column name="description"/>
     <column name="type"/>
     <column name="units"/>
     <column name="precision"/>
     <column name="is_range"/>
    <sql>
         <![CDATA[
select o.ontology_term_source_id as ontology_term_name, 'dummy' as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
                  from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct source_id
                  from ApidbTuning.$$tbl_prefix$$MetaData
                  where dataset_name = 'ISASimple_Gates_MAL-ED_stdm_tp_RSRC' --$$dataset$$ 
                  and source_id in ('EUPATH_0000054','OBI_0001627','EUPATH_0000452')
                  and category = 'Household') ds
                  where ds.source_id = o.ontology_term_source_id
                  union
                  select 'dummy' as ontology_term_name, null as parent_ontology_term_name, 'Household' as display_name, null as description, null as units, 'string' as type, 0 as is_range,
                  null as precision from dual
         ]]>
    </sql>
   </sqlQuery>

    <sqlQuery name="RegionMetaData_maled" >
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select io.output_pan_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, ApidbTuning.$$tbl_prefix$$PANIO io
 where m.dataset_name = $$dataset$$
 and m.category = 'Household'
 and m.property_source_id in ('EUPATH_0000054','OBI_0001627','EUPATH_0000452')
 and m.pan_id = io.input_pan_id
 and io.output_pan_type_source_id = 'EUPATH_0000096'
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="HouseholdOntology_maled">
      <column name="ontology_term_name"/>
      <column name="parent_ontology_term_name"/>
      <column name="display_name"/>
      <column name="description"/>
      <column name="type"/>
      <column name="units"/>
      <column name="precision"/>
      <column name="is_range"/>
      <sql>
 select distinct o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from ApidbTuning.$$tbl_prefix$$Ontology o
     CONNECT BY o.ontology_term_source_id = PRIOR o.parent_ontology_term_source_id
     START WITH o.ontology_term_source_id IN 
(select distinct source_id
 from ApidbTuning.$$tbl_prefix$$MetaData
 where dataset_name = 'ISASimple_Gates_MAL-ED_stdm_tp_RSRC' --$$dataset$$ 
 and category = 'Household'
 and source_id != 'EUPATH_0000094')
 order by display_name
    </sql>
    </sqlQuery>

    <sqlQuery name="HouseholdMetaData_maled" isCacheable="true">
      <paramRef ref="participantParams.participants_nf_maled" />  
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
with part as ( select distinct io.input_pan_id as household_id, io.output_pan_id as part_id
  from ApidbTuning.$$tbl_prefix$$Participants pa, ApidbTuning.$$tbl_prefix$$PANIO io
   where pa.pan_id in ($$participants_nf_maled$$)
       and pa.pan_id = io.output_pan_id)
 select distinct Part.household_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, part
 where m.dataset_name = $$dataset$$
 and m.category = 'Household'
 and part.household_id = m.pan_id
          ]]>
    </sql>    

    </sqlQuery>

    <sqlQuery name="HouseholdMetaDataBkgd_maled">
      <paramRef ref="participantParams.participants_nf_maled" />  
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
with part as ( select distinct io.input_pan_id as household_id, io.output_pan_id as part_id
  from ApidbTuning.$$tbl_prefix$$Participants pa, ApidbTuning.$$tbl_prefix$$PANIO io
   where pa.pan_id = io.output_pan_id)
 select distinct Part.household_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, part
 where m.dataset_name = $$dataset$$
 and m.category = 'Household'
 and part.household_id = m.pan_id
          ]]>
    </sql>    

    </sqlQuery>

    
    <!--************************************************************-->
    <!--   GEMS section ... -->
    <!--************************************************************-->

    <sqlQuery name="GeographicRegionOntology_gems">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="parent_ontology_term_name"/>
      <column name="display_name"/>
      <column name="description"/>
      <column name="type"/>
      <column name="units"/>
      <column name="precision"/>
      <column name="is_range"/>
      <sql>
         <![CDATA[
select distinct o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.$$tbl_prefix$$Ontology o
     CONNECT BY o.parent_ontology_term_source_id = PRIOR o.ontology_term_source_id
     START WITH o.ontology_term_source_id in ('OBI_0001627')
     UNION
      select distinct o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.$$tbl_prefix$$Ontology o
     CONNECT BY o.ontology_term_source_id = PRIOR o.parent_ontology_term_source_id
     START WITH o.ontology_term_source_id in ('OBI_0001627')
          ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="GeographicRegionMetaData_gems" isCacheable="false">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select m.pan_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m
where m.category = 'Child'
and m.property_source_id = 'OBI_0001627'
          ]]>
    </sql>    
    </sqlQuery>
    
    <sqlQuery name="GeographicRegionOntologyValues_gems" isCacheable="true">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m, apidbtuning.$$tbl_prefix$$Ontology o
where o.type is not null
and o.is_range = 0
and m.property_source_id = o.ontology_term_source_id
and m.category = 'Child'
and m.property_source_id = 'OBI_0001627'
          ]]>
      </sql>    
    </sqlQuery>
        
    <sqlQuery name="AllParticipantNoDependencies_gems" isCacheable="false">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
 select m.pan_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m 
where category = 'Child'
          ]]>
    </sql>    
    </sqlQuery>

    <sqlQuery name="AllParticipantNoDependenciesOntologyValues_gems" isCacheable="true">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m, ApidbTuning.$$tbl_prefix$$Ontology o
where o.type is not null
and o.is_range = 0
and m.property_source_id = o.ontology_term_source_id
and m.category = 'Child'
          ]]>
      </sql>    
    </sqlQuery>   
    
    <sqlQuery name="ParticipantDwellingOntology_gems">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="parent_ontology_term_name"/>
      <column name="display_name"/>
      <column name="description"/>
      <column name="type"/>
      <column name="units"/>
      <column name="precision"/>
      <column name="is_range"/>
      <sql>
select * from (
select distinct o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from ApidbTuning.$$tbl_prefix$$Ontology o
     CONNECT BY o.parent_ontology_term_source_id = PRIOR o.ontology_term_source_id
     START WITH o.ontology_term_source_id in ('EUPATH_0000096','PCO_0000024')
     and o.dataset_name = $$dataset$$ 
     order by display_name
) where ontology_term_name not in ('EUPATH_0000094','EUPATH_0010049','EUPATH_0010048','EUPATH_0010373','EUPATH_0000725','EUPATH_0010226')
      </sql>
    </sqlQuery>

    <sqlQuery name="ParticipantDwellingMetaData_gems" isCacheable="false">
      <paramRef ref="participantParams.geographic_region_gems" />  
      <paramRef ref="participantParams.tbl_prefix" />  
      <paramRef ref="participantParams.case_control" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
  select m.pan_id as internal, m.property_source_id as ontology_term_name,
                  m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m 
 where m.pan_id in ($$geographic_region_gems$$)
   and m.pan_id
       in (select pan_id
       from ApidbTuning.$$tbl_prefix$$Participants
       where EUPATH_0010375 in ($$case_control$$)
           )
         ]]>
    </sql>    
    </sqlQuery>

    <sqlQuery name="AllDataOntology_gems">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="parent_ontology_term_name"/>
      <column name="display_name"/>
      <column name="description"/>
      <column name="type"/>
      <column name="units"/>
      <column name="precision"/>
      <column name="is_range"/>
      <sql>
select * from (
select distinct o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from ApidbTuning.$$tbl_prefix$$Ontology o
where o.dataset_name = $$dataset$$ 
order by display_name
) where ontology_term_name not in ('EUPATH_0000094','EUPATH_0010049','EUPATH_0010048','EUPATH_0010373','EUPATH_0000725','EUPATH_0010226')
      </sql>
    </sqlQuery>

    <sqlQuery name="AllDataMetaData_gems" isCacheable="false">
      <paramRef ref="participantParams.tbl_prefix" />  
      <paramRef ref="participantParams.case_control" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
 select m.pan_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m 
 where m.pan_id
       in (select pan_id
       from ApidbTuning.$$tbl_prefix$$Participants
       where EUPATH_0010375 in ($$case_control$$)
           )
          ]]>
    </sql>    
    </sqlQuery>

    <sqlQuery name="EventOntology_gems">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="parent_ontology_term_name"/>
      <column name="display_name"/>
      <column name="description"/>
      <column name="type"/>
      <column name="units"/>
      <column name="precision"/>
      <column name="is_range"/>
      <sql>
select * from (
select distinct o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from ApidbTuning.$$tbl_prefix$$Ontology o
     CONNECT BY o.parent_ontology_term_source_id = PRIOR o.ontology_term_source_id
     START WITH o.ontology_term_source_id = 'EUPATH_0000738'
     and o.dataset_name = $$dataset$$ 
order by display_name
) where ontology_term_name not in ('EUPATH_0000094','EUPATH_0010049','EUPATH_0010048','EUPATH_0010373','EUPATH_0000725','EUPATH_0010226')
      </sql>
    </sqlQuery>

    <sqlQuery name="EventMetaData_gems" isCacheable="false">
      <paramRef ref="participantParams.participant_dwelling_gems" />  
<!--      <paramRef ref="participantParams.enrollment_followup" />  -->
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
 select m.pan_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m 
 where m.pan_id in ($$participant_dwelling_gems$$)
          ]]>
    </sql>    
    </sqlQuery>

    <sqlQuery name="EventOntologyValues_gems" isCacheable="true">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
 select distinct m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, (select ontology_term_source_id from (
select distinct o.ontology_term_source_id, o.type, o.is_range
from ApidbTuning.$$tbl_prefix$$Ontology o
     CONNECT BY o.parent_ontology_term_source_id = PRIOR o.ontology_term_source_id
     START WITH o.ontology_term_source_id = 'EUPATH_0000738'
     and o.dataset_name = $$dataset$$ 
) where type is not null
  and is_range = 0
  and ontology_term_source_id not in ('EUPATH_0000094','EUPATH_0010049','EUPATH_0010048','EUPATH_0010373','EUPATH_0000725','EUPATH_0010226')) ont
where m.property_source_id = ont.ontology_term_source_id
and m.category = 'Child'
          ]]>
      </sql>    
    </sqlQuery>

     <sqlQuery name="KeepRemove">
          <paramRef ref="participantParams.use_rel_case_control" />  
          <column name="display" />
          <column name="internal" />
          <column name="term" />
          <sql>
            <![CDATA[
                     SELECT * from (
                     SELECT 'Remove' as display, 'remove' as term, 'MINUS' as internal from dual
                     UNION
                     SELECT 'Keep' as display, 'keep' as term, 'INTERSECT' as internal from dual
                     where $$use_rel_case_control$$ = 1  )
                     ORDER by term desc
            ]]>
            </sql>
        </sqlQuery>

    <sqlQuery name="RelativeEventMetaData_gems" isCacheable="false">
      <paramRef ref="participantParams.tbl_prefix" />  
      <paramRef ref="participantParams.case_control" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
 select m.pan_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m 
 where m.pan_id
       in (select pan_id
       from ApidbTuning.$$tbl_prefix$$Participants
       where EUPATH_0010375 not in ($$case_control$$)
           )
          ]]>
    </sql>    
    </sqlQuery>

  </querySet>    

      <groupSet name="metaDataGroups">
        
        <group name="daterange" displayName="Time period / age at visit" displayType="ShowHide">
            <description>
                <![CDATA[
Filter participants based on the date range they were observed, the number of days they were observed in that period, and their age at each observation (ie clinical visit). Study data is available from 05-AUG-2011 to 30-JUN-2016.
                ]]>
            </description>
        </group>
        <group name="household_daterange" displayName="Time period" displayType="ShowHide">
            <description>
                <![CDATA[
Filter households based on the date range they were in the study.  Note that the Average Anopheles is computed from monthly CDC light trap collections within this time frame.  
                ]]>
            </description>
        </group>
        <group name="age_at_visit" displayName="Age" displayType="ShowHide">
            <description>
                <![CDATA[
    Filter participants based on their age at visits. Participants are removed if they have any visits within the previously selected Time Period where they were not within this Age range.  (The study included participants from age 0.5 to 11 years, and from 18 to 75 years of age.)
                ]]>
            </description>
        </group>
        <group name="lighttrap_characteristics" displayName="Light Trap Collections" displayType="ShowHide">
            <description>
                <![CDATA[
		       Filter light trap collections based on their characteristics.
                ]]>
            </description>
        </group>
        <group name="part_characteristics" displayName="Personal characteristics" displayType="ShowHide">
            <description>
                <![CDATA[
		       Filter participants based on their characteristics that do not change over time.
                ]]>
            </description>
        </group>
        <group name="visit_part_characteristics" displayName="Personal characteristics" displayType="ShowHide">
            <description>
                <![CDATA[
You can restrict visits returned based on participants by selecting characteristics about where they live including their household type and their own characteristics such as genotype information.
                ]]>
            </description>
        </group>
        <group name="part_household_characteristics" displayName="Households" displayType="ShowHide">
            <description></description> <!-- no need for a descrip.  too obvious -->
        </group>
        <group name="geographic_loc" displayName="Geographic Region" displayType="ShowHide">
            <description></description> <!-- no need for a descrip.  too obvious -->
        </group>
        <group name="visit_visit_characteristics" displayName="Visits" displayType="ShowHide">
            <description>
                <![CDATA[
You can restrict the observations returned in your search by selecting characteristics such as the type of observation, diagnosis, observation type, etc.
                ]]>
            </description>
        </group>
        <group name="visit_characteristics" displayName="Visits" displayType="ShowHide">
            <description>
                <![CDATA[
    Filter observations based on observations at visits.  Visits shown are from the period when the selected participants meet the age range specified in the Age filter    
             ]]>
            </description>
        </group>
        <group name="event_characteristics" displayName="Observations" displayType="ShowHide">
            <description>
                <![CDATA[
    Filter observations based on information gained at those observations. 
             ]]>
            </description>
        </group>
       <group name="part_visit_characteristics" displayName="Visits" displayType="ShowHide">
            <description>
                <![CDATA[
    Filter participants based on observations at visits.  Visits shown are for the selected set of participants when they were within the age range specified in the Age filter.    
                ]]>
            </description>
        </group>
       <group name="part_event_characteristics" displayName="Observations" displayType="ShowHide">
            <description>
                <![CDATA[
    Filter participants based on information gained at observations.     
                ]]>
            </description>
        </group>
        <group name="summary_params" displayName="Visit aggregates" displayType="ShowHide">
            <description>
                <![CDATA[
You can further restrict the participants returned in your search by setting summary values such as the average parasitemia or the number of visits / year of the visits matching the previous step characteristics.
                ]]>
            </description>
        </group>
        <group name="event_summary_params" displayName="# Observations selected" displayType="ShowHide">
            <description>
                <![CDATA[
You can further restrict the participants returned in your search by setting a range of the number of observations per participant that meet your search criteria. 
                ]]>
            </description>
        </group>
        <group name="relative_visits" displayName="Relative visits" displayType="ShowHide">
            <description>
                <![CDATA[
                         You can further restrict the visits you have selected above by removing (or keeping) those visits based on a relative visit you define below.  For example, you may want to only keep visits with a diagnosis of asymptomatic parasitemia from above if they are not followed within 14 days by a visit where the participant was diagnosed with malaria.  In this instance, set the number of days to 14, direction after and remove visits where diagnosis of malaria = yes.
                ]]>
            </description>
        </group>

        <group name="relative_events" displayName="Related observations" displayType="ShowHide">
            <description>
                <![CDATA[
                         You can restrict the observations you have previously selected by removing (or keeping) those observations based on related observations you define below. For example, you may want to only keep diarrheal observations if they are followed between 0 - 5 days by an observation where a laboratory test was positive for shigella.
                ]]>
            </description>
        </group>

        <group name="relative_case_control" displayName="Related Case/Control" displayType="ShowHide">
            <description>
                <![CDATA[
                         You can restrict the participants you have previously selected by removing (or keeping) participants based on differences or similarities between matched cases and controls. 
                ]]>
            </description>
        </group>

        <group name="results_options" displayName="Results Options" displayType="ShowHide">
            <description>
                <![CDATA[
                         Choose whether to return just the participants selected in this search, include the matching cases (or controls) for the participants selected or only the matching cases (or controls) for the selected participants.
                ]]>
            </description>
        </group>
        
        <group name="choose_case_control" displayName="Choose Case/Control" displayType="ShowHide">
            <description>
                <![CDATA[
                         Choose whether to query just cases, just controls or both. 
                ]]>
            </description>
        </group>

    </groupSet>

</wdkModel>
