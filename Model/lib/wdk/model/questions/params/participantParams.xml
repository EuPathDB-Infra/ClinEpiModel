<wdkModel>

  <paramSet name="participantParams">
    
    <enumParam name="type"
               prompt="type"
               multiPick="false"
               quote="true"
               visible="false">
      <help>this is internal</help>
      <enumList>
        <enumValue default="true">
          <term>person</term>
          <internal>person</internal>
        </enumValue>
        <enumValue>
          <term>household</term>
          <internal>household</internal>
        </enumValue>  
      </enumList>
    </enumParam>

       <filterParamNew name="geographic_region" 
                       metadataQueryRef="ParticipantVQ.RegionMetaData"
                       ontologyQueryRef="DwellingVQ.RegionOntology"
                       prompt="Participants"
                       trimMetadataTerms="false">
         <help>
           Select participants based on their geographic region. 
         </help>
    </filterParamNew>

       <filterParamNew name="dwellings_nf" 
                      metadataQueryRef="ParticipantVQ.DwellingMetaData"
                      summaryMetadataQueryRef="ParticipantVQ.DwellingMetaDataSummary"
                      ontologyQueryRef="ParticipantVQ.DwellingOntology"
                      backgroundQueryRef="ParticipantVQ.DwellingMetaDataBkgd"
                      useSummaryMetadataQueryForInternalValue="true"
                      prompt="Households"
                      dependedParamRef="participantParams.visits_visitage_metadata_nf,clinicalVisitParams.visit_date,participantParams.duration_observation,participantParams.geographic_region,participantParams.participants_nf"
                      trimMetadataTerms="false">
         <help>
              Select participants based on the characteristics of the household where they live. 
         </help>
       </filterParamNew>

       <filterParamNew name="participants_nf" 
                      metadataQueryRef="ParticipantVQ.ParticipantMetaData"
                      ontologyQueryRef="ParticipantVQ.ParticipantOntology"
                      backgroundQueryRef="ParticipantVQ.ParticipantMetaDataBkgd"
                      prompt="Participants"
                      trimMetadataTerms="false"
                      dependedParamRef="participantParams.visits_visitage_metadata_nf,clinicalVisitParams.visit_date,participantParams.duration_observation,participantParams.geographic_region">
         <help>
              Select participants based on their characteristics. 
         </help>
       </filterParamNew>

       <filterParamNew name="visits_nf" 
                    metadataQueryRef="ParticipantVQ.VisitMetaData"
                    summaryMetadataQueryRef="ParticipantVQ.VisitSummaryMetaData"
                    ontologyQueryRef="ParticipantVQ.VisitOntology"
                    backgroundQueryRef="ParticipantVQ.VisitMetaDataBkgd"
                    prompt="Clincial Observations"
                    trimMetadataTerms="false"
                    dependedParamRef="participantParams.visits_visitage_metadata_nf,clinicalVisitParams.visit_date,participantParams.duration_observation,participantParams.dwellings_nf,participantParams.geographic_region,participantParams.participants_nf">
      <help>
        Select participants based on their observation characteristics. 
      </help>
    </filterParamNew>

    <filterParamNew name="visits_visitage_metadata_nf" 
                      metadataQueryRef="ParticipantVQ.ClinicalVisitAgeMetaDataNf"
                      summaryMetadataQueryRef="ParticipantVQ.SummaryClinicalVisitAgeMetaDataNf"
                      ontologyQueryRef="ParticipantVQ.ClinicalVisitAgeOntologyNf"
                      backgroundQueryRef="ParticipantVQ.ClinicalVisitAgeMetaDataBkgdNf"
                      prompt="Participants"
                      dependedParamRef="participantParams.geographic_region,clinicalVisitParams.visit_date"
                      trimMetadataTerms="false">
         <help>
              Select reference samples. 
         </help>
       </filterParamNew>

    <datasetParam name="participantsBySourceID" 
		  recordClassRef="ParticipantRecordClasses.ParticipantRecordClass"
		  prompt="Source ID input set">
      <help><![CDATA[Input a set of source IDs, or upload a file<br><br>

             It can be delimited by a comma, semi colon or any white space.<br><br>
             Its possible that not all the IDs in the list will be found in the database
             due to anumber of reasons such as unavailable ID mapping. It is currenly not
             possible to inform which IDs did not match anything in the database]]> </help>
     <suggest includeProjects="INIT" default="FILL" />
     <suggest default="3001" />
      
    </datasetParam>

    <stringParam name="duration_observation"
		 prompt="Days of observation &gt;= "
		 number="true">
      <help>Specify the minimum number of days from the date range that the participant was observed (ie, in the study).</help>
      <suggest default="1"/>
      <regex>\d\d*</regex>
    </stringParam>

   <stringParam name="max_visits"
		 prompt="Number of observations / year &lt;= "
		 number="true">
      <help>Specify the maximum number of observations per participant per year that match your observation criteria.</help>
      <suggest default="365"/>
      <regex>\d\d*\.*\d*</regex>
    </stringParam>

   <stringParam name="min_visits"
		 prompt="Number of observations / year &gt;= "
		 number="true">
      <help>Specify the minimum number of observations per participant per year that match your observation criteria.</help>
      <suggest default="0.1"/>
      <regex>\d\d*\.*\d*</regex>
    </stringParam>

    <numberRangeParam name="visits_per_year"
                      prompt="Observations per year:"
                      integer="false"
                      min="0"
                      max="365"
                      step="0.1">
      <help>Set the range of number of observations that match your search criteria.</help>
      <!--         <suggest default="{'min': '1', 'max': '10'}" />  -->
      
    </numberRangeParam>
           
   <stringParam name="max_para_density"
		 prompt="Geometric mean parasite density &lt;= "
		 number="true">
      <help>Specify the maximum average parasite density across the observations that match your observation criteria.</help>
      <suggest default="1000000"/>
      <regex>\d\d*</regex>
    </stringParam>

   <stringParam name="min_para_density"
		 prompt="Geometric mean parasite density &gt;= "
		 number="true">
      <help>Specify the minimum average parasite density across the observations that match your observation criteria.</help>
      <suggest default="0"/>
      <regex>\d\d*</regex>
    </stringParam>

        <numberRangeParam name="parasite_density"
                       prompt="Parasite Density (geometric mean):"
                       integer="true"
                       min="0"
                       max="1000000">
         <help>Set the range of days between observations to compare to observations selected in the previous step</help>
<!--         <suggest default="{'min': '1', 'max': '10'}" />  -->

       </numberRangeParam> 

   <stringParam name="max_anoph"
		 prompt="Average number of anopheles &lt;= "
		 number="true">
      <help>Specify the maximum average number of anopheles mosquitos collected per dwelling over the date range specified that match your criteria.</help>
      <suggest default="1000"/>
      <regex>\d\d*</regex>
    </stringParam>

   <stringParam name="min_anoph"
		 prompt="Average number of anopheles &gt;= "
		 number="true">
      <help>Specify the minimum average number of anopheles mosquitos collected per dwelling over the date range specified that match your criteria.</help>
      <suggest default="0"/>
      <regex>\d\d*</regex>
    </stringParam>

   <stringParam name="end_date"
		 prompt="Latest date to include in this search: "
		 number="false">
      <help>Put in the latest date to include for identifying participant observations and computing anopheles counts.</help>
      <suggest default="30-JUN-2016"/>
      <regex>\d\d*-\w\w\w-\d\d\d\d</regex>
    </stringParam>

   <stringParam name="start_date"
		 prompt="Earliest date to include in this search: "
		 number="false">
      <!-- visibleHelp>Put in the earliest date to include for identifying participant observations and computing anopheles counts.</visibleHelp -->
      <help>Put in the earliest date to include for identifying participant observations and computing anopheles counts.</help>
      <suggest default="05-AUG-2011"/>
      <regex>\d\d*-\w\w\w-\d\d\d\d</regex>
    </stringParam>

    <answerParam name="participant_result"
                  prompt="Input Result Set"
                  readonly="true"
                  visible="false">
       <recordClass ref="ParticipantRecordClasses.ParticipantRecordClass" />
    </answerParam>

  </paramSet>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!--  Vocab queries-->  
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

 <querySet name="ParticipantVQ" queryType="vocab" isCacheable="true">

   <sqlQuery name="ParticipantOntology">
     <paramRef ref="participantParams.visits_visitage_metadata_nf" />
     <paramRef ref="clinicalVisitParams.visit_date" /> 
     <paramRef ref="participantParams.duration_observation" />  
     <paramRef ref="participantParams.geographic_region" />  
     <column name="ontology_term_name"/>
     <column name="parent_ontology_term_name"/>
     <column name="display_name"/>
     <column name="description"/>
     <column name="type"/>
     <column name="units"/>
     <column name="precision"/>
     <column name="is_range"/>
    <sql>
         <![CDATA[
with leaf as ( 
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.metadataontology o, 
(select distinct term
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
 and category = 'Participant'
 and source_id != 'EUPATH_0000032') md
 where o.ontology_term_name = md.term),
first as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from leaf where parent_ontology_term_name is not null) par
 where o.ontology_term_name = par.parent_ontology_term_name),
 second as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from first where parent_ontology_term_name is not null) gpar
 where o.ontology_term_name = gpar.parent_ontology_term_name)
 select * from leaf
 union
 select * from first
 union
 select * from second
 union
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from second where parent_ontology_term_name is not null) ggpar
 where o.ontology_term_name = ggpar.parent_ontology_term_name
         ]]>
    </sql>
   </sqlQuery>

       <sqlQuery name="ParticipantMetaData" isCacheable="true">
         <paramRef ref="participantParams.visits_visitage_metadata_nf" />
         <paramRef ref="clinicalVisitParams.visit_date" /> 
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.geographic_region" />  
     <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.protocol_app_node_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
  from (select min(EUPATH_0000113) as min_age, max(EUPATH_0000113) as max_age
   from apidbtuning.eventattributes 
   where protocol_app_node_id in ($$visits_visitage_metadata_nf$$)
   ) age,
   apidbtuning.participantattributes pa, apidbtuning.protocolappnodeio iov, apidbtuning.metadata m
   where pa.protocol_app_node_id in ($$geographic_region$$)
   AND least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EUPATH_0000032 + ( age.max_age * 365)) - 
       greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EUPATH_0000032 + ( age.min_age * 365)) + 1 >= $$duration_observation$$
       and pa.protocol_app_node_id = iov.input_node_id
       and iov.output_node_id in ($$visits_visitage_metadata_nf$$)
       and pa.protocol_app_node_id = m.protocol_app_node_id
       and m.dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
       and m.category = 'Participant'
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="ParticipantMetaDataBkgd">
         <paramRef ref="participantParams.visits_visitage_metadata_nf" />
         <paramRef ref="clinicalVisitParams.visit_date" /> 
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.geographic_region" />  
     <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.protocol_app_node_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
from apidbtuning.metadata m
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
 and m.category = 'Participant'
          ]]>
    </sql>
    </sqlQuery>

    
    <sqlQuery name="VisitOntology">
      <paramRef ref="participantParams.visits_visitage_metadata_nf" />
      <paramRef ref="clinicalVisitParams.visit_date" /> 
     <paramRef ref="participantParams.duration_observation" />  
     <paramRef ref="participantParams.dwellings_nf" />  
     <paramRef ref="participantParams.geographic_region" />  
     <paramRef ref="participantParams.participants_nf" />  
     <column name="ontology_term_name"/>
     <column name="parent_ontology_term_name"/>
     <column name="display_name"/>
     <column name="description"/>
     <column name="type"/>
     <column name="units"/>
     <column name="precision"/>
     <column name="is_range"/>
    <sql>
         <![CDATA[
with leaf as ( select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.metadataontology o, 
(select distinct term
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
 and category in ('Event','Specimen')
 and source_id != 'EUPATH_0000094') md
 where o.ontology_term_name = md.term),
first as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from leaf where parent_ontology_term_name is not null) par
 where o.ontology_term_name = par.parent_ontology_term_name),
 second as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from first where parent_ontology_term_name is not null) gpar
 where o.ontology_term_name = gpar.parent_ontology_term_name)
 select * from leaf
 union
 select * from first
 union
 select * from second
 union
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from second where parent_ontology_term_name is not null) ggpar
 where o.ontology_term_name = ggpar.parent_ontology_term_name
         ]]>
    </sql>
   </sqlQuery>

       <sqlQuery name="VisitMetaData" isCacheable="true">
         <paramRef ref="participantParams.visits_visitage_metadata_nf" />
         <paramRef ref="clinicalVisitParams.visit_date" /> 
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.dwellings_nf" />  
         <paramRef ref="participantParams.geographic_region" />  
         <paramRef ref="participantParams.participants_nf" />  
         <column name="ontology_term_name"/>
         <column name="internal"/>
         <column name="number_value"/>
         <column name="date_value"/>
         <column name="string_value"/>
         <sql>
           <![CDATA[
with valid as (
select distinct io.output_node_id as visit_id, io.input_node_id as part_id
from apidbtuning.protocolappnodeio io
where io.input_node_id in ($$dwellings_nf$$)
and io.output_node_id in ($$visits_visitage_metadata_nf$$)
)
select distinct valid.visit_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata m, valid
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
 and m.category = 'Event'
 and m.protocol_app_node_id = valid.visit_id
  union
 select valid.visit_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
from apidbtuning.metadata m, valid, apidbtuning.protocolappnodeio ios
where dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
and m.category = 'Specimen' 
and m.term = 'Specimen'
and ios.output_node_id = m.protocol_app_node_id
and ios.input_node_id = valid.visit_id
          ]]>
    </sql>
    </sqlQuery>    

    <sqlQuery name="VisitSummaryMetaData" isCacheable="true">
         <paramRef ref="participantParams.visits_visitage_metadata_nf" />
         <paramRef ref="clinicalVisitParams.visit_date" /> 
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.dwellings_nf" />  
         <paramRef ref="participantParams.geographic_region" />  
         <paramRef ref="participantParams.participants_nf" />  
         <column name="ontology_term_name"/>
         <column name="internal"/>
         <column name="number_value"/>
         <column name="date_value"/>
         <column name="string_value"/>
         <sql>
           <![CDATA[
select distinct io.input_node_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata m, apidbtuning.protocolappnodeio io, apidbtuning.eventattributes va
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
 and m.category = 'Event'
 and m.protocol_app_node_id = va.protocol_app_node_id
 and io.output_Node_Id = va.protocol_app_node_id
 and va.protocol_app_node_id in ($$visits_visitage_metadata_nf$$)
 and io.input_node_id in ($$dwellings_nf$$)
  union
 select iov.input_node_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
from apidbtuning.metadata m, apidbtuning.protocolappnodeio iov, apidbtuning.protocolappnodeio ios
where dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
and m.category = 'Specimen' 
and m.term = 'Specimen'
and ios.output_node_id = m.protocol_app_node_id
and ios.input_node_id in ($$visits_visitage_metadata_nf$$)
and iov.output_node_id = ios.input_node_id
and iov.input_node_id in ($$dwellings_nf$$)
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="VisitMetaDataBkgd">
         <paramRef ref="participantParams.visits_visitage_metadata_nf" />
         <paramRef ref="clinicalVisitParams.visit_date" /> 
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.dwellings_nf" />  
         <paramRef ref="participantParams.geographic_region" />  
         <paramRef ref="participantParams.participants_nf" />  
         <column name="ontology_term_name"/>
         <column name="internal"/>
         <column name="number_value"/>
         <column name="date_value"/>
         <column name="string_value"/>
         <sql>
           <![CDATA[
 select distinct protocol_app_node_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata 
 where dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
 and category = 'Event'
 union
 select io.input_node_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
from apidbtuning.metadata m, apidbtuning.protocolappnodeio io
where dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
and m.category = 'Specimen' 
and m.term = 'Specimen'
and io.output_node_id = m.protocol_app_node_id
          ]]>
    </sql>
    </sqlQuery>

       <sqlQuery name="ClinicalVisitAgeOntologyNf">
         <paramRef ref="participantParams.geographic_region" /> 
         <paramRef ref="clinicalVisitParams.visit_date" /> 
         <column name="ontology_term_name"/>
         <column name="parent_ontology_term_name"/>
         <column name="display_name"/>
         <column name="description"/>
         <column name="type"/>
         <column name="units"/>
         <column name="precision"/>
         <column name="is_range"/>
         <sql>
           <![CDATA[
                       select o.ontology_term_name, 'dummy' as parent_ontology_term_name, o.display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.metadataontology o
where ontology_term_source_id = 'EUPATH_0000113'
union
                 select 'dummy' as ontology_term_name, null as parent_ontology_term_name, 'Household' as display_name, null as description, null as units, 'string' as type, 0 as is_range,
                 null as precision from dual
    ]]>   
        </sql>
      </sqlQuery>
          
   <sqlQuery name="ClinicalVisitAgeMetaDataNf" isCacheable="true">
      <paramRef ref="participantParams.geographic_region" /> 
      <paramRef ref="clinicalVisitParams.visit_date" /> 
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct pa.output_Node_Id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
 from apidbtuning.metadata m, apidbtuning.eventattributes cva,
 (select distinct io.input_node_id, io.output_node_id
  from apidbtuning.protocolappnodeio io
  where io.input_node_id in ($$geographic_region$$)
  ) pa
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
 and m.category = 'Event'
 and m.source_id = 'EUPATH_0000113'
 and pa.output_node_id = m.protocol_app_node_id
 and pa.output_node_id = cva.protocol_app_node_id
 and cva.EUPATH_0000091 >= $$visit_date.min$$
 and cva.EUPATH_0000091 <= $$visit_date.max$$
         ]]>   
      </sql>
   </sqlQuery>

   <sqlQuery name="SummaryClinicalVisitAgeMetaDataNf" isCacheable="true">
      <paramRef ref="participantParams.geographic_region" /> 
      <paramRef ref="clinicalVisitParams.visit_date" /> 
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct pa.input_node_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
 from apidbtuning.metadata m, apidbtuning.eventattributes cva,
 (select distinct io.input_node_id, io.output_node_id
  from apidbtuning.protocolappnodeio io
  where io.input_node_id in ($$geographic_region$$)
  ) pa
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
 and m.category = 'Event'
 and m.source_id = 'EUPATH_0000113'
 and pa.output_node_id = m.protocol_app_node_id
 and pa.output_node_id = cva.protocol_app_node_id
 and cva.EUPATH_0000091 >= $$visit_date.min$$
 and cva.EUPATH_0000091 <= $$visit_date.max$$
         ]]>   
      </sql>
   </sqlQuery>

      <sqlQuery name="ClinicalVisitAgeMetaDataBkgdNf" >
      <paramRef ref="participantParams.geographic_region" /> 
      <paramRef ref="clinicalVisitParams.visit_date" /> 
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct protocol_app_node_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
 and category = 'Event'
 and source_id = 'EUPATH_0000113'
          ]]>   
      </sql>
   </sqlQuery>

    <sqlQuery name="RegionMetaData" >
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
 select pa.protocol_app_node_id as internal, mt.property as ontology_term_name, da.EUPATH_0000054 as string_value, cast(null as number) as number_value, cast(null as date) as date_value
 from apidbtuning.participantattributes pa, apidbtuning.householdattributes da, apidbtuning.metadatatype mt
 where pa.EUPATH_0000094 = da.name
 and mt.source_id = 'EUPATH_0000054'
        ]]>
      </sql>
    </sqlQuery>

       <sqlQuery name="DwellingOntology">
         <paramRef ref="participantParams.visits_visitage_metadata_nf" />
         <paramRef ref="clinicalVisitParams.visit_date" /> 
         <paramRef ref="participantParams.duration_observation" />  
         <paramRef ref="participantParams.geographic_region" />  
         <paramRef ref="participantParams.participants_nf" />  
        <column name="ontology_term_name"/>
        <column name="parent_ontology_term_name"/>
        <column name="display_name"/>
        <column name="description"/>
        <column name="type"/>
        <column name="units"/>
        <column name="precision"/>
        <column name="is_range"/>
    <sql>
   with leaf as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from apidbtuning.metadataontology o, 
(select distinct term
 from apidbtuning.metadata
 where dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
 and category = 'Household'
 and source_id != 'EUPATH_0000094') md
 where o.ontology_term_name = md.term),
first as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from leaf where parent_ontology_term_name is not null) par
 where o.ontology_term_name = par.parent_ontology_term_name),
 second as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from first where parent_ontology_term_name is not null) gpar
 where o.ontology_term_name = gpar.parent_ontology_term_name)
 select * from leaf
 union
 select * from first
 union
 select * from second
 union
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from apidbtuning.metadataontology o, (select distinct parent_ontology_term_name from second where parent_ontology_term_name is not null) ggpar
 where o.ontology_term_name = ggpar.parent_ontology_term_name
 union
 select 'average anopheles' as ontology_term_name, null as parent_ontology_term_name, 'Average Anopheles Collected' as display_name, 'Average number of Anopheles collected in monthly CDC light traps during the dates of this search' as description, null as units, 'number' as type, 1 as is_range,
 null as precision from dual
    </sql>
    </sqlQuery>

    <sqlQuery name="DwellingMetaDataSummary" isCacheable="true">
      <paramRef ref="participantParams.visits_visitage_metadata_nf" />
      <paramRef ref="clinicalVisitParams.visit_date" /> 
      <paramRef ref="participantParams.duration_observation" />  
      <paramRef ref="participantParams.geographic_region" />  
      <paramRef ref="participantParams.participants_nf" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
with part as ( select distinct io.input_node_id as dwelling_id, io.output_node_id as part_id
  from apidbtuning.participantattributes pa, apidbtuning.protocolappnodeio io
   where pa.protocol_app_node_id in ($$participants_nf$$)
       and pa.protocol_app_node_id = io.output_node_id)
 select distinct Part.part_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
 from apidbtuning.metadata m, part
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
 and m.category = 'Household'
 and part.dwelling_id = m.protocol_app_node_id
 union
 select part.part_id as internal, 'average anopheles' as ontology_term_name, null as string_value, nvl(mos.avg_anoph,0) as number_value, null as date_value
 from (select da.protocol_app_node_id, round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as avg_anoph
  from apidbtuning.householdattributes da, apidbtuning.protocolappnodeio io, apidbtuning.lighttrapattributes la
  where da.protocol_app_node_id = io.input_node_id
  and la.protocol_app_node_id = io.output_node_id
  and la.OBI_0001619 >= $$visit_date.min$$ 
  and la.OBI_0001619 <= $$visit_date.max$$ 
  group by da.protocol_app_node_id) mos, part
  where part.dwelling_id = mos.protocol_app_node_id(+)
          ]]>
    </sql>    

    </sqlQuery>

    <sqlQuery name="DwellingMetaData" isCacheable="true">
      <paramRef ref="participantParams.visits_visitage_metadata_nf" />
      <paramRef ref="clinicalVisitParams.visit_date" /> 
      <paramRef ref="participantParams.duration_observation" />  
      <paramRef ref="participantParams.geographic_region" />  
      <paramRef ref="participantParams.participants_nf" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
with part as ( select distinct io.input_node_id as dwelling_id, io.output_node_id as part_id
  from apidbtuning.participantattributes pa, apidbtuning.protocolappnodeio io
   where pa.protocol_app_node_id in ($$participants_nf$$)
       and pa.protocol_app_node_id = io.output_node_id)
 select distinct Part.dwelling_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
 from apidbtuning.metadata m, part
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
 and m.category = 'Household'
 and part.dwelling_id = m.protocol_app_node_id
 union
 select part.dwelling_id as internal, 'average anopheles' as ontology_term_name, null as string_value, nvl(mos.avg_anoph,0) as number_value, null as date_value
 from (select da.protocol_app_node_id, round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as avg_anoph
  from apidbtuning.householdattributes da, apidbtuning.protocolappnodeio io, apidbtuning.lighttrapattributes la
  where da.protocol_app_node_id = io.input_node_id
  and la.protocol_app_node_id = io.output_node_id
  and la.OBI_0001619 >= $$visit_date.min$$ 
  and la.OBI_0001619 <= $$visit_date.max$$ 
  group by da.protocol_app_node_id) mos, part
  where part.dwelling_id = mos.protocol_app_node_id(+)
          ]]>
    </sql>    

    </sqlQuery>

    <sqlQuery name="DwellingMetaDataBkgd">
      <paramRef ref="participantParams.visits_visitage_metadata_nf" />
      <paramRef ref="clinicalVisitParams.visit_date" /> 
      <paramRef ref="participantParams.duration_observation" />  
      <paramRef ref="participantParams.geographic_region" />  
      <paramRef ref="participantParams.participants_nf" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
with part as ( select distinct io.input_node_id as dwelling_id, io.output_node_id as part_id
  from apidbtuning.participantattributes pa, apidbtuning.protocolappnodeio io
   where pa.protocol_app_node_id = io.output_node_id)
 select distinct Part.dwelling_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
 from apidbtuning.metadata m, part
 where m.dataset_name = 'ISASimple_ICEMR_PRISM_cohort_RSRC'
 and m.category = 'Household'
 and part.dwelling_id = m.protocol_app_node_id
 union
 select part.dwelling_id as internal, 'average anopheles' as ontology_term_name, null as string_value, nvl(mos.avg_anoph,0) as number_value, null as date_value
 from (select da.protocol_app_node_id, round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as avg_anoph
  from apidbtuning.householdattributes da, apidbtuning.protocolappnodeio io, apidbtuning.lighttrapattributes la
  where da.protocol_app_node_id = io.input_node_id
  and la.protocol_app_node_id = io.output_node_id
  group by da.protocol_app_node_id) mos, part
  where part.dwelling_id = mos.protocol_app_node_id(+)
          ]]>
    </sql>    

    </sqlQuery>

  </querySet>    

      <groupSet name="metaDataGroups">
        
        <group name="daterange" displayName="Date / age at observation" displayType="ShowHide">
            <description>
                <![CDATA[
Filter participants based on the date range they were observed, the number of days they were observed in that period, and their age at each observation (ie observation). Study data is available from 05-AUG-2011 to 30-JUN-2016.
                ]]>
            </description>
        </group>
        <group name="household_daterange" displayName="Time period" displayType="ShowHide">
            <description>
                <![CDATA[
Filter households based on the date range they were in the study.  Note that the Average Anopheles is computed from monthly CDC light trap collections within this time frame.  
                ]]>
            </description>
        </group>
        <group name="age_at_visit" displayName="Age" displayType="ShowHide">
            <description>
                <![CDATA[
    Filter participants based on their age at observations. Participants are removed if they have any observations within the previously selected Time Period where they were not within this Age range.  (The study included participants from age 0.5 to 11 years, and from 18 to 75 years of age.)
                ]]>
            </description>
        </group>
        <group name="lighttrap_characteristics" displayName="Light Trap Collections" displayType="ShowHide">
            <description>
                <![CDATA[
		       Filter light trap collections based on their characteristics.
                ]]>
            </description>
        </group>
        <group name="part_characteristics" displayName="Personal characteristics" displayType="ShowHide">
            <description>
                <![CDATA[
		       Filter participants based on their characteristics that do not change over time.
                ]]>
            </description>
        </group>
        <group name="visit_part_characteristics" displayName="Personal characteristics" displayType="ShowHide">
            <description>
                <![CDATA[
You can restrict observations returned based on participants by selecting characteristics about where they live including their dwelling type and their own characteristics such as genotype information.
                ]]>
            </description>
        </group>
        <group name="part_dwelling_characteristics" displayName="Households" displayType="ShowHide">
            <description></description> <!-- no need for a descrip.  too obvious -->
        </group>
        <group name="geographic_loc" displayName="Geographic Region" displayType="ShowHide">
            <description></description> <!-- no need for a descrip.  too obvious -->
        </group>
        <group name="visit_visit_characteristics" displayName="Observation observations" displayType="ShowHide">
            <description>
                <![CDATA[
You can restrict the observations returned in your search by selecting characteristics such as the type of observation, diagnosis, observation tpye, etc.
                ]]>
            </description>
        </group>
        <group name="visit_characteristics" displayName="Observations" displayType="ShowHide">
            <description>
                <![CDATA[
    Filter participants based on observations at observations.  Observations shown are from the period when the selected participants meet the age range specified in the Age filter    
             ]]>
            </description>
        </group>
       <group name="part_visit_characteristics" displayName="Observations" displayType="ShowHide">
            <description>
                <![CDATA[
    Filter participants based on observations at observations.  Observations shown are for the selected set of participants when they were within the age range specified in the Age filter.    
                ]]>
            </description>
        </group>
        <group name="summary_params" displayName="Observation aggregates" displayType="ShowHide">
            <description>
                <![CDATA[
You can further restrict the participants returned in your search by setting summary values such as the average parasitemia or the number of observations / year of the observations matching the previous step characteristics.
                ]]>
            </description>
        </group>
        <group name="relative_visits" displayName="Related observations" displayType="ShowHide">
            <description>
                <![CDATA[
                         You can restrict the observations you have previously selected by removing (or keeping) those observations based on related observations you define below.  For example, you may want to only keep observations with a diagnosis of asymptomatic parasitemia from above if they are not followed within 14 days by a observation where the participant was diagnosed with malaria.  In this instance, set the number of days to 14, direction after and remove observations where diagnosis of malaria = yes.
                ]]>
            </description>
        </group>


    </groupSet>

</wdkModel>
