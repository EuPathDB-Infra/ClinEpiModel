<wdkModel>

  <constant name="clinicalVisitIdTransformSql1">
    <![CDATA[
      select distinct io.output_pan_id as internal
       from ApidbTuning.D0ad509829ePANIO io,
        (##FILTERED_IDS##) md
       where io.input_pan_id = md.internal
       and io.output_pan_type_source_id = 'EUPATH_0000738'
     ]]>   
   </constant>
   
   <constant name="clinicalVisitIdTransformSql2">
     <![CDATA[
       select internal from (##FILTERED_IDS##)
     ]]> 
   </constant>   

  <paramSet name="clinicalVisitParams">
    
    <enumParam name="type"
               prompt="type"
               multiPick="false"
               quote="true"
               visible="false">
      <help>this is internal</help>
      <enumList>
        <enumValue default="true">
          <term>clinicalVisit</term>
          <internal>clinicalVisit</internal>
        </enumValue>
      </enumList>
    </enumParam>


    <!-- TEMPLATE_ANCHOR observationSourceIdParam -->


    <filterParamNew name="visits_prism" 
                    ontologyQueryRef="ParticipantVQ.VisitOntology_prism"
                    metadataQueryRef="ClinicalVisitVQ.VisitMetaData_prism"
                    backgroundQueryRef="ParticipantVQ.VisitMetaDataBkgd_prism"
                    prompt="Observations"
                    countPredictsAnswerCount="false"
                    trimMetadataTerms="false"
                    dependedParamRef="participantParams.tbl_prefix,clinicalVisitParams.visits_visitage_metadata_prism,clinicalVisitParams.visit_date,participantParams.duration_observation,clinicalVisitParams.households_prism,clinicalVisitParams.geographic_region_prism,clinicalVisitParams.participants_prism">
      <help>
        Select observations based on their observation characteristics. 
      </help>
    </filterParamNew>


       <filterParamNew name="visits_visitage_metadata_prism" 
                       ontologyQueryRef="ParticipantVQ.VisitAgeOntology_prism"
                       metadataQueryRef="ClinicalVisitVQ.ClinicalVisitAgeMetaData_prism"
                       backgroundQueryRef="ParticipantVQ.VisitAgeMetaDataBkgd_prism"
                       filterDataTypeDisplayName="Participants"
                       prompt="Age at observation"
                       countPredictsAnswerCount="false"
                       dependedParamRef="participantParams.tbl_prefix,clinicalVisitParams.geographic_region_prism"
                       trimMetadataTerms="false">
         <help>
              Select the age of the participants at the time of their clinical observations.
         </help>
       </filterParamNew>

       <filterParamNew name="geographic_region_prism" 
                       ontologyQueryRef="ParticipantVQ.RegionOntology_prism"
                       metadataQueryRef="ParticipantVQ.RegionMetaData_prism"
                       useIdTransformSqlForInternalValue="false"
                       filterDataTypeDisplayName="Participants"
                       prompt="Geographic Region"
                       dependedParamRef="participantParams.tbl_prefix"
                       countPredictsAnswerCount="true"
                       trimMetadataTerms="false">
         <idTransformSql>%%clinicalVisitIdTransformSql1%%</idTransformSql>              
         <help>
           Select observations based on the subcounty where the participant lives. 
         </help>
    </filterParamNew>

       <filterParamNew name="households_prism" 
                       ontologyQueryRef="ParticipantVQ.HouseholdOntology_prism"
                       metadataQueryRef="ClinicalVisitVQ.HouseholdMetaData_prism"
                       backgroundQueryRef="ParticipantVQ.HouseholdMetaDataBkgd_prism"
                       useIdTransformSqlForInternalValue="false"
                       filterDataTypeDisplayName="Participants"
                       prompt="Households"
                       countPredictsAnswerCount="false"
                       dependedParamRef="participantParams.tbl_prefix,clinicalVisitParams.visit_date,clinicalVisitParams.participants_prism"
                       trimMetadataTerms="false">
         <idTransformSql>%%clinicalVisitIdTransformSql1%%</idTransformSql>                
         <help>
              Select observations based on the household characteristics where the participant lives. 
         </help>
       </filterParamNew>

       <filterParamNew name="participants_prism" 
                       ontologyQueryRef="ParticipantVQ.ParticipantOntology_prism"
                       metadataQueryRef="ClinicalVisitVQ.ParticipantMetaData_prism"
                       backgroundQueryRef="ParticipantVQ.ParticipantMetaDataBkgd_prism"
                       useIdTransformSqlForInternalValue="false"
                       prompt="Participants"
                       countPredictsAnswerCount="false"
                       trimMetadataTerms="false"
                       dependedParamRef="participantParams.tbl_prefix,clinicalVisitParams.visits_visitage_metadata_prism,clinicalVisitParams.visit_date,participantParams.duration_observation">
         <idTransformSql>%%clinicalVisitIdTransformSql1%%</idTransformSql>   
         <help>
              Select participants based on their characteristics. 
         </help>
       </filterParamNew>

       <dateRangeParam name="visit_date"
                       prompt="Choose start and end dates "
                       minDate="2011-08-01"
                       maxDate="2016-06-30">
         <help>"select the earliest and latest dates to include for identifying observations and computing mosquito counts."</help>
<!--         <suggest default="{'min': '2011-08-05', 'max': '2016-06-30'}" />  -->

       </dateRangeParam>


    <numberRangeParam name="num_relative_events"
                       prompt="Number of matching related observations: "
                       integer="true"
                       min="1"
                       max="1000">
         <help>Set the range of the number of matching observations in order to keep or remove the observation from the previous step.</help>
         <suggest default="{'min': '1', 'max': '100'}" />  

       </numberRangeParam> 

    <numberRangeParam name="days_between"
                       prompt="Days between observations: "
                       integer="true"
                       min="0"
                       max="10000">
         <help>Set the range of days between observations to compare to observations selected in the previous step</help>
         <suggest default="{'min': '0', 'max': '10'}" />  

       </numberRangeParam> 

    <enumParam name="dateOperator"
               prompt="Keep or Remove observations "
               multiPick="false"
               quote="false"
               visible="true">
      <help>Choose how to compare these two observations.  Do you want to remove observations that have another observation within the specified time frame or keep them.</help>
      <enumList>
        <enumValue default="true">
          <term>remove</term>
          <internal>MINUS</internal>
        </enumValue>
        <enumValue>
          <term>keep</term>
          <internal>INTERSECT</internal>
        </enumValue>
      </enumList>
    </enumParam>

    <enumParam name="date_direction"
               prompt="Choose a direction "
               multiPick="false"
               quote="false"
               visible="true">
      <help>Choose a direction for the corresponding observation.  Will the matching observation be before or after relative to the first observation.</help>
      <enumList>
        <enumValue default="true">
          <term>after</term>
          <internal><![CDATA[>=]]></internal>
        </enumValue>
        <enumValue>
          <term>before</term>
          <internal><![CDATA[<=]]></internal>
        </enumValue>
      </enumList>
    </enumParam>

    <flatVocabParam name="use_relative_visits"
               prompt="Use related observations"
               multiPick="false"
               quote="false"
               visible="true"
               queryRef="ClinicalVisitVQ.useRelativeVisits">
      <help>You MUST change this parameter to Yes in order to use relative observations! If you decide to not use relative observations, set this parameter to No and make certain "Keep or remove observations" is set to remove.</help>
    </flatVocabParam>


    <flatVocabParam name="dateOperator_fv"
               prompt="Keep or Remove observations from previous step matching these criteria"
               multiPick="false"
               quote="false"
               visible="true"
               dependedParamRef="clinicalVisitParams.use_relative_visits"
               queryRef="ClinicalVisitVQ.dateOperator">
      <help>Choose how to compare these two observations.  Do you want to remove observations that have another observation within the specified time frame or keep them.</help>
    </flatVocabParam>

    <flatVocabParam name="date_direction_fv"
               prompt="Choose a direction "
               multiPick="false"
               quote="false"
               visible="true"
               queryRef="ClinicalVisitVQ.dateDirection">
      <help>Choose a direction for the corresponding observation.  Will the matching observation be before or after relative to the first observation.</help>
      <suggest default="after"/>
    </flatVocabParam>


    <!-- TEMPLATE_ANCHOR observationResultParam -->


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!--  MAL-ED specific .. should be injected -->  
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <filterParamNew name="visits_nf_maled" 
                    metadataQueryRef="ClinicalVisitVQ.VisitMetaData_maled"
                    ontologyQueryRef="ParticipantVQ.VisitOntology_maled"
                    backgroundQueryRef="ClinicalVisitVQ.VisitMetaDataBkgd_maled"
                    prompt="Observations"
                    trimMetadataTerms="false"
                    dependedParamRef="participantParams.tbl_prefix,clinicalVisitParams.households_nf_maled">
      <help>
        Select observations based on their observation characteristics. 
      </help>
    </filterParamNew>

       <filterParamNew name="geographic_region_maled" 
                       metadataQueryRef="ClinicalVisitVQ.RegionMetaData_maled"
                       ontologyQueryRef="ParticipantVQ.RegionOntology_maled"
                       prompt="Participant"
                       dependedParamRef="participantParams.tbl_prefix"
                       trimMetadataTerms="false">
         <idTransformSql>%%clinicalVisitIdTransformSql1%%</idTransformSql>  
         <help>
           Select observations based on the participants subcounty where they live. 
         </help>
    </filterParamNew>

       <filterParamNew name="households_nf_maled" 
                      metadataQueryRef="ClinicalVisitVQ.HouseholdMetaData_maled"
                      ontologyQueryRef="ParticipantVQ.HouseholdOntology_maled"
                      backgroundQueryRef="ClinicalVisitVQ.HouseholdMetaDataBkgd_maled"
                      useIdTransformSqlForInternalValue="true"
                      prompt="Households"
                      dependedParamRef="participantParams.tbl_prefix,clinicalVisitParams.participants_nf_maled"
                      trimMetadataTerms="false">
         <idTransformSql>%%clinicalVisitIdTransformSql1%%</idTransformSql>          
         <help>
              Select observations based on the household characteristics where the participants live. 
         </help>
       </filterParamNew>

       <filterParamNew name="participants_nf_maled" 
                      metadataQueryRef="ClinicalVisitVQ.ParticipantMetaData_maled"
                      ontologyQueryRef="ParticipantVQ.ParticipantOntology_maled"
                      backgroundQueryRef="ClinicalVisitVQ.ParticipantMetaDataBkgd_maled"
                      prompt="Participants"
                      trimMetadataTerms="false"
                      dependedParamRef="participantParams.tbl_prefix,clinicalVisitParams.geographic_region_maled">
         <idTransformSql>%%clinicalVisitIdTransformSql1%%</idTransformSql>               
         <help>
              Select participants based on their characteristics. 
         </help>
       </filterParamNew>

    <filterParamNew name="relative_visits_nf_maled" 
                    metadataQueryRef="ClinicalVisitVQ.RelVisitMetaData_maled"
                    ontologyQueryRef="ClinicalVisitVQ.RelVisitOntology_maled"
                    prompt="Related Observations"
                    trimMetadataTerms="false" >
      <help>
        Select related observations based on their characteristics. 
      </help>
    </filterParamNew>

  </paramSet>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!--  Vocab queries-->  
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

 <querySet name="ClinicalVisitVQ" queryType="vocab" isCacheable="true">

        <sqlQuery name="dateDirection">
            <column name="display" />
            <column name="internal" />
            <column name="term" />
            <!-- `display` is the opposite of `term` because it is arranged in a sentence where the operands are the opposite of the query -->
            <sql>
              <![CDATA[
                       SELECT 'before' as display, 'after' as term, '>=' as internal from dual
                       UNION
                       SELECT 'after' as display, 'before' as term, '<=' as internal from dual
              ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="dateOperator">
          <paramRef ref="clinicalVisitParams.use_relative_visits" />  
          <column name="display" />
          <column name="internal" />
          <column name="term" />
          <sql>
            <![CDATA[
                     SELECT * from (
                     SELECT 'Remove' as display, 'remove' as term, 'MINUS' as internal from dual
                     UNION
                     SELECT 'Keep' as display, 'keep' as term, 'INTERSECT' as internal from dual
                     where $$use_relative_visits$$ = 1  )
                     ORDER by term desc
            ]]>
            </sql>
        </sqlQuery>


        <sqlQuery name="useRelativeVisits">
            <column name="internal" />
            <column name="term" />
            <sql>
            <![CDATA[
                     SELECT 'No' as term, 0 as internal from dual
                     UNION
                     SELECT 'Yes' as term, 1 as internal from dual
            ]]>
            </sql>
        </sqlQuery>

<!--
                <sqlQuery name="minAgeAtVisit">
            <paramRef ref="clinicalVisitParams.visits_visitage_metadata_prism" />
            <paramRef ref="clinicalVisitParams.geographic_region_prism" />
            <column name="internal" />
            <column name="term" />
            <sql>
            <![CDATA[
select min(EUPATH_0000113) as term, min(EUPATH_0000113) as internal 
   from ApidbTuning.$$tbl_prefix$$Observations 
   where pan_id in ($$visits_visitage_metadata_prism$$)
            ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="maxAgeAtVisit">
            <paramRef ref="clinicalVisitParams.visits_visitage_metadata_prism" />
            <paramRef ref="clinicalVisitParams.geographic_region_prism" />
            <column name="internal" />
            <column name="term" />
            <sql>
            <![CDATA[
select max(EUPATH_0000113) as term, max(EUPATH_0000113) as internal 
   from ApidbTuning.$$tbl_prefix$$Observations 
   where pan_id in ($$visits_visitage_metadata_prism$$)
            ]]>
            </sql>
        </sqlQuery>
-->

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!--  PRISM specific .. should be injected -->  
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

   <sqlQuery name="ClinicalVisitAgeOntology_prism">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="parent_ontology_term_name"/>
      <column name="display_name"/>
      <column name="description"/>
      <column name="type"/>
      <column name="units"/>
      <column name="precision"/>
      <column name="is_range"/>
      <sql>
        <![CDATA[
                       select o.ontology_term_name, 'dummy' as parent_ontology_term_name, o.display_name, o.description, o.units,o.type,o.is_range,o.precision
from ApidbTuning.$$tbl_prefix$$Ontology o
where ontology_term_name = 'Age at time of visit'
union
                 select 'dummy' as ontology_term_name, null as parent_ontology_term_name, 'Household' as display_name, null as description, null as units, 'string' as type, 0 as is_range,
                 null as precision from dual
    ]]>   
        </sql>
      </sqlQuery>
          
   <sqlQuery name="ClinicalVisitAgeMetaData_prism">
      <paramRef ref="clinicalVisitParams.geographic_region_prism" /> 
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select m.pan_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from  ApidbTuning.$$tbl_prefix$$metadata m,
 (select distinct io.input_pan_id, io.output_pan_id
  from ApidbTuning.$$tbl_prefix$$PANIO io
  where io.input_pan_id in ($$geographic_region_prism$$)
  and output_pan_type_source_id = 'EUPATH_0000738'
  ) pa
  where pa.output_pan_id = m.pan_id
  and m.property_source_id = 'EUPATH_0000113'
         ]]>   
      </sql>
   </sqlQuery>

      <sqlQuery name="ClinicalVisitAgeMetaDataBkgd_prism" >
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct cva.pan_id as internal, m.property as ontology_term_name, '1' as string_value, cva.EUPATH_0000113 as number_value, cast(null as date) as date_value
 from ApidbTuning.$$tbl_prefix$$Participants pa, ApidbTuning.$$tbl_prefix$$PANIO io, ApidbTuning.$$tbl_prefix$$Observations cva, apidbtuning.PropertyTypes m
 where io.output_pan_id = cva.pan_id
 and pa.pan_id = io.input_pan_id
 and m.property_source_id = 'EUPATH_0000113'
          ]]>   
      </sql>
      </sqlQuery>

    <sqlQuery name="RegionMetaData_prism" >
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct ioa.output_pan_id as internal, mt.property as ontology_term_name, da.EUPATH_0000054 as string_value,
cast(null as number) as number_value, cast(null as date) as date_value
from ApidbTuning.$$tbl_prefix$$Households da,ApidbTuning.$$tbl_prefix$$PANIO ioa, ApidbTuning.$$tbl_prefix$$PANIO iob,
ApidbTuning.$$tbl_prefix$$Observations cva,apidbtuning.PropertyTypes mt
where da.pan_id = ioa.input_pan_id
and ioa.output_pan_id = iob.input_pan_id
and iob.output_pan_id = cva.pan_id
and mt.property_source_id = 'EUPATH_0000054'
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="HouseholdOntology_prism">
      <column name="ontology_term_name"/>
      <column name="parent_ontology_term_name"/>
      <column name="display_name"/>
      <column name="description"/>
      <column name="type"/>
      <column name="units"/>
      <column name="precision"/>
      <column name="is_range"/>
      <sql>
        <![CDATA[
   with leaf as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from ApidbTuning.$$tbl_prefix$$Ontology o, 
(select distinct term
 from ApidbTuning.$$tbl_prefix$$MetaData
 where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC' --$$dataset$$
 and category = 'Household type'
 and source_id != 'EUPATH_0000094') md
 where o.ontology_term_name = md.term),
first as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from leaf where parent_ontology_term_name is not null) par
 where o.ontology_term_name = par.parent_ontology_term_name),
 second as (
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from first where parent_ontology_term_name is not null) gpar
 where o.ontology_term_name = gpar.parent_ontology_term_name)
 select * from leaf
 union
 select * from first
 union
 select * from second
 union
 select o.ontology_term_name, CASE WHEN o.parent_ontology_term_name = 'Thing' THEN null ELSE o.parent_ontology_term_name END as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from second where parent_ontology_term_name is not null) ggpar
 where o.ontology_term_name = ggpar.parent_ontology_term_name
 union
 select 'average anopheles' as ontology_term_name, null as parent_ontology_term_name, 'Average Anopheles Collected' as display_name, 'Average number of Anopheles collected in monthly CDC light traps during the dates of this search' as description, null as units, 'number' as type, 1 as is_range,
 null as precision from dual
      ]]>
      </sql>
      </sqlQuery>

    <sqlQuery name="HouseholdMetaData_prism" >
      <paramRef ref="clinicalVisitParams.participants_prism" />  
      <paramRef ref="clinicalVisitParams.visit_date" /> 
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
with part as ( select distinct io.input_pan_id as household_id, io.output_pan_id as part_id
  from ApidbTuning.$$tbl_prefix$$Participants pa, ApidbTuning.$$tbl_prefix$$PANIO io
   where io.output_pan_id in ($$participants_prism$$)
       and io.input_pan_type_source_id = 'PCO_0000024')
 select distinct Part.part_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, part
 where part.household_id = m.pan_id
 union
 select part.part_id as internal, 'average anopheles' as ontology_term_name, null as string_value, nvl(mos.avg_anoph,0) as number_value, null as date_value
 from (select da.pan_id, round(avg(nvl(EUPATH_0000192,0)+nvl(EUPATH_0000193,0)+nvl(EUPATH_0000204,0)+nvl(EUPATH_0000205,0)),1) as avg_anoph
  from ApidbTuning.$$tbl_prefix$$Households da, ApidbTuning.$$tbl_prefix$$PANIO io, ApidbTuning.$$tbl_prefix$$LightTraps la
  where da.pan_id = io.input_pan_id
  and la.pan_id = io.output_pan_id
  and la.OBI_0001619 >= $$visit_date.min$$ 
  and la.OBI_0001619 <= $$visit_date.max$$ 
  group by da.pan_id) mos, part
  where part.household_id = mos.pan_id(+)
          ]]>
    </sql>    

    </sqlQuery>


    <sqlQuery name="ParticipantMetaData_prism" >
      <paramRef ref="clinicalVisitParams.visits_visitage_metadata_prism" />
      <paramRef ref="clinicalVisitParams.visit_date" /> 
      <paramRef ref="participantParams.duration_observation" />  
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.pan_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
  from (select min(EUPATH_0000113) as min_age, max(EUPATH_0000113) as max_age
   from ApidbTuning.$$tbl_prefix$$Observations 
   where pan_id in ($$visits_visitage_metadata_prism$$)
   ) age,
   ApidbTuning.$$tbl_prefix$$Participants pa, ApidbTuning.$$tbl_prefix$$PANIO iov, ApidbTuning.$$tbl_prefix$$MetaData m
   where least(pa.EUPATH_0000152, $$visit_date.max$$, pa.EUPATH_0000032 + ( age.max_age * 365)) - 
       greatest(pa.EUPATH_0000151, $$visit_date.min$$, pa.EUPATH_0000032 + ( age.min_age * 365)) + 1 >= $$duration_observation$$
       and pa.pan_id = iov.input_pan_id
       and iov.output_pan_id in ($$visits_visitage_metadata_prism$$)
       and pa.pan_id = m.pan_id
          ]]>
    </sql>
    </sqlQuery>
 
    <sqlQuery name="ParticipantMetaDataBkgd_prism">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.pan_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m
 where m.dataset_name = $$dataset$$
 and m.category = 'Child'
          ]]>
    </sql>
    </sqlQuery>

       <sqlQuery name="VisitMetaData_prism" >
         <paramRef ref="clinicalVisitParams.households_prism" />  
         <paramRef ref="clinicalVisitParams.visits_visitage_metadata_prism" />
         <paramRef ref="clinicalVisitParams.visit_date" /> 
         <paramRef ref="participantParams.tbl_prefix" />  
         <column name="ontology_term_name"/>
         <column name="internal"/>
         <column name="number_value"/>
         <column name="date_value"/>
         <column name="string_value"/>
         <sql>
           <![CDATA[
with valid as (
select distinct io.output_pan_id as visit_id, io.input_pan_id as part_id
from ApidbTuning.$$tbl_prefix$$PANIO io, ApidbTuning.$$tbl_prefix$$Observations obs
where io.input_pan_id in ($$households_prism$$)
and io.output_pan_id in ($$visits_visitage_metadata_prism$$)
and obs.pan_id = io.output_pan_id
and obs.EUPATH_0000091 >= $$visit_date.min$$ 
and obs.EUPATH_0000091 <= $$visit_date.max$$ 
)
select distinct valid.visit_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, valid
 where m.pan_id = valid.visit_id
  union
 select valid.visit_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m, valid, ApidbTuning.$$tbl_prefix$$PANIO ios
where m.category = 'Specimen type' 
and m.property = 'Specimen type'
and ios.output_pan_id = m.pan_id
and ios.input_pan_id = valid.visit_id
          ]]>
    </sql>
    </sqlQuery>    

    

    <sqlQuery name="VisitMetaDataBkgd_prism">
         <paramRef ref="participantParams.tbl_prefix" />  
         <column name="ontology_term_name"/>
         <column name="internal"/>
         <column name="number_value"/>
         <column name="date_value"/>
         <column name="string_value"/>
         <sql>
           <![CDATA[
 select distinct pan_id as internal, term as ontology_term_name, string_value, number_value, date_value
 from ApidbTuning.$$tbl_prefix$$MetaData 
 where dataset_name = $$dataset$$
 and category = 'Visit'
 union
 select io.input_pan_id as internal, m.term as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m, ApidbTuning.$$tbl_prefix$$PANIO io
where dataset_name = $$dataset$$
and m.category = 'Specimen type' 
and m.term = 'Specimen type'
and io.output_pan_id = m.pan_id
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="RelVisitMetaData_prism">
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
                select distinct pan_id as internal, term as ontology_term_name,
                       string_value, number_value, date_value
                from ApidbTuning.$$tbl_prefix$$MetaData 
                where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC' --$$dataset$$
                  and category = 'Visit'
              union
                select io.input_pan_id as internal, m.term as ontology_term_name,
                       m.string_value, m.number_value, m.date_value
                from ApidbTuning.$$tbl_prefix$$MetaData m, ApidbTuning.$$tbl_prefix$$PANIO io
                where dataset_name = 'ISASimple_ICEMR_PRISM_surveillance_RSRC' --$$dataset$$
                  and m.category = 'Specimen type' 
                  and m.term = 'Specimen type'
                  and io.output_pan_id = m.pan_id
          ]]>
    </sql>
    </sqlQuery>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!--  MAL-ED specific .. should be injected -->  
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->


   <sqlQuery name="ParticipantMetaData_maled" isCacheable="true">
     <paramRef ref="clinicalVisitParams.geographic_region_maled" />  
     <paramRef ref="participantParams.tbl_prefix" />  
     <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select distinct m.pan_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m
 where m.dataset_name = 'ISASimple_Gates_MAL-ED_stdm_tp_RSRC' --$$dataset$$
 and m.category = 'Participant'
 and m.pan_id in ($$geographic_region_maled$$)
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="ParticipantMetaDataBkgd_maled">
      <paramRef ref="clinicalVisitParams.geographic_region_maled" />  
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct m.pan_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
from ApidbTuning.$$tbl_prefix$$MetaData m
 where m.dataset_name = 'ISASimple_Gates_MAL-ED_stdm_tp_RSRC' --$$dataset$$
 and m.category = 'Participant'
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="VisitMetaData_maled" isCacheable="true">
         <paramRef ref="clinicalVisitParams.households_nf_maled" />  
         <paramRef ref="participantParams.tbl_prefix" />  
         <column name="ontology_term_name"/>
         <column name="internal"/>
         <column name="number_value"/>
         <column name="date_value"/>
         <column name="string_value"/>
         <sql>
           <![CDATA[
select distinct m.pan_id as internal, source_id as ontology_term_name, string_value, number_value, date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m 
 where m.dataset_name = 'ISASimple_Gates_MAL-ED_stdm_tp_RSRC' --$$dataset$$
 and m.category = 'Event'
 and m.pan_id in ($$households_nf_maled$$)
          ]]>
    </sql>
    </sqlQuery>    

    <sqlQuery name="VisitMetaDataBkgd_maled">
      <paramRef ref="clinicalVisitParams.households_nf_maled" />  
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select distinct m.pan_id as internal, source_id as ontology_term_name, string_value, number_value, date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m 
 where m.dataset_name = 'ISASimple_Gates_MAL-ED_stdm_tp_RSRC' --$$dataset$$
 and m.category = 'Event'
          ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="RegionMetaData_maled" >
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
select io.part_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, ( select distinct io.input_pan_id as hh_id, io.output_pan_id as part_id, ioe.output_pan_id as event_id
 from ApidbTuning.$$tbl_prefix$$PANIO io, ApidbTuning.$$tbl_prefix$$PANIO ioe
 where io.input_pan_type_source_id = 'PCO_0000024'
 and io.output_pan_id = ioe.input_pan_id
 and ioe.output_pan_type_source_id = 'EUPATH_0000738') io
 where m.pan_id = io.hh_id
 and m.dataset_name = 'ISASimple_Gates_MAL-ED_stdm_tp_RSRC' --$$dataset$$
 and m.category = 'Household'
 and m.property_source_id in ('EUPATH_0000054','OBI_0001627','EUPATH_0000452')
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="HouseholdMetaData_maled" isCacheable="true">
      <paramRef ref="clinicalVisitParams.participants_nf_maled" />  
      <paramRef ref="participantParams.tbl_prefix" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select io.part_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, ( select distinct io.input_pan_id as hh_id, io.output_pan_id as part_id
 from ApidbTuning.$$tbl_prefix$$PANIO io
 where io.output_pan_id in ($$participants_nf_maled$$)
 and io.input_pan_type_source_id = 'PCO_0000024') io
 where m.pan_id = io.hh_id
 and m.dataset_name = 'ISASimple_Gates_MAL-ED_stdm_tp_RSRC' --$$dataset$$
 and m.category = 'Household'
          ]]>
    </sql>    

    </sqlQuery>

    <sqlQuery name="HouseholdMetaDataBkgd_maled">
      <paramRef ref="participantParams.tbl_prefix" />  
      <paramRef ref="clinicalVisitParams.participants_nf_maled" />  
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
         <![CDATA[
select io.part_id as internal, m.property_source_id as ontology_term_name, m.string_value, m.number_value, m.date_value
 from ApidbTuning.$$tbl_prefix$$MetaData m, ( select distinct io.input_pan_id as hh_id, io.output_pan_id as part_id
 from ApidbTuning.$$tbl_prefix$$PANIO io
 where io.output_pan_type_source_id = 'EUPATH_0000096' 
 and io.input_pan_type_source_id = 'PCO_0000024') io
 where m.pan_id = io.hh_id
 and m.dataset_name = 'ISASimple_Gates_MAL-ED_stdm_tp_RSRC' --$$dataset$$
 and m.category = 'Household'
          ]]>
    </sql>    

    </sqlQuery>

    <sqlQuery name="RelVisitOntology_maled">
     <column name="ontology_term_name"/>
     <column name="parent_ontology_term_name"/>
     <column name="display_name"/>
     <column name="description"/>
     <column name="type"/>
     <column name="units"/>
     <column name="precision"/>
     <column name="is_range"/>
    <sql>
         <![CDATA[
select * from (
with leaf as ( select o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
from ApidbTuning.$$tbl_prefix$$Ontology o, 
(select distinct term
 from ApidbTuning.$$tbl_prefix$$MetaData
 where dataset_name = 'ISASimple_Gates_MAL-ED_stdm_tp_RSRC' --$$dataset$$
 and category = 'Event'
 and source_id != 'EUPATH_0000094') md
 where o.ontology_term_name = md.term),
first as (
 select o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from leaf where parent_ontology_term_name is not null) par
 where o.ontology_term_source_id = par.parent_ontology_term_name),
 second as (
 select o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from first where parent_ontology_term_name is not null) gpar
 where o.ontology_term_source_id = gpar.parent_ontology_term_name)
 select * from leaf
 union
 select * from first
 union
 select * from second
 union
 select o.ontology_term_source_id as ontology_term_name, o.parent_ontology_term_source_id as parent_ontology_term_name, nvl(o.display_name,o.ontology_term_name) as display_name, o.description, o.units,o.type,o.is_range,o.precision
 from ApidbTuning.$$tbl_prefix$$Ontology o, (select distinct parent_ontology_term_name from second where parent_ontology_term_name is not null) ggpar
 where o.ontology_term_source_id = ggpar.parent_ontology_term_name
 ) order by ontology_term_name
         ]]>
    </sql>
   </sqlQuery>

   <sqlQuery name="RelVisitMetaData_maled">
      <column name="ontology_term_name"/>
      <column name="internal"/>
      <column name="number_value"/>
      <column name="date_value"/>
      <column name="string_value"/>
      <sql>
        <![CDATA[
                select distinct pan_id as internal, source_id as ontology_term_name,
                       string_value, number_value, date_value
                from ApidbTuning.$$tbl_prefix$$MetaData 
                where dataset_name = 'ISASimple_Gates_MAL-ED_stdm_tp_RSRC' --$$dataset$$
                and category = 'Event'
          ]]>
    </sql>
    </sqlQuery>
   
  </querySet>    

</wdkModel>
